<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e2f;
      color: white;
      margin: 0;
      padding: 1rem;
      text-align: center;
    }
    .mode-select {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .mode-select button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    .mode-active {
      background: #00cc99;
      color: white;
    }
    .mode-inactive {
      background: #444;
      color: #ccc;
    }
    #recordBtn {
      margin-top: 1rem;
      font-size: 1.2rem;
      padding: 1rem 2rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .table-scroll {
      overflow-x: auto;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      font-size: 0.9rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #333;
      color: #fff;
      z-index: 3;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      white-space: nowrap;
      vertical-align: middle;
      text-align: center;
    }
    tr.active-row {
      background-color: #2a2a4d;
    }

    @media (min-width: 600px) {
      th:first-child, td:first-child {
        position: sticky;
        left: 0;
        min-width: 80px;
        background: #1e1e2f;
        z-index: 4;
      }
      th:nth-child(2), td:nth-child(2) {
        position: sticky;
        left: 80px;
        min-width: 180px;
        background: #1e1e2f;
        z-index: 4;
      }
      th:nth-child(3), td:nth-child(3) {
        position: sticky;
        left: 260px;
        min-width: 100px;
        background: #1e1e2f;
        z-index: 4;
      }
    }

    #backHome {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      text-decoration: none;
      border: 1px solid #ccc;
    }

    #statusListening {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
      color: #00ffcc;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .view-image-btn {
      cursor: pointer;
      background: #0099cc;
      border: none;
      border-radius: 4px;
      color: white;
      font-size: 1.1rem;
      padding: 4px 8px;
      user-select: none;
    }
    .image-row td {
      padding: 10px;
      background: #111122;
      border-top: none;
    }
    .image-preview {
      max-width: 90%;
      max-height: 300px;
      border: 2px solid black;
      margin: 10px auto;
      display: block;
    }
  </style>
</head>
<body>
  <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>

  <div class="mode-select">
    <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
    <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
  </div>

  <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
  <div id="statusListening" style="margin-top:1rem;"></div>
  <div id="result" style="margin-top:1rem;"></div>
  <div class="table-scroll" id="relatedResults"></div>

  <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

<script>
let mode = 'image';
const btnImage = document.getElementById('modeImage');
const btnStatus = document.getElementById('modeStatus');
const recordBtn = document.getElementById("recordBtn");
const resultDiv = document.getElementById("result");
const statusDiv = document.getElementById("statusListening");
let recognition;
let isListening = false;

btnImage.onclick = () => {
  mode = 'image';
  btnImage.classList.add('mode-active');
  btnImage.classList.remove('mode-inactive');
  btnStatus.classList.remove('mode-active');
  btnStatus.classList.add('mode-inactive');
};

btnStatus.onclick = () => {
  mode = 'status';
  btnStatus.classList.add('mode-active');
  btnStatus.classList.remove('mode-inactive');
  btnImage.classList.remove('mode-active');
  btnImage.classList.add('mode-inactive');
};

async function fetchData() {
  const res = await fetch("/api/data");
  return res.json();
}

function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "vi-VN";
  speechSynthesis.speak(utterance);
}

function analyzePart(part) {
  const status = part["Approval Status"]?.toUpperCase() || "";
  const partPic = part["Part Pictures"];
  const packPic = part["Packaging Pictures"];

  if (mode === 'image') {
    if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
    if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
    if (status === "ON GOING") {
      if (!partPic || partPic === '-') return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
      if (!packPic || packPic === '-') return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
      if (partPic === "OK" && packPic === "OK") return "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
    }
  } else {
    const map = {
      "APPROVED": "ƒê√£ ph√™ duy·ªát",
      "CLOSED": "ƒê√£ ƒë√≥ng",
      "EXPIRED": "H·∫øt h·∫°n",
      "ON GOING": "ƒêang th·ª±c hi·ªán",
      "REJECTED": "B·ªã t·ª´ ch·ªëi",
      "SUBMITTED": "ƒê√£ g·ª≠i"
    };
    return map[status] || `Tr·∫°ng th√°i: ${status}`;
  }
  return "Kh√¥ng r√µ tr·∫°ng th√°i.";
}

function makeTableSortable(tableId) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const headers = table.querySelectorAll('th');
  headers.forEach((th, colIndex) => {
    th.style.cursor = 'pointer';
    const arrow = document.createElement('span');
    arrow.style.marginLeft = '6px';
    arrow.style.fontSize = '0.8rem';
    th.appendChild(arrow);

    th.addEventListener('click', () => {
      const rows = Array.from(table.querySelectorAll('tbody > tr:not(.image-row)'));
      const asc = th.dataset.order !== 'asc';
      rows.sort((a, b) => {
        const aText = a.children[colIndex].textContent.trim();
        const bText = b.children[colIndex].textContent.trim();
        return asc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
      });
      rows.forEach(row => table.querySelector('tbody').appendChild(row));
      headers.forEach(h => {
        h.dataset.order = '';
        h.querySelector('span').textContent = '';
      });
      th.dataset.order = asc ? 'asc' : 'desc';
      arrow.textContent = asc ? '‚ñ≤' : '‚ñº';
    });
  });
}

function clearPreviousImageRows(table) {
  const imageRows = table.querySelectorAll('tr.image-row');
  imageRows.forEach(r => r.remove());
}

function showImage(row, url) {
  const table = row.closest('table');
  clearPreviousImageRows(table);

  if (!url) return;

  const imageRow = document.createElement('tr');
  imageRow.classList.add('image-row');

  const td = document.createElement('td');
  td.colSpan = row.children.length;
  td.style.textAlign = 'center';

  const img = document.createElement('img');
  img.className = 'image-preview';
  img.src = url;
  img.alt = "H√¨nh ·∫£nh Part Number";
  img.onerror = () => {
    img.alt = "Kh√¥ng th·ªÉ t·∫£i ·∫£nh";
    img.style.borderColor = "red";
  };

  td.appendChild(img);
  imageRow.appendChild(td);
  row.after(imageRow);
}

recordBtn.addEventListener("click", () => {
  if (isListening) {
    recognition.stop();
    isListening = false;
    statusDiv.textContent = "";
    recordBtn.textContent = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
  } else {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Speech Recognition.");
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'vi-VN';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      statusDiv.textContent = "ƒêang nghe...";
      recordBtn.textContent = "‚èπÔ∏è D·ª´ng l·∫°i";
    };
    recognition.onend = () => {
      isListening = false;
      statusDiv.textContent = "";
      recordBtn.textContent = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
    };
    recognition.onerror = (event) => {
      statusDiv.textContent = "L·ªói: " + event.error;
      isListening = false;
      recordBtn.textContent = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
    };
    recognition.onresult = async (event) => {
      let text = event.results[0][0].transcript.trim();
      resultDiv.textContent = `B·∫°n n√≥i: ${text}`;
      if (!text) return;

      const data = await fetchData();
      // T√¨m theo Part Number ho·∫∑c Description ch·ª©a text
      const filtered = data.filter(item => 
        (item["Part Number"] && item["Part Number"].toLowerCase().includes(text.toLowerCase())) ||
        (item["Description"] && item["Description"].toLowerCase().includes(text.toLowerCase()))
      );
      if (filtered.length === 0) {
        resultDiv.textContent += "\nKh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.";
        speak("Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p.");
        document.getElementById("relatedResults").innerHTML = "";
        return;
      }

      // T·∫°o b·∫£ng
      let html = `<table id="resultsTable"><thead><tr>
        <th>STT</th>
        <th>Part Number</th>
        <th>M√¥ t·∫£</th>
        <th>Approval Status</th>
        <th>Part Pictures</th>
        <th>Packaging Pictures</th>
        <th>H√†nh ƒë·ªông</th>
      </tr></thead><tbody>`;

      filtered.forEach((item, i) => {
        html += `<tr data-index="${i}">
          <td>${i + 1}</td>
          <td>${item["Part Number"] || ""}</td>
          <td>${item["Description"] || ""}</td>
          <td>${item["Approval Status"] || ""}</td>
          <td>${item["Part Pictures"] || ""}</td>
          <td>${item["Packaging Pictures"] || ""}</td>
          <td>
            <button class="view-image-btn" title="Xem ·∫£nh s·∫£n ph·∫©m">üñºÔ∏è</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      document.getElementById("relatedResults").innerHTML = html;

      makeTableSortable("resultsTable");

      speak(analyzePart(filtered[0]));

      // G·∫Øn s·ª± ki·ªán cho n√∫t xem ·∫£nh
      const table = document.getElementById("resultsTable");
      table.querySelectorAll(".view-image-btn").forEach((btn, idx) => {
        btn.onclick = () => {
          const part = filtered[idx];
          // ∆Ø·ªõc l∆∞·ª£ng URL ·∫£nh, v√≠ d·ª•:
          const baseUrl = "https://example.com/images/";
          const picName = part["Part Pictures"] && part["Part Pictures"] !== '-' ? part["Part Pictures"] : null;
          const packName = part["Packaging Pictures"] && part["Packaging Pictures"] !== '-' ? part["Packaging Pictures"] : null;

          // M·ªü ch·ªçn ·∫£nh Part Pictures n·∫øu c√≥, n·∫øu kh√¥ng th√¨ Packaging Pictures, n·∫øu kh√¥ng th√¨ b√°o kh√¥ng c√≥ ·∫£nh
          let imgUrl = null;
          if (picName) {
            imgUrl = baseUrl + encodeURIComponent(picName);
          } else if (packName) {
            imgUrl = baseUrl + encodeURIComponent(packName);
          }

          const tr = btn.closest("tr");
          showImage(tr, imgUrl);
        };
      });
    };

    recognition.start();
  }
});
</script>
</body>
</html>
