<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
  <style>
    :root {
      --primary-color: #00cc99;
      --secondary-color: #4CAF50;
      --dark-bg: #1e1e2f;
      --light-text: #fff;
      --gray-text: #ccc;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark-bg);
      color: var(--light-text);
      margin: 0;
      padding: 1.5rem;
      text-align: center;
      line-height: 1.6;
    }

    .mode-select {
      margin: 2rem 0;
    }

    .mode-btn {
      padding: 0.8rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .mode-active {
      background: var(--primary-color);
      color: var(--light-text);
      box-shadow: 0 2px 8px rgba(0, 204, 153, 0.2);
    }

    .mode-inactive {
      background: #444;
      color: var(--gray-text);
    }

    #recordBtn {
      margin: 2rem 0;
      font-size: 1.2rem;
      padding: 1.2rem 2.5rem;
      background: var(--secondary-color);
      color: var(--light-text);
      border: none;
      border-radius: 10px;
      transition: transform 0.2s ease;
    }

    #recordBtn:hover {
      transform: scale(1.05);
    }

    .status-listening {
      margin: 1.5rem 0;
      font-size: 1.3rem;
      color: #00ffcc;
      animation: pulse 1.5s infinite;
    }

    .table-scroll {
      overflow-x: auto;
      margin: 2rem 0;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
      font-size: 0.95rem;
    }

    th, td {
      padding: 10px 12px;
      border: 1px solid #444;
      text-align: left;
    }

    th {
      background: #333;
      position: sticky;
      top: 0;
      z-index: 2;
    }

    tr.active-row {
      background-color: #2a2a4d;
    }

    .image-preview {
      max-height: 80px;
      border: 1px solid #666;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .image-preview:hover {
      transform: scale(1.1);
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
      padding: 8px 12px;
      background: #333;
      border-radius: 6px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.05); opacity: 0.8; }
    }

    @media (max-width: 600px) {
      body { padding: 1rem; }
      .mode-select { flex-direction: column; align-items: center; gap: 1rem; }
    }
  </style>
</head>
<body>
  <header>
    <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>
  </header>

  <div class="mode-select">
    <button id="modeImage" class="mode-btn mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
    <button id="modeStatus" class="mode-btn mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
  </div>

  <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
  <div id="statusListening" class="status-listening"></div>
  <div id="result"></div>
  <div class="table-scroll" id="relatedResults"></div>

  <a href="/home" id="backHome" class="back-btn">‚Üê Trang ch·ªß</a>

  <script>
    let mode = 'image';
    const modeBtns = document.querySelectorAll('.mode-btn');
    const recordBtn = document.getElementById('recordBtn');
    const statusDiv = document.getElementById('statusListening');
    let recognition;
    let isListening = false;

    // Mode selection
    function setMode(newMode) {
      mode = newMode;
      modeBtns.forEach(btn => {
        btn.classList.toggle('mode-active', btn.id === `mode${newMode[0].toUpperCase()}${newMode.slice(1)}`);
        btn.classList.toggle('mode-inactive', !btn.classList.contains('mode-active'));
      });
    }

    // Speech synthesis
    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'vi-VN';
      utterance.rate = 1.1;
      speechSynthesis.speak(utterance);
    }

    // Data processing
    function analyzePart(part) {
      const status = part['Approval Status']?.toUpperCase() || '';
      const statusMap = {
        APPROVED: 'ƒê√£ ph√™ duy·ªát',
        CLOSED: 'ƒê√£ ƒë√≥ng',
        EXPIRED: 'H·∫øt h·∫°n',
        ON_GOING: 'ƒêang th·ª±c hi·ªán',
        REJECTED: 'B·ªã t·ª´ ch·ªëi',
        SUBMITTED: 'ƒê√£ g·ª≠i'
      };

      if (mode === 'image') {
        if (['REJECTED', 'EXPIRED'].includes(status)) return 'Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.';
        if (['APPROVED', 'CLOSED', 'SUBMITTED'].includes(status)) return 'Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.';
        if (status === 'ON GOING') {
          const needsPartPic = !part['Part Pictures'] || part['Part Pictures'] === '-';
          const needsPackPic = !part['Packaging Pictures'] || part['Packaging Pictures'] === '-';
          return needsPartPic ? 'C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.' : needsPackPic ? 'C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.' : 'Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.';
        }
      } else {
        return statusMap[status] || `Tr·∫°ng th√°i kh√¥ng r√µ: ${status}`;
      }
      return 'Tr·∫°ng th√°i kh√¥ng x√°c ƒë·ªãnh.';
    }

    // Table management
    function createSortableTable(data, isSingleResult = false) {
      const table = document.createElement('table');
      table.id = 'resultsTable';
      table.innerHTML = `
        <thead>
          <tr>
            <th>No.</th>
            <th>Part Number</th>
            <th>REV</th>
            <th>Approval Status</th>
            <th>Customer</th>
            <th>Commodity</th>
            <th>Part Pictures</th>
            <th>Packaging Pictures</th>
            <th>Critical</th>
            <th>CE</th>
            <th>Xem ·∫£nh</th>
          </tr>
        </thead>
        <tbody>${data.map((item, index) => `
          <tr data-part="${item['Part Number']}" onclick="highlightRow(this)">
            <td>${index + 1}</td>
            <td>${item['Part Number'] || '-'}</td>
            <td>${item['REV'] || '-'}</td>
            <td>${item['Approval Status'] || '-'}</td>
            <td>${item['Customer'] || '-'}</td>
            <td>${item['Commodity'] || '-'}</td>
            <td>${item['Part Pictures'] || '-'}</td>
            <td>${item['Packaging Pictures'] || '-'}</td>
            <td>${item['Critical'] || '-'}</td>
            <td>${item['CE'] || '-'}</td>
            <td>
              <img class="image-preview" 
                   src="${item['ERP-CODE'] ? `https://res.cloudinary.com/dyjcw9mlz/image/upload/ERP-CODE/${item['ERP-CODE'].toUpperCase()}.jpg` : '#no-photo'}"
                   onerror="this.src='data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='; this.alt='No photo';">
            </td>
          </tr>
        `).join('')}</tbody>
      `;

      // Sorting functionality
      const headers = table.querySelectorAll('th');
      headers.forEach((th, colIndex) => {
        th.addEventListener('click', () => sortTable(table, colIndex));
      });

      return table;
    }

    function sortTable(table, colIndex) {
      const rows = Array.from(table.querySelectorAll('tbody tr'));
      const isAsc = !rows[0].hasAttribute('data-sort-order') || rows[0].getAttribute('data-sort-order') === 'desc';
      
      rows.sort((a, b) => {
        const aVal = a.children[colIndex].textContent.trim();
        const bVal = b.children[colIndex].textContent.trim();
        return isAsc ? aVal.localeCompare(bVal, 'vi', { numeric: true }) : bVal.localeCompare(aVal, 'vi', { numeric: true });
      });

      rows.forEach(row => {
        row.removeAttribute('data-sort-order');
        table.querySelector('tbody').appendChild(row);
      });
      rows[0].setAttribute('data-sort-order', isAsc ? 'asc' : 'desc');
    }

    // History management
    function saveToHistory(partNumber) {
      const history = JSON.parse(localStorage.getItem('searchHistory')) || [];
      history.unshift({ partNumber, time: new Date().toLocaleString('vi-VN') });
      localStorage.setItem('searchHistory', JSON.stringify(history.slice(0, 20)));
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      const history = JSON.parse(localStorage.getItem('searchHistory')) || [];
      
      historyList.innerHTML = history.map(item => `
        <div class="history-item">
          <button 
            onclick="processTranscript('${item.partNumber}', true); navigator.clipboard.writeText('${item.partNumber}')"
            title="Tra c·ª©u v√† sao ch√©p Part Number">
            ${item.partNumber}
          </button>
          <small>${item.time}</small>
        </div>
      `).join('');
    }

    // Speech recognition
    function startRecognition() {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'vi-VN';
      recognition.interimResults = false; // Only final results

      recognition.onstart = () => {
        isListening = true;
        recordBtn.textContent = 'üõë D·ª´ng nghe';
        statusDiv.textContent = 'üéß ƒêang nh·∫≠n di·ªán gi·ªçng n√≥i...';
        resultDiv.innerHTML = '';
        relatedResults.innerHTML = '';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.trim();
        processTranscript(transcript);
      };

      recognition.onerror = (e) => {
        statusDiv.textContent = `L·ªói: ${e.error}`;
        speak('ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh nh·∫≠n di·ªán gi·ªçng n√≥i');
      };

      recognition.onend = () => {
        isListening = false;
        recordBtn.textContent = 'üéôÔ∏è B·∫Øt ƒë·∫ßu nghe';
        statusDiv.textContent = '';
      };

      recognition.start();
    }

    // Main processing
    async function processTranscript(transcript) {
      if (!transcript) return;
      
      const cleaned = transcript.replace(/\s+/g, '').toUpperCase();
      saveToHistory(cleaned);
      renderHistory();

      resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
      
      try {
        const data = await fetch('/api/data').then(res => res.json());
        const results = data.filter(row => 
          row['Part Number']?.toUpperCase().includes(cleaned) && 
          typeof row['Part Number'] === 'string'
        );

        if (results.length === 0) {
          showResult('Kh√¥ng t√¨m th·∫•y Part Number', false);
          speak('Kh√¥ng t√¨m th·∫•y Part Number trong c∆° s·ªü d·ªØ li·ªáu');
        } else {
          const msg = analyzePart(results[0]);
          showResult(msg, true, results);
          speak(msg);
        }
      } catch (error) {
        showResult('L·ªói truy v·∫•n d·ªØ li·ªáu', false);
        console.error('L·ªói:', error);
      }
    }

    function showResult(message, hasTable, data = []) {
      resultDiv.innerHTML += `<br/>${hasTable ? '‚úÖ' : '‚ùå'} ${message}`;
      
      if (hasTable) {
        const table = createSortableTable(data.slice(0, 10), data.length === 1);
        relatedResults.innerHTML = '';
        relatedResults.appendChild(table);
      }
    }

    // Click handlers
    modeBtns.forEach(btn => {
      btn.addEventListener('click', () => setMode(btn.id.split('mode')[1].toLowerCase()));
    });

    recordBtn.addEventListener('click', () => {
      if (isListening) {
        recognition.stop();
      } else {
        startRecognition();
      }
    });

    // Row highlighting
    function highlightRow(row) {
      document.querySelectorAll('tbody tr').forEach(r => r.classList.remove('active-row'));
      row.classList.add('active-row');
      speak(analyzePart(row.dataset));
    }

    window.onload = renderHistory;
  </script>

  <hr style="border-top: 1px solid #444;">
  <h3>üìú L·ªãch s·ª≠ t√¨m ki·∫øm g·∫ßn ƒë√¢y</h3>
  <ul id="historyList"></ul>
  <button onclick="clearHistory()" class="clear-btn">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>

  <script>
    function clearHistory() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ tra c·ª©u?')) {
        localStorage.removeItem('searchHistory');
        renderHistory();
      }
    }
  </script>
</body>
</html>
