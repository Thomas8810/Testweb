<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
  <style>
    body { font-family: sans-serif; background: #1e1e2f; color: white; margin: 0; padding: 1rem; text-align: center; }
    .mode-select { display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem; }
    .mode-select button { padding: 0.5rem 1rem; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; }
    .mode-active { background: #00cc99; color: white; }
    .mode-inactive { background: #444; color: #ccc; }
    #recordBtn { margin-top: 1rem; font-size: 1.2rem; padding: 1rem 2rem; background: #4CAF50; color: white; border-radius: 8px; cursor: pointer; }
    .table-scroll { overflow-x: auto; margin-top: 1rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    thead th { position: sticky; top: 0; background: #333; color: #fff; z-index: 3; }
    th, td { border: 1px solid #ccc; padding: 6px; white-space: nowrap; }
    tr.active-row { background-color: #2a2a4d; }
    @media (min-width: 600px) { th, td { position: sticky; left: 0; min-width: 80px; background: #1e1e2f; z-index: 4; } }
    #backHome { position: fixed; bottom: 10px; right: 10px; background: rgba(255,255,255,0.1); color: white; padding: 10px 16px; border-radius: 20px; text-decoration: none; border: 1px solid #ccc; }
    #statusListening { margin-top: 1rem; font-size: 1.2rem; font-weight: bold; color: #00ffcc; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>
  <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>
  <div class="mode-select">
    <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
    <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
  </div>
  <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
  <div id="statusListening"></div>
  <div id="result"></div>
  <div class="table-scroll" id="relatedResults"></div>
  <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

  <script>
    let mode = 'image', recognition, isListening = false;
    const btnImage = document.getElementById('modeImage'), btnStatus = document.getElementById('modeStatus');
    const recordBtn = document.getElementById("recordBtn"), resultDiv = document.getElementById("result");
    const statusDiv = document.getElementById("statusListening");

    btnImage.onclick = () => setMode('image');
    btnStatus.onclick = () => setMode('status');

    function setMode(newMode) {
      mode = newMode;
      btnImage.classList.toggle('mode-active', mode === 'image');
      btnStatus.classList.toggle('mode-active', mode === 'status');
    }

    async function fetchData() { return (await fetch("/api/data")).json(); }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "vi-VN";
      speechSynthesis.speak(utterance);
    }

    function analyzePart(part) {
      const status = part["Approval Status"]?.toUpperCase() || "";
      const partPic = part["Part Pictures"], packPic = part["Packaging Pictures"];
      if (mode === 'image') {
        if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
        if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
        if (status === "ON GOING") {
          if (!partPic || partPic === '-') return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
          if (!packPic || packPic === '-') return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
          return partPic === "OK" && packPic === "OK" ? "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh." : "C·∫ßn ch·ª•p ·∫£nh.";
        }
      } else {
        return { "APPROVED": "ƒê√£ ph√™ duy·ªát", "CLOSED": "ƒê√£ ƒë√≥ng", "EXPIRED": "H·∫øt h·∫°n", "ON GOING": "ƒêang th·ª±c hi·ªán", "REJECTED": "B·ªã t·ª´ ch·ªëi", "SUBMITTED": "ƒê√£ g·ª≠i" }[status] || `Tr·∫°ng th√°i: ${status}`;
      }
      return "Kh√¥ng r√µ tr·∫°ng th√°i.";
    }

    function makeTableSortable(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return;
      const headers = table.querySelectorAll('th');
      headers.forEach((th, colIndex) => {
        th.style.cursor = 'pointer';
        const arrow = document.createElement('span');
        arrow.style.marginLeft = '6px';
        arrow.style.fontSize = '0.8rem';
        th.appendChild(arrow);

        th.onclick = () => {
          const rows = Array.from(table.querySelectorAll('tbody > tr'));
          const asc = th.dataset.order !== 'asc';
          rows.sort((a, b) => {
            const aText = a.children[colIndex].textContent.trim(), bText = b.children[colIndex].textContent.trim();
            return asc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
          });
          rows.forEach(row => table.querySelector('tbody').appendChild(row));
          headers.forEach(h => { h.dataset.order = ''; h.querySelector('span').textContent = ''; });
          th.dataset.order = asc ? 'asc' : 'desc';
          arrow.textContent = asc ? '‚ñ≤' : '‚ñº';
        };
      });
    }

    async function processTranscript(transcript, fromHistory = false) {
      const cleaned = transcript.replace(/\s+/g, '').toUpperCase();
      if (!fromHistory) saveToHistory(cleaned);
      resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
      const data = await fetchData();
      const results = data.filter(row => row["Part Number"]?.toUpperCase().includes(cleaned));
      
      if (results.length === 0) {
        statusDiv.innerText = "";
        speak("Kh√¥ng t√¨m th·∫•y Part Number.");
        resultDiv.innerHTML += `<br>‚ùå Kh√¥ng t√¨m th·∫•y Part Number.`;
      } else {
        const tableHtml = results.length === 1 ? analyzePart(results[0]) : `
          <table id="resultTable">
            <thead><tr><th>Part Number</th><th>Part Name</th><th>Xem ·∫£nh</th></tr></thead>
            <tbody>${results.map(item => `<tr class="active-row"><td>${item["Part Number"]}</td><td>${item["Part Name"]}</td><td><img src="${item["Part Pictures"]}" width="120" height="80" alt="Part Image"></td></tr>`).join('')}</tbody>
          </table>`;
        resultDiv.innerHTML += `<br>‚úÖ T√¨m th·∫•y ${results.length} k·∫øt qu·∫£:`;
        document.getElementById("relatedResults").innerHTML = tableHtml;
        makeTableSortable("resultTable");
      }
    }

    async function startListening() {
      if (isListening) return;
      isListening = true;
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "vi-VN";
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.onstart = () => { statusDiv.innerText = "ƒêang nghe... üéôÔ∏è"; speak("ƒêang nghe..."); };
      recognition.onend = () => { statusDiv.innerText = "Ng·ª´ng nghe."; speak("Ng·ª´ng nghe."); isListening = false; };
      recognition.onresult = (event) => processTranscript(event.results[event.resultIndex][0].transcript);
      recognition.start();
    }

    recordBtn.onclick = () => { isListening ? recognition.stop() : startListening(); };
  </script>
</body>
</html>
