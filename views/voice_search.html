<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e2f;
      color: white;
      margin: 0;
      padding: 1rem;
      text-align: center;
    }
    .mode-select {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .mode-select button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    .mode-active { background: #00cc99; color: white; }
    .mode-inactive { background: #444; color: #ccc; }

    #recordBtn {
      margin-top: 1rem;
      font-size: 1.2rem;
      padding: 1rem 2rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #statusListening {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
      color: #00ffcc;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }

    .table-scroll { overflow-x: auto; margin-top: 1rem; }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      font-size: 0.9rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #333;
      color: #fff;
      z-index: 3;
      cursor: pointer;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      white-space: nowrap;
    }
    tr.active-row { background-color: #2a2a4d; }

    @media (min-width: 600px) {
      th:first-child, td:first-child {
        position: sticky; left: 0; background: #1e1e2f; z-index: 4;
      }
      th:nth-child(2), td:nth-child(2) {
        position: sticky; left: 80px; background: #1e1e2f; z-index: 4;
      }
      th:nth-child(3), td:nth-child(3) {
        position: sticky; left: 260px; background: #1e1e2f; z-index: 4;
      }
    }

    #backHome {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      text-decoration: none;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>
  <div class="mode-select">
    <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
    <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
  </div>

  <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
  <div id="statusListening"></div>
  <div id="result"></div>
  <div class="table-scroll" id="relatedResults"></div>
  <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

  <hr style="margin-top:2rem; border:none; border-top:1px solid #666;">
  <h3>üìú L·ªãch s·ª≠ t√¨m ki·∫øm g·∫ßn ƒë√¢y</h3>
  <ul id="historyList" style="list-style:none; padding:0; text-align:left;"></ul>
  <button onclick="clearHistory()" style="margin-top:0.5rem; background:#cc4444; color:white; padding:8px 16px; border:none; border-radius:6px; cursor:pointer;">
    üóëÔ∏è X√≥a l·ªãch s·ª≠
  </button>

  <script>
let mode = 'image';
let recognition;
let isListening = false;

const DOM = {
  btnImage: document.getElementById('modeImage'),
  btnStatus: document.getElementById('modeStatus'),
  recordBtn: document.getElementById("recordBtn"),
  resultDiv: document.getElementById("result"),
  statusDiv: document.getElementById("statusListening"),
  relatedResults: document.getElementById("relatedResults"),
  historyList: document.getElementById("historyList"),
};

DOM.btnImage.onclick = () => toggleMode('image');
DOM.btnStatus.onclick = () => toggleMode('status');
DOM.recordBtn.onclick = () => isListening ? stopRecognition() : startRecognition();

function toggleMode(newMode) {
  mode = newMode;
  [DOM.btnImage, DOM.btnStatus].forEach(btn => btn.classList.remove('mode-active', 'mode-inactive'));
  if (newMode === 'image') {
    DOM.btnImage.classList.add('mode-active');
    DOM.btnStatus.classList.add('mode-inactive');
  } else {
    DOM.btnStatus.classList.add('mode-active');
    DOM.btnImage.classList.add('mode-inactive');
  }
}

function speak(text) {
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "vi-VN";
  speechSynthesis.speak(utterance);
}

function cleanTranscript(text) {
  return text.replace(/\s+/g, '').replace(/[^A-Z0-9]/gi, '').toUpperCase();
}

async function fetchData() {
  const res = await fetch("/api/data");
  return res.json();
}

function analyzePart(part) {
  const status = part["Approval Status"]?.toUpperCase() || "";
  const partPic = part["Part Pictures"];
  const packPic = part["Packaging Pictures"];

  if (mode === 'image') {
    if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
    if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
    if (status === "ON GOING") {
      if (!partPic || partPic === '-') return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
      if (!packPic || packPic === '-') return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
      if (partPic === "OK" && packPic === "OK") return "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
    }
  } else {
    const map = {
      "APPROVED": "ƒê√£ ph√™ duy·ªát",
      "CLOSED": "ƒê√£ ƒë√≥ng",
      "EXPIRED": "H·∫øt h·∫°n",
      "ON GOING": "ƒêang th·ª±c hi·ªán",
      "REJECTED": "B·ªã t·ª´ ch·ªëi",
      "SUBMITTED": "ƒê√£ g·ª≠i"
    };
    return map[status] || `Tr·∫°ng th√°i: ${status}`;
  }
  return "Kh√¥ng r√µ tr·∫°ng th√°i.";
}

async function processTranscript(transcript, fromHistory = false) {
  const cleaned = cleanTranscript(transcript);
  if (!fromHistory) saveToHistory(cleaned);

  DOM.resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
  const data = await fetchData();
  const results = data.filter(row => row["Part Number"]?.toUpperCase().includes(cleaned));

  DOM.statusDiv.innerText = "";

  if (results.length === 0) {
    speak("Kh√¥ng t√¨m th·∫•y Part Number.");
    DOM.resultDiv.innerHTML += `<br>‚ùå Kh√¥ng t√¨m th·∫•y Part Number.`;
    DOM.relatedResults.innerHTML = "";
    return;
  }

  const html = renderResultsTable(results);
  DOM.relatedResults.innerHTML = html;
  makeTableSortable('resultsTable');

  const msg = results.length === 1 ? analyzePart(results[0]) : `T√¨m th·∫•y ${results.length} k·∫øt qu·∫£ g·∫ßn gi·ªëng.`;
  DOM.resultDiv.innerHTML += `<br/>‚úÖ ${msg}`;
  speak(msg);
}

function renderResultsTable(results) {
  let html = `<table id="resultsTable"><thead><tr>
    <th>No.</th><th>Part Number</th><th>REV</th><th>Approval Status</th><th>Customer</th>
    <th>Commodity</th><th>Part Pictures</th><th>Packaging Pictures</th><th>Critical</th>
    <th>CE</th><th>·∫¢nh</th>
  </tr></thead><tbody>`;

  results.slice(0, 10).forEach((item, index) => {
    const erp = item["ERP-CODE"]?.toUpperCase() || "";
    const msg = analyzePart(item);
    html += `<tr onclick="speak('${msg}')">
      <td>${index + 1}</td>
      <td>${item["Part Number"]}</td>
      <td>${item["REV"]}</td>
      <td>${item["Approval Status"]}</td>
      <td>${item["Customer"]}</td>
      <td>${item["Commodity"]}</td>
      <td>${item["Part Pictures"]}</td>
      <td>${item["Packaging Pictures"]}</td>
      <td>${item["Critical"]}</td>
      <td>${item["CE"]}</td>
      <td><button onclick="event.stopPropagation(); showImage('${erp}', this)">üì∑</button></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  return html;
}

function showImage(erpCode, button) {
  const rowId = `row-${erpCode}`;
  document.querySelectorAll('.image-row').forEach(row => row.remove());

  const img = document.createElement('img');
  img.src = `https://res.cloudinary.com/dyjcw9mlz/image/upload/ERP-CODE/${erpCode}.jpg`;
  img.style.maxWidth = '90%';
  img.style.maxHeight = '300px';
  img.style.border = '2px solid black';
  img.loading = 'lazy';
  img.onerror = () => img.replaceWith(document.createTextNode('·∫¢nh kh√¥ng t·ªìn t·∫°i'));

  const tr = document.createElement('tr');
  tr.className = 'image-row';

  const td = document.createElement('td');
  td.colSpan = 30;
  td.style.textAlign = 'center';
  td.appendChild(img);
  tr.appendChild(td);

  button.closest('tr').after(tr);
}

function makeTableSortable(id) {
  const table = document.getElementById(id);
  const headers = table.querySelectorAll('th');
  headers.forEach((th, i) => {
    const arrow = document.createElement('span');
    arrow.style.marginLeft = '6px';
    th.appendChild(arrow);

    th.addEventListener('click', () => {
      const rows = Array.from(table.querySelectorAll('tbody > tr:not(.image-row)'));
      const asc = th.dataset.order !== 'asc';
      rows.sort((a, b) => {
        const aText = a.children[i].textContent.trim();
        const bText = b.children[i].textContent.trim();
        return asc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
      });

      rows.forEach(row => table.querySelector('tbody').appendChild(row));
      headers.forEach(h => (h.dataset.order = '', h.querySelector('span').textContent = ''));
      th.dataset.order = asc ? 'asc' : 'desc';
      arrow.textContent = asc ? '‚ñ≤' : '‚ñº';
    });
  });
}

function startRecognition() {
  recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = "vi-VN";
  recognition.interimResults = true;

  recognition.onstart = () => {
    isListening = true;
    DOM.recordBtn.innerText = "üõë Nh·∫•n ƒë·ªÉ d·ª´ng";
    DOM.statusDiv.innerText = "üéß ƒêang nghe...";
    DOM.resultDiv.innerHTML = "";
    DOM.relatedResults.innerHTML = "";
  };

  recognition.onresult = (event) => {
    let finalTranscript = "";
    for (let i = event.resultIndex; i < event.results.length; ++i)
      if (event.results[i].isFinal)
        finalTranscript += event.results[i][0].transcript;
    if (finalTranscript) processTranscript(finalTranscript);
  };

  recognition.onerror = (e) => {
    DOM.statusDiv.innerText = "";
    DOM.recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
    DOM.resultDiv.innerHTML = `‚ùå L·ªói: ${e.error}`;
    speak("ƒê√£ x·∫£y ra l·ªói nh·∫≠n di·ªán gi·ªçng n√≥i.");
    isListening = false;
  };

  recognition.onend = () => {
    isListening = false;
    DOM.statusDiv.innerText = "";
    DOM.recordBtn.innerText = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
  };

  recognition.start();
}

function stopRecognition() {
  recognition?.stop();
}

function saveToHistory(query) {
  let history = JSON.parse(localStorage.getItem("history")) || [];
  if (!history.includes(query)) {
    history.unshift(query);
    if (history.length > 10) history = history.slice(0, 10);
    localStorage.setItem("history", JSON.stringify(history));
  }
  renderHistory();
}

function renderHistory() {
  const history = JSON.parse(localStorage.getItem("history")) || [];
  DOM.historyList.innerHTML = "";
  history.forEach(query => {
    const li = document.createElement("li");
    li.textContent = query;
    li.onclick = () => processTranscript(query, true);
    DOM.historyList.appendChild(li);
  });
}

renderHistory();

  </script>
</body>
</html>
