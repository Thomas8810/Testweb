<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</title>
  <style>
    body {
      font-family: sans-serif;
      background: #1e1e2f;
      color: white;
      margin: 0;
      padding: 1rem;
      text-align: center;
    }
    .mode-select {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .mode-select button {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    .mode-active {
      background: #00cc99;
      color: white;
    }
    .mode-inactive {
      background: #444;
      color: #ccc;
    }
    #recordBtn {
      margin-top: 1rem;
      font-size: 1.2rem;
      padding: 1rem 2rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .table-scroll {
      overflow-x: auto;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
      font-size: 0.9rem;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #333;
      color: #fff;
      z-index: 3;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      white-space: nowrap;
    }
    tr.active-row {
      background-color: #2a2a4d;
    }

    /* Sticky first 3 columns on wider screens */
    @media (min-width: 600px) {
      th:first-child, td:first-child {
        position: sticky;
        left: 0;
        min-width: 80px;
        background: #1e1e2f;
        z-index: 4;
      }
      th:nth-child(2), td:nth-child(2) {
        position: sticky;
        left: 80px;
        min-width: 180px;
        background: #1e1e2f;
        z-index: 4;
      }
      th:nth-child(3), td:nth-child(3) {
        position: sticky;
        left: 260px;
        min-width: 100px;
        background: #1e1e2f;
        z-index: 4;
      }
    }

    #backHome {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: rgba(255,255,255,0.1);
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      text-decoration: none;
      border: 1px solid #ccc;
    }
      
    #statusListening {
      margin-top: 1rem;
      font-size: 1.2rem;
      font-weight: bold;
      color: #00ffcc;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.1); }
      100% { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>
  <h2>üé§ Tra c·ª©u Part Number b·∫±ng gi·ªçng n√≥i</h2>

  <div class="mode-select">
    <button id="modeImage" class="mode-active">üñºÔ∏è Ki·ªÉm tra ·∫£nh</button>
    <button id="modeStatus" class="mode-inactive">üìÑ Ki·ªÉm tra tr·∫°ng th√°i</button>
  </div>

  <button id="recordBtn">üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu</button>
  <div id="statusListening"></div>
  <div id="result" style="margin-top:1rem;"></div>
  <div class="table-scroll" id="relatedResults"></div>

  <a href="/home" id="backHome">‚Üê Trang ch·ªß</a>

<script>
  // Chuy·ªÉn ƒë·ªïi ch·∫ø ƒë·ªô Image / Status
  let mode = 'image';
  const btnImage = document.getElementById('modeImage');
  const btnStatus = document.getElementById('modeStatus');
  const recordBtn = document.getElementById("recordBtn");
  const resultDiv = document.getElementById("result");
  const statusDiv = document.getElementById("statusListening");
  let recognition;
  let isListening = false;

  btnImage.onclick = () => {
    mode = 'image';
    btnImage.classList.add('mode-active');
    btnImage.classList.remove('mode-inactive');
    btnStatus.classList.remove('mode-active');
    btnStatus.classList.add('mode-inactive');
  };

  btnStatus.onclick = () => {
    mode = 'status';
    btnStatus.classList.add('mode-active');
    btnStatus.classList.remove('mode-inactive');
    btnImage.classList.remove('mode-active');
    btnImage.classList.add('mode-inactive');
  };

  // L·∫•y d·ªØ li·ªáu t·ª´ API (gi·∫£ ƒë·ªãnh API tr·∫£ v·ªÅ m·∫£ng JSON)
  async function fetchData() {
    const res = await fetch("/api/data");
    return res.json();
  }

  // ƒê·ªçc b·∫±ng gi·ªçng n√≥i
  function speak(text) {
    if (!text) return;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "vi-VN";
    speechSynthesis.speak(utterance);
  }

  // Ph√¢n t√≠ch Part Number theo tr·∫°ng th√°i v√† mode
  function analyzePart(part) {
    const status = (part["Approval Status"] || "").toUpperCase();
    const partPic = part["Part Pictures"];
    const packPic = part["Packaging Pictures"];

    if (mode === 'image') {
      if (["REJECTED", "EXPIRED"].includes(status)) return "Part n√†y c·∫ßn h·ªèi l·∫°i qu·∫£n l√Ω.";
      if (["APPROVED", "CLOSED", "SUBMITTED"].includes(status)) return "Part n√†y kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
      if (status === "ON GOING") {
        if (!partPic || partPic === '-') return "C·∫ßn ch·ª•p ·∫£nh s·∫£n ph·∫©m.";
        if (!packPic || packPic === '-') return "C·∫ßn ch·ª•p ·∫£nh ƒë√≥ng g√≥i.";
        if (partPic === "OK" && packPic === "OK") return "Kh√¥ng c·∫ßn ch·ª•p ·∫£nh.";
      }
    } else {
      const map = {
        "APPROVED": "ƒê√£ ph√™ duy·ªát",
        "CLOSED": "ƒê√£ ƒë√≥ng",
        "EXPIRED": "H·∫øt h·∫°n",
        "ON GOING": "ƒêang th·ª±c hi·ªán",
        "REJECTED": "B·ªã t·ª´ ch·ªëi",
        "SUBMITTED": "ƒê√£ g·ª≠i"
      };
      return map[status] || `Tr·∫°ng th√°i: ${status}`;
    }
    return "Kh√¥ng r√µ tr·∫°ng th√°i.";
  }

  // T·∫°o b·∫£ng c√≥ th·ªÉ s·∫Øp x·∫øp theo c·ªôt
  function makeTableSortable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const headers = table.querySelectorAll('th');
    headers.forEach((th, colIndex) => {
      th.style.cursor = 'pointer';
      const arrow = document.createElement('span');
      arrow.style.marginLeft = '6px';
      arrow.style.fontSize = '0.8rem';
      th.appendChild(arrow);

      th.addEventListener('click', () => {
        const rows = Array.from(table.querySelectorAll('tbody > tr'));
        const asc = th.dataset.order !== 'asc';
        rows.sort((a, b) => {
          const aText = a.children[colIndex].textContent.trim();
          const bText = b.children[colIndex].textContent.trim();
          return asc ? aText.localeCompare(bText, 'vi', { numeric: true }) : bText.localeCompare(aText, 'vi', { numeric: true });
        });
        rows.forEach(row => table.querySelector('tbody').appendChild(row));
        headers.forEach(h => {
          h.dataset.order = '';
          h.querySelector('span').textContent = '';
        });
        th.dataset.order = asc ? 'asc' : 'desc';
        arrow.textContent = asc ? '‚ñ≤' : '‚ñº';
      });
    });
  }

  // X·ª≠ l√Ω vƒÉn b·∫£n nh·∫≠n d·∫°ng gi·ªçng n√≥i
  async function processTranscript(transcript, fromHistory = false) {
    const cleaned = transcript.replace(/\s+/g, '').toUpperCase();
    if (!fromHistory) saveToHistory(cleaned);
    resultDiv.innerHTML = `üó£ B·∫°n n√≥i: <b>${transcript}</b><br>‚Üí Chu·∫©n h√≥a: <b>${cleaned}</b>`;
    const data = await fetchData();
    const results = data.filter(row => typeof row["Part Number"] === "string" && row["Part Number"].toUpperCase().includes(cleaned));

    if (results.length === 0) {
      statusDiv.innerText = "";
      speak("Kh√¥ng t√¨m th·∫•y Part Number.");
      resultDiv.innerHTML += `<br>‚ùå Kh√¥ng t√¨m th·∫•y Part Number.`;
      document.getElementById("relatedResults").innerHTML = '';
      return;
    }

    if (results.length === 1) {
      const msg = analyzePart(results[0]);
      statusDiv.innerText = "";
      resultDiv.innerHTML += `<br/>‚úÖ ${msg}`;
      speak(msg);

      // Hi·ªÉn th·ªã b·∫£ng cho 1 k·∫øt qu·∫£
      const erpCode = (results[0]["ERP-CODE"] || "").toUpperCase();
      let html = `<table id='resultsTable'><thead><tr>
        <th>No.</th><th>Part Number</th><th>REV</th><th>Approval Status</th><th>Customer</th>
        <th>Commodity</th><th>Product Name</th><th>Supplier</th><th>ERP-CODE</th><th>Part Pictures</th><th>Packaging Pictures</th><th>Ghi ch√∫</th>
      </tr></thead><tbody>`;
      results.forEach((r, i) => {
        const highlight = r["ERP-CODE"] && r["ERP-CODE"].toUpperCase() === erpCode ? 'class="active-row"' : '';
        html += `<tr ${highlight}>
          <td>${i+1}</td>
          <td>${r["Part Number"]}</td>
          <td>${r["REV"]}</td>
          <td>${r["Approval Status"]}</td>
          <td>${r["Customer"]}</td>
          <td>${r["Commodity"]}</td>
          <td>${r["Product Name"]}</td>
          <td>${r["Supplier"]}</td>
          <td>${r["ERP-CODE"]}</td>
          <td>${r["Part Pictures"]}</td>
          <td>${r["Packaging Pictures"]}</td>
          <td>${r["Ghi ch√∫"] || ""}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById("relatedResults").innerHTML = html;
      makeTableSortable('resultsTable');

      // N·∫øu mode image v√† c√≥ ·∫£nh, hi·ªÉn th·ªã ·∫£nh
      if (mode === 'image') {
        showImages(results[0]);
      } else {
        clearImages();
      }
      return;
    }

    // Nhi·ªÅu k·∫øt qu·∫£, hi·ªÉn th·ªã danh s√°ch
    let html = `<p>üîç C√≥ ${results.length} k·∫øt qu·∫£ t√¨m th·∫•y:</p>`;
    html += `<table id='resultsTable'><thead><tr>
      <th>No.</th><th>Part Number</th><th>REV</th><th>Approval Status</th><th>Customer</th>
      <th>Commodity</th><th>Product Name</th><th>Supplier</th><th>ERP-CODE</th><th>Part Pictures</th><th>Packaging Pictures</th><th>Ghi ch√∫</th>
    </tr></thead><tbody>`;
    results.forEach((r, i) => {
      html += `<tr>
        <td>${i+1}</td>
        <td>${r["Part Number"]}</td>
        <td>${r["REV"]}</td>
        <td>${r["Approval Status"]}</td>
        <td>${r["Customer"]}</td>
        <td>${r["Commodity"]}</td>
        <td>${r["Product Name"]}</td>
        <td>${r["Supplier"]}</td>
        <td>${r["ERP-CODE"]}</td>
        <td>${r["Part Pictures"]}</td>
        <td>${r["Packaging Pictures"]}</td>
        <td>${r["Ghi ch√∫"] || ""}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    document.getElementById("relatedResults").innerHTML = html;
    makeTableSortable('resultsTable');
    statusDiv.innerText = "";
    clearImages();
  }

  // Hi·ªÉn th·ªã ·∫£nh s·∫£n ph·∫©m v√† ƒë√≥ng g√≥i (n·∫øu c√≥)
  function showImages(part) {
    const containerId = 'imageContainer';
    let container = document.getElementById(containerId);
    if (!container) {
      container = document.createElement('div');
      container.id = containerId;
      container.style.marginTop = '1rem';
      container.style.display = 'flex';
      container.style.justifyContent = 'center';
      container.style.gap = '20px';
      document.getElementById("relatedResults").appendChild(container);
    } else {
      container.innerHTML = '';
    }

    const baseURL = "https://erp.sgcarmart.vn/PartPicture/";

    if (part["Part Pictures"] && part["Part Pictures"] !== '-' && part["Part Pictures"] !== 'OK') {
      const imgPart = document.createElement('img');
      imgPart.src = baseURL + part["Part Pictures"];
      imgPart.alt = "·∫¢nh s·∫£n ph·∫©m";
      imgPart.style.width = '300px';
      imgPart.style.borderRadius = '10px';
      imgPart.style.boxShadow = '0 0 10px #00cc99';
      container.appendChild(imgPart);
    }

    if (part["Packaging Pictures"] && part["Packaging Pictures"] !== '-' && part["Packaging Pictures"] !== 'OK') {
      const imgPack = document.createElement('img');
      imgPack.src = baseURL + part["Packaging Pictures"];
      imgPack.alt = "·∫¢nh ƒë√≥ng g√≥i";
      imgPack.style.width = '300px';
      imgPack.style.borderRadius = '10px';
      imgPack.style.boxShadow = '0 0 10px #00cc99';
      container.appendChild(imgPack);
    }

    // N·∫øu kh√¥ng c√≥ ·∫£nh n√†o h·ª£p l·ªá
    if (container.children.length === 0) {
      container.innerHTML = "<p>Kh√¥ng c√≥ ·∫£nh s·∫£n ph·∫©m ho·∫∑c ƒë√≥ng g√≥i.</p>";
    }
  }

  function clearImages() {
    const container = document.getElementById('imageContainer');
    if (container) container.innerHTML = '';
  }

  // L·ªãch s·ª≠ t√¨m ki·∫øm ƒë∆°n gi·∫£n l∆∞u tr√™n sessionStorage
  function saveToHistory(text) {
    const history = JSON.parse(sessionStorage.getItem("searchHistory") || "[]");
    if (!history.includes(text)) {
      history.push(text);
      sessionStorage.setItem("searchHistory", JSON.stringify(history));
    }
  }

  // Kh·ªüi t·∫°o nh·∫≠n d·∫°ng gi·ªçng n√≥i
  function initRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n d·∫°ng gi·ªçng n√≥i.");
      recordBtn.disabled = true;
      return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = "vi-VN";
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      isListening = true;
      recordBtn.textContent = "üéôÔ∏è ƒêang nghe... Nh·∫•n ƒë·ªÉ d·ª´ng";
      statusDiv.textContent = "ƒêang nghe gi·ªçng n√≥i...";
    };
    recognition.onend = () => {
      isListening = false;
      recordBtn.textContent = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
      statusDiv.textContent = "";
    };
    recognition.onerror = (event) => {
      statusDiv.textContent = `L·ªói nh·∫≠n d·∫°ng: ${event.error}`;
      isListening = false;
      recordBtn.textContent = "üéôÔ∏è Nh·∫•n ƒë·ªÉ b·∫Øt ƒë·∫ßu";
    };
    recognition.onresult = (event) => {
      if (event.results.length > 0) {
        const transcript = event.results[0][0].transcript.trim();
        processTranscript(transcript);
      }
    };
  }

  recordBtn.onclick = () => {
    if (isListening) {
      recognition.stop();
    } else {
      recognition.start();
    }
  };

  window.onload = () => {
    initRecognition();
  };
</script>
</body>
</html>
