<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra Cứu - Nguyễn Văn Đạo</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        /* Đoạn CSS responsive máy tính */
        @media (min-width: 768px) {
          html, body {
            height: 100%;
            overflow: hidden;
          }

          body {
            overflow-y: auto;
          }

          input, select, textarea {
            touch-action: manipulation;
            -webkit-user-select: text;
            user-select: text;
            caret-color: auto;
          }

          input:focus,
          select:focus,
          textarea:focus {
            outline: none;
            box-shadow: none;
          }
        }
        /* Cài đặt CSS cơ bản */
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
          font-family: Arial, sans-serif;
          background: url('background.jpg') no-repeat center center/cover;
          color: #333;
          display: flex;
          flex-direction: column;
        }
        .page-container {
          display: flex;
          flex-direction: column;
          height: 100%;
        }
        .top-container {
          flex: 0 0 auto;
          background: rgba(0, 0, 0, 0.85);
          padding: 15px;
          max-height: 40vh;
          overflow-y: auto;
          position: relative;
        }
        .header {
          text-align: center;
          padding: 10px;
          position: relative;
        }
        .tasks-link {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            background: #007bff;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        .tasks-link:hover {
            background: #0056b3;
        }
        .header h1 { margin: 0; font-size: 28px; color: white; }
        .header p { margin: 5px 0 0; font-size: 16px; color: #ddd; }
        .language-switcher {
          position: absolute;
          top: 10px;
          right: 10px;
        }
        .language-switcher button {
          padding: 4px 8px;
          margin-left: 5px;
          font-size: 12px;
          cursor: pointer;
          border: none;
          border-radius: 3px;
          background: #ff8c00;
          color: white;
          transition: background 0.3s;
        }
        .language-switcher button:hover {
          background: #ff6500;
        }
        .filter-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .filter-block {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          width: 220px; 
          font-size: 12px;
          color: white;
          box-sizing: border-box;
        }
        .filter-block label {
          display: block;
          margin-bottom: 3px;
          font-weight: bold;
        }
        .filter-block select, .filter-block input[type="date"] {
          width: 100%;
          padding: 3px;
          margin-bottom: 3px;
          font-size: 12px;
          box-sizing: border-box;
          border-radius: 3px;
          border: 1px solid #666;
        }
        .filter-block input[type="date"] {
            background-color: #fff;
            color: #333;
        }
        .date-range-inputs {
            display: none; 
        }
        .date-range-inputs label {
            font-size: 10px;
            margin-top: 5px;
            margin-bottom: 1px;
        }
        .action-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .action-bar > div {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          font-size: 12px;
          color: white;
          text-align: center;
        }
        .action-bar button {
          padding: 6px 12px;
          font-size: 12px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: 0.3s;
          margin: 3px;
        }
        .filter-actions button {
          background: linear-gradient(45deg, #ff8c00, #ff4500);
          color: white;
        }
        .filter-actions button:hover {
          background: linear-gradient(45deg, #ff6500, #ff0000);
        }
        .download-container button {
          background: linear-gradient(45deg, #007bff, #0056b3);
          color: white;
        }
        .download-container button:hover {
          background: linear-gradient(45deg, #3399ff, #007bff);
        }
        .zoom-controls button {
          background: linear-gradient(45deg, #28a745, #218838);
          color: white;
        }
        .zoom-controls button:hover {
          background: linear-gradient(45deg, #34d058, #28a745);
        }
        .results-count {
          text-align: center;
          margin: 5px;
          font-size: 14px;
          color: white;
        }
        .table-container {
          flex: 1 1 auto;
          margin: 5px auto;
          width: 98%;
          max-height: calc(100vh - 260px); 
          overflow-y: auto;
          overflow-x: auto;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        table {
          width: auto; 
          min-width: 100%; 
          border-collapse: collapse;
          table-layout: fixed; 
        }
        th, td {
          padding: 6px 8px;
          border: 1px solid #ccc;
          font-size: 12px;
          text-align: center;
          white-space: nowrap;
        }
        th {
          background: #4a76a8;
          color: white;
          position: sticky;
          top: 0;
          z-index: 2;
        }
        .sticky-col-1 {
          position: sticky;
          left: 0;
          width: 40px; 
          min-width: 40px;
          background: #4a76a8; 
          z-index: 3; 
        }
        .sticky-col-2 {
          position: sticky;
          left: 40px; 
          width: 100px; 
          min-width: 100px;
          background: #4a76a8;
          z-index: 3;
        }
        .sticky-col-3 {
          position: sticky;
          left: 140px; 
          width: 50px; 
          min-width: 50px;
          background: #4a76a8;
          z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
          background: #e6e6e6; 
          color: #333;
          z-index: 1; 
        }
        tr.selected { background-color: #ffeb99 !important; }
        .footer {
          flex: 0 0 auto;
          text-align: center;
          padding: 5px;
          font-size: 14px;
          background: #333;
          color: white;
        }

        /* --- CSS Chuẩn Hóa cho Popup Ảnh Nhỏ và Modal Ảnh Lớn --- */
        #image-popup {
            display: none; 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            border: 1px solid #ccc;
            background: white;
            padding: 10px; 
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            width: 270px; /* Kích thước cố định cho popup nhỏ */
            height: 270px;
            overflow: hidden; 
            box-sizing: border-box;
            transition: opacity 0.3s ease-in-out; /* Hiệu ứng khi hiện/ẩn */
        }

        #image-popup img {
            display: none; 
            width: 100%;   
            height: 100%;
            object-fit: contain; 
            cursor: pointer; /* Đổi cursor để báo hiệu có thể click mở ảnh lớn */
        }

        #image-popup .no-image-text {
            display: none; 
            width: 100%;
            height: 100%;
            padding: 20px;
            text-align: center;
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .image-popup-close { /* Nút đóng cho popup nhỏ */
            position: absolute;
            top: 3px; 
            right: 8px;
            font-size: 28px; 
            font-weight: bold;
            color: #888;
            cursor: pointer;
            z-index: 10001; 
            padding: 0 5px;
            line-height: 1;
            background-color: rgba(255,255,255,0.1); 
            border-radius: 50%;
        }
        .image-popup-close:hover {
            color: #000;
            background-color: rgba(230,230,230,0.5);
        }

        /* CSS cho Modal Hiển Thị Ảnh Lớn */
        #full-image-modal {
            display: none; /* Ẩn ban đầu */
            position: fixed; /* Che phủ toàn màn hình */
            z-index: 10005; /* Phải cao hơn #image-popup */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* Cho phép cuộn nếu ảnh quá lớn */
            background-color: rgba(0, 0, 0, 0.85); /* Nền mờ */
            /* Sử dụng flex để canh giữa nội dung */
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px;
            box-sizing: border-box;
        }

        #full-image-modal img {
            display: block;
            max-width: 90%;   /* Ảnh lớn nhất là 90% chiều rộng viewport */
            max-height: 90vh; /* Ảnh lớn nhất là 90% chiều cao viewport */
            margin: auto;     /* Canh giữa ảnh trong modal */
            border: 3px solid white;
            box-shadow: 0 0 25px rgba(0,0,0,0.5);
        }

        #full-image-modal .modal-close-button { /* Nút đóng cho modal ảnh lớn */
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 10006;
        }

        #full-image-modal .modal-close-button:hover,
        #full-image-modal .modal-close-button:focus {
            color: #bbb;
            text-decoration: none;
        }
        /* --- Kết thúc CSS cho Popup Ảnh và Modal --- */
        
        @media (max-width: 768px) {
          .language-switcher {
            position: static;
            margin-top: 10px;
            text-align: center;
          }
          .language-switcher button {
            padding: 3px 6px;
            margin: 0 3px;
            font-size: 10px;
          }
          .filter-bar, .action-bar {
            flex-direction: column;
            align-items: stretch;
          }
          .filter-block, .action-bar > div {
            width: 90%; 
            margin: 5px auto;
          }
          .header h1 { font-size: 24px; }
          .header p { font-size: 14px; }
          table, th, td { font-size: 10px; }
          .table-container {
            max-height: calc(100vh - 320px); 
          }
           .top-container {
                max-height: 45vh !important; 
                padding: 8px !important;
                overflow-y: auto;
            }
            .action-bar button,
            .language-switcher button {
                font-size: 16px; 
                padding: 10px 16px; 
            }
             #quick-search {
                font-size: 13px !important; 
            }
        }
        @media (max-width: 480px) {
          .tasks-link {
            position: relative;
            top: 0;
            left: 0;
            display: block;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            font-size: 16px;
          }
          .header h1 { font-size: 20px; }
          .header p { font-size: 12px; }
          table, th, td { font-size: 9px; }
        }

        @media (max-width: 768px) {
          body {
            padding-bottom: 300px; 
          }
        }

        @media screen and (orientation: landscape), (orientation: portrait) {
          .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            touch-action: pan-y; 
          }
          table {
            width: auto;
            min-width: 100%; 
          }
          td, th {
            word-break: break-word; 
          }
        }

        .table-container {
          width: 100vw; 
          max-height: 50vh; 
          overflow-x: auto;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch; 
          scroll-behavior: smooth;
          touch-action: auto; 
        }

        @media screen and (orientation: landscape) {
          .table-container {
            max-height: 60vh;
          }
        }

        @media screen and (orientation: portrait) {
          .table-container {
            max-height: 50vh;
          }
        }

        table {
          min-width: 800px; 
        }

        th, td {
          word-break: break-word;
          white-space: nowrap;
        }

        .table-container {
            width: 100%; 
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh; 
            -webkit-overflow-scrolling: touch;
        }
        table {
            border-collapse: collapse;
            min-width: 1000px; 
        }
        th, td {
            white-space: nowrap; 
            padding: 6px; 
            font-size: 12px;
        }
        .sticky-col-1 {
            position: sticky; left: 0; background: #4a76a8; z-index: 3;
        }
        .sticky-col-2 {
            position: sticky; left: 40px; background: #4a76a8; z-index: 3;
        }
        .sticky-col-3 {
            position: sticky; left: 140px; background: #4a76a8; z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
            background: #f3f3f3; 
        }

        input:focus, select:focus {
          outline: 2px solid #ff8c00; 
          background-color: #fffce6; 
        }

        @media (max-width: 768px) {
          input, select {
            font-size: 16px; 
          }
        }

        @media screen and (orientation: landscape) {
            .top-container {
                max-height: 30vh; 
                overflow-y: auto;
            }
            .table-container {
                height: auto; 
                max-height: 90vh; 
                min-height: 70vh; 
                overflow-x: auto;
                overflow-y: auto;
            }
            table {
                min-width: 1200px; 
            }
        }

        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        #results-table td, #results-table th {
          user-select: text; 
        }

        @media (max-width: 768px) {
            .top-container {
                max-height: 40vh !important; 
                padding: 8px !important;
                overflow-y: auto;
            }
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }
            .filter-block,
            .action-bar > div {
                padding: 4px;
                margin: 3px;
                font-size: 11px;
            }
            .action-bar button,
            .language-switcher button {
                font-size: 16px; 
                padding: 10px 16px; 
            }
            .filter-block select {
                font-size: 12px;
            }
            .results-count {
                font-size: 12px;
            }
            #quick-search {
                font-size: 13px !important; 
            }
        }

        .top-container,
        .table-container,
        #quick-search {
          transition: all 0.3s ease-in-out;
        }
        .full-top-container {
          height: 100vh !important;
          max-height: 100vh !important;
          overflow-y: auto;
        }
        .hide-top-container {
          height: 0 !important;
          max-height: 0 !important;
          overflow: hidden;
          padding: 0 !important;
          opacity: 0;
          pointer-events: none;
        }
        .show-table-only {
          height: calc(100vh - 60px); 
        }
    </style>
</head>
<body>
    <div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999;">
        <div style="border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>

    <div class="page-container">
        <div class="top-container">
            <div class="header">
                <a class="tasks-link" href="/tasks">Tasks</a>
                <h1 id="header-title">FAIR TEAM - Tra cứu tình trạng FAIR</h1>
                <p id="header-subtitle">Tra cứu tình trạng FAIR</p>
                <div class="language-switcher">
                    <button onclick="changeLanguage('vi')">Vi</button>
                    <button onclick="changeLanguage('en')">En</button>
                    <button onclick="changeLanguage('ko')">Ko</button>
                </div>
            </div>

            <div class="filter-bar">
                <div class="filter-block" id="filter-block-project">
                    <label for="filter-project" id="label-filter-project">Chọn dự án (Customer)</label>
                    <select class="value-select" id="filter-project" multiple="multiple"></select>
                </div>
                <div class="filter-block" id="filter-block-1">
                    <label for="filter-column-1" id="label-criteria-1">Chọn tiêu chí số 1:</label>
                    <select id="filter-column-1">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-1" id="label-filter-value-1">Chọn giá trị</label>
                    <select class="value-select" id="filter-value-1" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-1">
                        <label for="filter-date-start-1">Từ ngày:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-1">
                        <label for="filter-date-end-1">Đến ngày:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-1">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-2">
                    <label for="filter-column-2" id="label-criteria-2">Chọn tiêu chí số 2 (paste ex):</label>
                    <select id="filter-column-2">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-2" id="label-filter-value-2">Chọn giá trị</label>
                    <select id="filter-value-2" multiple="multiple"></select>
                     <div class="date-range-inputs" id="date-range-2">
                        <label for="filter-date-start-2">Từ ngày:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-2">
                        <label for="filter-date-end-2">Đến ngày:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-2">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-3">
                    <label for="filter-column-3" id="label-criteria-3">Chọn tiêu chí số 3:</label>
                    <select id="filter-column-3">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-3" id="label-filter-value-3">Chọn giá trị</label>
                    <select class="value-select" id="filter-value-3" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-3">
                        <label for="filter-date-start-3">Từ ngày:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-3">
                        <label for="filter-date-end-3">Đến ngày:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-3">
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <div class="filter-actions">
                    <button id="apply-filters">Áp Dụng Lọc</button>
                    <button id="clear-filters">Xóa Lọc</button>
                </div>
                <div class="download-container">
                    <button id="download-excel">Xuất Excel (Đang xem)</button>
                    <button id="export-all">Xuất Excel (Tất cả)</button>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in">Phóng to</button>
                    <button id="zoom-out">Thu nhỏ</button>
                </div>
            </div>
            <div class="scan-camera" style="text-align:center; margin-top:10px;">
                <button id="btnScanCamera">📷 Quét Camera</button>
            </div>
            <div class="results-count" id="results-count">Total rows: 0</div>
        </div>

        <div style="text-align:center; margin: 10px;">
            <input id="quick-search" placeholder="🔍 Tìm Part Number..." style="padding:5px; width: 60%; font-size:14px;" type="text"/>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead><tr>
                    <th class="sticky-col-1" data-column="No">No</th>
                    <th class="sticky-col-2" data-column="Part Number">Part Number</th>
                    <th class="sticky-col-3" data-column="REV">REV</th>
                    <th data-column="Approval Status">Approval Status</th>
                    <th data-column="Customer">Customer</th>
                    <th data-column="Commodity">Commodity</th>
                    <th data-column="Production Status">Production Status</th>
                    <th data-column="Part Pictures">Part Pictures</th>
                    <th data-column="Packaging Pictures">Packaging Pictures</th>
                    <th data-column="Critical">Critical</th>
                    <th data-column="CE">CE</th>
                    <th data-column="PO Number">PO Number</th>
                    <th data-column="Description">Description</th>
                    <th data-column="ERP-CODE">ERP-CODE</th>
                    <th data-column="Note Number">Note Number</th>
                    <th data-column="PO received date">PO received date</th>
                    <th data-column="Customer need date">Customer need date</th>
                    <th data-column="Requirements">Requirements</th>
                    <th data-column="FAIR Cover sheet">FAIR Cover sheet</th>
                    <th data-column="Bubble Drawings">Bubble Drawings</th>
                    <th data-column="Datasheet form">Datasheet form</th>
                    <th data-column="LAIR Data">LAIR Data</th>
                    <th data-column="FAIR Data">FAIR Data</th>
                    <th data-column="COC">COC</th>
                    <th data-column="BOM">BOM</th>
                    <th data-column="Mill">Mill</th>
                    <th data-column="Test reports / evidences">Test reports / evidences</th>
                    <th data-column="Remark 1">Remark 1</th>
                    <th data-column="Remark 2">Remark 2</th>
                    <th data-column="Submit date">Submit date</th>
                    <th data-column="Reject comments">Reject comments</th>
                </tr></thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="load-more-container" style="text-align:center; margin:10px;">
            <button id="load-more">Load More</button>
            <button id="load-all">Load All</button>
        </div>
        <div class="footer" id="footer-text">Người phát triển: Nguyễn Văn Đạo</div>
    </div>

    <div id="image-popup">
        <span class="image-popup-close">&times;</span>
        <img src="" alt="Part Image">
        <span class="no-image-text"></span>
    </div>

    <div id="full-image-modal">
        <span class="modal-close-button">&times;</span>
        <img id="modal-image-content" src="#" alt="Ảnh Phóng To">
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>

    <script>
        // Khởi tạo i18next
        i18next.use(i18nextBrowserLanguageDetector).init({
          fallbackLng: 'vi',
          debug: false, // Đặt là true nếu muốn xem log của i18next
          resources: {
            en: {
              translation: {
                "header_title": "FAIR TEAM - Search Status",
                "header_subtitle": "Search FAIR status",
                "choose_project": "Choose Project",
                "choose_value": "Choose Value",
                "choose_criteria_1": "Select Criteria 1:",
                "choose_criteria_2": "Select Criteria 2 (paste excel):",
                "choose_criteria_3": "Select Criteria 3:",
                "apply_filter": "Apply Filter",
                "clear_filter": "Clear Filter",
                "download_excel": "Export Excel (Current)",
                "export_all": "Export Excel (All)",
                "zoom_in": "Zoom In",
                "zoom_out": "Zoom Out",
                "load_more": "Load More",
                "load_all": "Load All",
                "total_rows": "Total rows: {{count}} / {{total}}",
                "developer": "Developer: Nguyễn Văn Đạo",
                "date_from": "From Date:",
                "date_to": "To Date:",
                "loading_image": "Loading image...",
                "image_not_found_erp": "Image for Part Number \"{{partNumber}}\" (ERP: {{erpCode}}) not found.",
                "image_not_found_no_erp": "No image for Part Number \"{{partNumber}}\". (ERP-CODE missing)"
              }
            },
            ko: {
              translation: {
                "header_title": "FAIR TEAM - 검색 상태",
                "header_subtitle": "FAIR 상태 검색",
                "choose_project": "프로젝트 선택",
                "choose_value": "값 선택",
                "choose_criteria_1": "기준 1 선택:",
                "choose_criteria_2": "기준 2 선택 (엑셀 붙여넣기):",
                "choose_criteria_3": "기준 3 선택:",
                "apply_filter": "필터 적용",
                "clear_filter": "필터 지우기",
                "download_excel": "엑셀 내보내기 (현재 보기)",
                "export_all": "엑셀 내보내기 (전체)",
                "zoom_in": "확대",
                "zoom_out": "축소",
                "load_more": "더 불러오기",
                "load_all": "전체 불러오기",
                "total_rows": "총 행: {{count}} / {{total}}",
                "developer": "개발자: Nguyễn Văn Đạo",
                "date_from": "시작 날짜:",
                "date_to": "종료 날짜:",
                "loading_image": "이미지 로드 중...",
                "image_not_found_erp": "부품 번호 \"{{partNumber}}\" (ERP: {{erpCode}})에 대한 이미지를 찾을 수 없습니다.",
                "image_not_found_no_erp": "부품 번호 \"{{partNumber}}\"에 대한 이미지가 없습니다. (ERP-CODE 없음)"
              }
            },
            vi: {
              translation: {
                "header_title": "FAIR TEAM - Tra cứu tình trạng FAIR",
                "header_subtitle": "Tra cứu tình trạng FAIR",
                "choose_project": "Chọn dự án",
                "choose_value": "Chọn giá trị",
                "choose_criteria_1": "Chọn tiêu chí số 1:",
                "choose_criteria_2": "Chọn tiêu chí số 2 (paste ex):",
                "choose_criteria_3": "Chọn tiêu chí số 3:",
                "apply_filter": "Áp dụng lọc",
                "clear_filter": "Xóa lọc",
                "download_excel": "Xuất Excel (Đang xem)",
                "export_all": "Xuất Excel (Tất cả)",
                "zoom_in": "Phóng to",
                "zoom_out": "Thu nhỏ",
                "load_more": "Tải thêm",
                "load_all": "Tải toàn bộ",
                "total_rows": "Tổng số dòng: {{count}} / {{total}}",
                "developer": "Người phát triển: Nguyễn Văn Đạo",
                "date_from": "Từ ngày:",
                "date_to": "Đến ngày:",
                "loading_image": "Đang tải ảnh...",
                "image_not_found_erp": "Ảnh cho Part Number \"{{partNumber}}\" (ERP: {{erpCode}}) không tồn tại.",
                "image_not_found_no_erp": "Không có ảnh cho Part Number \"{{partNumber}}\". (Thiếu ERP-CODE)"
              }
            }
          }
        }, function(err, t) {
          if (err) { return console.error('i18next initialization error:', err); }
          updateStaticContent();
        });

        function reinitializeSelect2(selector, placeholder, extraOptions) {
          var $el = $(selector);
          var currentValue = $el.val();
          if ($el.data('select2')) { 
            $el.select2("destroy");
          }
          $el.select2($.extend({
            placeholder: placeholder,
            allowClear: true,
            width: '100%'
          }, extraOptions));
          if(currentValue) { 
            $el.val(currentValue).trigger('change.select2'); 
          }
        }

        function updateStaticContent() {
          document.getElementById("header-title").innerText = i18next.t("header_title");
          document.getElementById("header-subtitle").innerText = i18next.t("header_subtitle");
          var labelSheet = document.querySelector('label[for="filter-project"]');
          if (labelSheet) { labelSheet.innerText = i18next.t("choose_project"); }
          
          for (let i = 1; i <= 3; i++) {
            var labelCriteria = document.getElementById(`label-criteria-${i}`);
            if (labelCriteria) { labelCriteria.innerText = i18next.t(`choose_criteria_${i}`); }
            
            var labelValue = document.getElementById(`label-filter-value-${i}`);
            if (labelValue) { labelValue.innerText = i18next.t("choose_value"); }

            var labelDateFrom = $(`#date-range-${i} label[for="filter-date-start-${i}"]`);
            if (labelDateFrom.length) { labelDateFrom.text(i18next.t("date_from")); }
            var labelDateTo = $(`#date-range-${i} label[for="filter-date-end-${i}"]`);
            if (labelDateTo.length) { labelDateTo.text(i18next.t("date_to")); }
          }
          
          var tbodyCount = $('#results-table tbody').children().length;
          $('#results-count').text(i18next.t("total_rows", { count: tbodyCount, total: totalData }));

          reinitializeSelect2('#filter-project', i18next.t("choose_project"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-1', i18next.t("choose_value"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-2', i18next.t("choose_value"), {});
          reinitializeSelect2('#filter-value-3', i18next.t("choose_value"), { closeOnSelect: false });

          document.getElementById("apply-filters").innerText = i18next.t("apply_filter");
          document.getElementById("clear-filters").innerText = i18next.t("clear_filter");
          document.getElementById("download-excel").innerText = i18next.t("download_excel");
          document.getElementById("export-all").innerText = i18next.t("export_all");
          document.getElementById("zoom-in").innerText = i18next.t("zoom_in");
          document.getElementById("zoom-out").innerText = i18next.t("zoom_out");
          document.getElementById("load-more").innerText = i18next.t("load_more");
          document.getElementById("load-all").innerText = i18next.t("load_all");
          document.getElementById("footer-text").innerText = i18next.t("developer");
        }

        function changeLanguage(lng) {
          i18next.changeLanguage(lng, function(err) {
            if (err) { return console.error('i18next changeLanguage error:', err); }
            updateStaticContent();
            $('.value-select').each(function() {
                const placeholderText = $(this).attr('id') === 'filter-project' ? i18next.t("choose_project") : i18next.t("choose_value");
                if ($(this).data('select2')) { // Kiểm tra xem select2 đã được khởi tạo chưa
                    $(this).data('select2').$container.find('.select2-selection__placeholder').text(placeholderText);
                }
            });
          });
        }
    </script>
    <script>
        function formatExcelDate(val) {
            if (!val) return '';
            if (typeof val === 'number') {
                let date = new Date(Date.UTC(1899, 11, 30 + val)); 
                if (!isNaN(date)) {
                    const<y_bin_46> = date.getUTCFullYear();
                    const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const dd = String(date.getUTCDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            } else if (typeof val === 'string') {
                const parsed = new Date(val);
                if (!isNaN(parsed)) {
                    const<y_bin_46> = parsed.getFullYear(); 
                    const mm = String(parsed.getMonth() + 1).padStart(2, '0');
                    const dd = String(parsed.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            }
            return val; 
        }

        let currentFilters = {};
        let currentOffset = 0;
        const pageSize = 50;
        let totalData = 0;
        let currentZoom = 1;
        let allData = null;

        function loadAllData() {
          $.getJSON('/search?limit=1000000', function(response) { 
            allData = response.data;
            totalData = response.total;
            updateFilterValuesForBlock(1);
            updateCascade(2); 
          }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error("Error loading all data:", textStatus, errorThrown);
          });
        }

        function loadDistinctValuesForProject() {
          const selectElem = $('#filter-project');
          selectElem.empty();
          $.getJSON('/filters', function(data) {
            if (data['Customer']) {
              data['Customer'].forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
              });
            }
            selectElem.trigger('change');
          }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error("Error loading distinct project values:", textStatus, errorThrown);
          });
        }

        function handleFilterTypeChange(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const valueSelectContainer = $('#filter-value-' + blockIndex).next('.select2-container');
            const valueSelect = $('#filter-value-' + blockIndex);
            const dateRangeInputs = $(`#date-range-${blockIndex}`);
            const labelValue = $(`label[for="filter-value-${blockIndex}"]`);

            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                valueSelectContainer.hide();
                valueSelect.hide();
                dateRangeInputs.show();
                labelValue.hide(); 
            } else {
                dateRangeInputs.hide();
                valueSelectContainer.show();
                valueSelect.show();
                labelValue.show().text(i18next.t("choose_value"));
            }
        }

        $(document).ready(function() {
            loadAllData();
            loadDistinctValuesForProject();

            $('.value-select').not('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-project').select2({
                placeholder: i18next.t("choose_project"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%'
            });

            handleFilterTypeChange(1);
            handleFilterTypeChange(2);
            handleFilterTypeChange(3);

            $(document).on('paste', '#filter-value-2 ~ .select2 .select2-search__field', function(e) {
                e.preventDefault();
                var clipboardData = e.originalEvent.clipboardData.getData('text/plain');
                var values = clipboardData.split(/\r?\n/).reduce(function(acc, line) {
                  return acc.concat(line.split('\t'));
                }, []).filter(function(val) {
                  return val.trim() !== '';
                });
                var $select = $('#filter-value-2');
                var currentValues = $select.val() || [];
                var newValues = currentValues.concat(values);
                newValues = Array.from(new Set(newValues));
                $select.val(newValues).trigger('change');
            });

            $('#filter-project').on('change', function(){
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });

            $('#filter-column-1').on('change', function() {
                handleFilterTypeChange(1);
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });
            $('#filter-value-1, #filter-date-start-1, #filter-date-end-1').on('change', function() {
                updateCascade(2);
            });
            $('#filter-column-2').on('change', function() {
                handleFilterTypeChange(2);
                updateFilterValuesForBlock(2);
                updateCascade(3);
            });
            $('#filter-value-2, #filter-date-start-2, #filter-date-end-2').on('change', function() {
                updateCascade(3);
            });
            $('#filter-column-3').on('change', function() {
                handleFilterTypeChange(3);
                updateFilterValuesForBlock(3);
            });

            $('#apply-filters').on('click', function() {
                const col1 = $('#filter-column-1').val();
                const val1 = $('#filter-value-1').val();
                if (col1 === 'Part Number' && val1 && val1.length > 0) {
                  val1.forEach(p => saveSearchHistory(p));
                }
                applyFilters(true);
            });
            $('#clear-filters').on('click', function() {
                $('.value-select').val(null).trigger('change');
                $('#filter-value-2').val(null).trigger('change');
                $('.date-select-start').val(''); 
                $('.date-select-end').val(''); 
                handleFilterTypeChange(1);
                handleFilterTypeChange(2);
                handleFilterTypeChange(3);
                applyFilters(true);
            });
            $('#load-more').on('click', function() {
                let loadMoreFilters = { ...currentFilters, offset: currentOffset, limit: pageSize };
                delete loadMoreFilters.limit; 
                
                if (currentOffset < totalData) {
                    showSpinner();
                    $.getJSON(`/search?${$.param(loadMoreFilters)}`, function(response) {
                        currentOffset += response.data.length; 
                        updateTable(response.data, false); 
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error("Error loading more data:", textStatus, errorThrown);
                        alert("Lỗi tải thêm dữ liệu. Vui lòng thử lại.");
                    }).always(function() {
                        hideSpinner();
                    });
                } else {
                    alert("Đã tải hết dữ liệu!");
                }
            });
            $('#load-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                queryParams.limit = 1000000; 
                queryParams.offset = 0;
                showSpinner();
                $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                  currentOffset = response.total; 
                  updateTable(response.data, true); 
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Error loading all data for table:", textStatus, errorThrown);
                    alert("Lỗi tải toàn bộ dữ liệu. Vui lòng thử lại.");
                }).always(function() {
                    hideSpinner();
                });
            });
            $('#download-excel').on('click', function() { downloadExcel(); });
            $('#export-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                const queryString = $.param(queryParams);
                window.location.href = `/export?${queryString}`;
            });
            $('#zoom-in').on('click', function() {
                currentZoom += 0.1;
                $('#results-table').css('zoom', currentZoom);
            });
            $('#zoom-out').on('click', function() {
                if (currentZoom > 0.5) {
                  currentZoom -= 0.1;
                  $('#results-table').css('zoom', currentZoom);
                }
            });
            try {
                if (typeof $.fn.colResizable === 'function') {
                  $('#results-table').colResizable({ liveDrag: true });
                }
            } catch(e) {
                console.log("colResizable not available:", e);
            }
            applyFilters(true); 
        });

        function updateFilterValuesForBlock(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                return;
            }
            
            if (!allData) {
                setTimeout(function(){ updateFilterValuesForBlock(blockIndex); }, 100);
                return;
            }
            let filteredData = allData.slice();

            const projectValues = $('#filter-project').val();
            if (projectValues && projectValues.length > 0) {
                filteredData = filteredData.filter(row => 
                    projectValues.some(s => row['Customer'] && row['Customer'].toString().toLowerCase().includes(s.toLowerCase()))
                );
            }

            for (let i = 1; i < blockIndex; i++) {
                const colSelectPrev = $(`#filter-column-${i}`);
                const colPrev = colSelectPrev.val();
                const prevOptionType = colSelectPrev.find('option:selected').data('type');
                
                if (prevOptionType === 'date') {
                    const dateStartPrev = $(`#filter-date-start-${i}`).val();
                    const dateEndPrev = $(`#filter-date-end-${i}`).val();
                    if (colPrev && (dateStartPrev || dateEndPrev)) {
                        filteredData = filteredData.filter(row => {
                            const itemDateStr = formatExcelDate(row[colPrev]);
                            if (!itemDateStr) return false;
                            const itemDate = new Date(itemDateStr);
                            let match = true;
                            if (dateStartPrev) {
                                match = match && itemDate >= new Date(dateStartPrev);
                            }
                            if (dateEndPrev) {
                                match = match && itemDate <= new Date(dateEndPrev);
                            }
                            return match;
                        });
                    }
                } else {
                    const valuesPrev = $('#filter-value-' + i).val();
                    if (colPrev && valuesPrev && valuesPrev.length > 0) {
                        filteredData = filteredData.filter(row =>
                            valuesPrev.some(v => row[colPrev] && row[colPrev].toString().toLowerCase().includes(v.toLowerCase()))
                        );
                    }
                }
            }
            
            let dependentColumn = $('#filter-column-' + blockIndex).val();
            let valuesInColumn = filteredData.map(function(row) {
                let cellVal = row[dependentColumn];
                if (columnSelect.find('option[value="' + dependentColumn + '"]').data('type') === 'date') {
                    cellVal = formatExcelDate(cellVal);
                }
                if (cellVal == null || cellVal.toString().trim() === "") return null;
                if (typeof cellVal === 'string') {
                    return cellVal.trim().toUpperCase();
                }
                return cellVal.toString().toUpperCase();
            }).filter(function(v) { return v !== null; });

            let distinctValues = Array.from(new Set(valuesInColumn));
            distinctValues.sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));

            const selectElem = $('#filter-value-' + blockIndex);
            const currentValue = selectElem.val();
            selectElem.empty();
            distinctValues.forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
            });
            
            if (currentValue) {
                const validCurrentValues = currentValue.filter(v => distinctValues.includes(v));
                selectElem.val(validCurrentValues);
            }
            selectElem.trigger('change.select2');
        }

        function updateCascade(startBlock) {
          for (let i = startBlock; i <= 3; i++) {
            updateFilterValuesForBlock(i);
          }
        }

        function applyFilters(reset = true) {
            if (reset) {
                currentOffset = 0;
            }
            let queryParams = { limit: pageSize, offset: currentOffset };
            const projectFilterValues = $('#filter-project').val();
            if (projectFilterValues && projectFilterValues.length > 0) {
                queryParams["Customer"] = projectFilterValues.join(',');
            }

            for (let i = 1; i <= 3; i++) {
                const colSelect = $(`#filter-column-${i}`);
                const col = colSelect.val();
                const selectedOptionDataType = colSelect.find('option:selected').data('type');
                
                if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart; 
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;     
                } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                        queryParams[col] = values.join(',');
                    }
                }
            }
            
            currentFilters = {...queryParams}; 
            
            showSpinner();
            $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                totalData = response.total;
                currentOffset = reset ? response.data.length : currentOffset + response.data.length;
                updateTable(response.data, reset);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("Error applying filters:", textStatus, errorThrown);
                alert("Lỗi khi áp dụng bộ lọc. Vui lòng thử lại.");
            }).always(function() {
                hideSpinner();
            });
        }

        function updateTable(data, reset) {
            const tbody = $('#results-table tbody');
            if (reset) tbody.empty();

            const imagePopup = $('#image-popup'); 
            const popupImgElement = imagePopup.find('img')[0];
            const $popupImg = $(popupImgElement);
            const popupText = imagePopup.find('span.no-image-text');
            const popupCloseButton = imagePopup.find('.image-popup-close');

            const fullImageModal = $('#full-image-modal'); 
            const modalImageContent = $('#modal-image-content');
            const modalCloseBtn = fullImageModal.find('.modal-close-button');

            let currentImageRequestToken = null;
            let currentErpForPopup = ''; 

            function closeSmallImagePopup() {
                console.log("Closing small popup.");
                imagePopup.hide();
                $popupImg.off('load.currentImage error.currentImage click.openLargeImage');
                popupImgElement.src = ''; 
                $popupImg.hide();
                popupText.text('').hide(); 
                currentImageRequestToken = null;
                currentErpForPopup = '';
            }
            
            function openLargeImageModal(erpCode) {
                if (!erpCode) return;
                console.log("Opening large image modal for ERP:", erpCode);
                const largeImageUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/f_auto,q_auto:good/ERP-CODE/${erpCode}.jpg`;
                modalImageContent.attr('src', largeImageUrl);
                fullImageModal.css('display', 'flex'); 
            }

            function closeLargeImageModal() {
                console.log("Closing large image modal.");
                fullImageModal.hide();
                modalImageContent.attr('src', '#'); 
            }

            if (!popupCloseButton.data('handlerAttachedCloseSmall')) {
                popupCloseButton.on('click.closeSmallPopup', function() {
                    closeSmallImagePopup();
                });
                popupCloseButton.data('handlerAttachedCloseSmall', true);
            }

            if (!modalCloseBtn.data('handlerAttachedCloseLarge')) {
                modalCloseBtn.on('click.closeLargeModal', function() {
                    closeLargeImageModal();
                });
                modalCloseBtn.data('handlerAttachedCloseLarge', true);
            }
            
            if (!fullImageModal.data('handlerAttachedOutsideClickLarge')) {
                fullImageModal.on('click.outsideLargeModal', function(e) {
                    if (e.target === this) { 
                        closeLargeImageModal();
                    }
                });
                fullImageModal.data('handlerAttachedOutsideClickLarge', true);
            }
            
            if (!$popupImg.data('openLargeHandlerAttached')) {
                $popupImg.on('click.openLargeImage', function() {
                    console.log("Small image clicked. Current ERP for popup:", currentErpForPopup, "Src:", this.src);
                    if (currentErpForPopup && this.src && !this.src.startsWith('data:')) { 
                        openLargeImageModal(currentErpForPopup);
                    } else {
                        console.log("Conditions not met to open large image.");
                    }
                });
                $popupImg.data('openLargeHandlerAttached', true);
            }


            data.forEach(function(row) {
                const serial = reset ? tbody.children().length + 1 : currentOffset - data.length + tbody.children().length + 1;
                const tr = $('<tr>');
                const partNumberValue = row['Part Number'] || 'N/A'; 

                tr.append(`<td class="sticky-col-1">${serial}</td>`);
                
                const partNumberCell = $(`<td>${partNumberValue}</td>`).addClass('sticky-col-2');
                partNumberCell.css('cursor', 'pointer');

                partNumberCell.on('click', function(e) {
                    const erpCodeForThisClick = row['ERP-CODE']?.trim().toUpperCase();
                    const partNumberForThisClick = partNumberValue;
                    
                    console.log("Part number cell clicked. ERP:", erpCodeForThisClick, "PN:", partNumberForThisClick);
                    const requestToken = Symbol(); 
                    currentImageRequestToken = requestToken;
                    
                    closeSmallImagePopup(); 
                    currentErpForPopup = erpCodeForThisClick; 
                    
                    imagePopup.css({
                        top: '50%', left: '50%', transform: 'translate(-50%, -50%)'
                    }).show(); 

                    if (erpCodeForThisClick) {
                        popupText.text(i18next.t("loading_image")).show();
                        $popupImg.hide();

                        const tempImgLoader = new Image();
                        $(tempImgLoader).off('load error'); 
                        
                        tempImgLoader.onload = function() {
                            console.log("Small image loaded. Token match:", currentImageRequestToken === requestToken);
                            if (currentImageRequestToken === requestToken) { 
                                popupImgElement.src = this.src;
                                $popupImg.show().css('cursor', 'pointer'); 
                                popupText.hide().text('');
                            }
                        };
                        
                        tempImgLoader.onerror = function() {
                            console.error("Error loading small image. Token match:", currentImageRequestToken === requestToken);
                            if (currentImageRequestToken === requestToken) {
                                $popupImg.hide().css('cursor', 'default'); 
                                popupText.text(i18next.t("image_not_found_erp", {partNumber: partNumberForThisClick, erpCode: erpCodeForThisClick})).show();
                            }
                        };
                        
                        const smallImageUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_250,h_250,c_limit,f_auto,q_auto:good/ERP-CODE/${erpCodeForThisClick}.jpg`;
                        console.log("Requesting small image:", smallImageUrl);
                        tempImgLoader.src = smallImageUrl;

                    } else {
                        console.log("No ERP code for this part number.");
                        $popupImg.hide().css('cursor', 'default');
                        popupText.text(i18next.t("image_not_found_no_erp", {partNumber: partNumberForThisClick})).show();
                    }
                });
                
                tr.append(partNumberCell);

                tr.append(`<td class="sticky-col-3">${row['REV'] || ''}</td>`);
                tr.append(`<td>${row['Approval Status'] || ''}</td>`);
                tr.append(`<td>${row['Customer'] || ''}</td>`);
                tr.append(`<td>${row['Commodity'] || ''}</td>`);
                tr.append(`<td>${row['Production Status'] || ''}</td>`);
                
                let partPicValue = row['Part Pictures'] || '';
                let partPicContent = partPicValue; 
                if (typeof partPicValue === 'string') {
                    if (partPicValue.toLowerCase().startsWith('http')) {
                        partPicContent = `<a href="${partPicValue}" target="_blank">Link</a>`;
                    } else if (partPicValue.trim().toUpperCase() === 'OK' || partPicValue.trim() === '') {
                        partPicContent = partNumberValue; 
                    }
                }
                tr.append(`<td>${partPicContent}</td>`);

                let pkgPicValue = row['Packaging Pictures'] || '';
                let pkgPicContent = pkgPicValue; 
                if (typeof pkgPicValue === 'string') {
                    if (pkgPicValue.toLowerCase().startsWith('http')) {
                        pkgPicContent = `<a href="${pkgPicValue}" target="_blank">Link</a>`;
                    } else if (pkgPicValue.trim().toUpperCase() === 'OK' || pkgPicValue.trim() === '') {
                        pkgPicContent = partNumberValue; 
                    }
                }
                tr.append(`<td>${pkgPicContent}</td>`);

                tr.append(`<td>${row['Critical'] || ''}</td>`);
                tr.append(`<td>${row['CE'] || ''}</td>`);
                tr.append(`<td>${row['PO Number'] || ''}</td>`);
                tr.append(`<td>${row['Description'] || ''}</td>`);
                tr.append(`<td>${row['ERP-CODE'] || ''}</td>`); 
                tr.append(`<td>${row['Note Number'] || ''}</td>`);
                tr.append(`<td>${formatExcelDate(row['PO received date'])}</td>`);
                tr.append(`<td>${formatExcelDate(row['Customer need date'])}</td>`);
                tr.append(`<td>${row['Requirements'] || ''}</td>`);
                tr.append(`<td>${row['FAIR Cover sheet'] || ''}</td>`);
                tr.append(`<td>${row['Bubble Drawings'] || ''}</td>`);
                tr.append(`<td>${row['Datasheet form'] || ''}</td>`);
                tr.append(`<td>${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
                tr.append(`<td>${row['FAIR Data'] || ''}</td>`);
                tr.append(`<td>${row['COC'] || ''}</td>`);
                tr.append(`<td>${row['BOM'] || ''}</td>`);
                tr.append(`<td>${row['Mill'] || ''}</td>`);
                tr.append(`<td>${row['Test reports / evidences'] || ''}</td>`);
                tr.append(`<td>${row['Remark 1'] || ''}</td>`);
                tr.append(`<td>${row['Remark 2'] || ''}</td>`);
                tr.append(`<td>${formatExcelDate(row['Submit date'])}</td>`);
                tr.append(`<td>${row['Reject comments'] || ''}</td>`);

                tbody.append(tr);
            });

            var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
            $('#results-count').text(totalText);

            try {
                if ($.fn.colResizable) {
                  $('#results-table').colResizable({ liveDrag: true, partialRefresh: true });
                }
            } catch (e) {
                console.log("colResizable not available in updateTable:", e);
            }
        }


        function downloadExcel() {
            const table = document.getElementById('results-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const dateColumns = ['PO received date', 'Customer need date', 'Submit date'];

            const data = rows.map(tr => {
                const cells = Array.from(tr.querySelectorAll('td'));
                const rowObj = {};
                cells.forEach((td, index) => {
                    let val = td.textContent.trim();
                    const header = headers[index];
                    rowObj[header] = val;
                });
                return rowObj;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, 'ketqua.xlsx');
        }

        function getColumnIndex(columnName) {
          let index = -1;
          $('#results-table th').each(function(i) {
            if ($(this).data('column') === columnName) {
              index = i;
              return false;
            }
          });
          return index;
        }
        function sortTable(column, order) {
          let rows = $('#results-table tbody tr').get();
          let colIndex = getColumnIndex(column);
          if (colIndex === -1) return;

          const isDateColumn = ['PO received date', 'Customer need date', 'Submit date'].includes(column);

          rows.sort(function(a, b) {
            let valA = $(a).children('td').eq(colIndex).text().toUpperCase();
            let valB = $(b).children('td').eq(colIndex).text().toUpperCase();

            if (isDateColumn) {
                const dateA = new Date(valA);
                const dateB = new Date(valB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                }
            }
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });
          $.each(rows, function(index, row) {
            $('#results-table tbody').append(row);
          });
        }
        $(document).on('click', '#results-table th', function () {
            const col = $(this).data('column');
            if (!col) return;

            const currentOrder = $(this).data('order') || 'asc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

            $('#results-table th').each(function () {
                $(this).data('order', null);
                const text = $(this).text().replace(/[▲▼]/g, '').trim();
                $(this).text(text);
            });

            const arrow = newOrder === 'asc' ? ' ▲' : ' ▼';
            $(this).text($(this).text().replace(/[▲▼]/g, '').trim() + arrow);
            $(this).data('order', newOrder);

            sortTable(col, newOrder);
        });
    </script>
    <div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999; overflow-y:auto; transition: all 0.3s ease;">
        <div style="background:#fff; padding:16px; border-radius:8px; width:95%; max-width:400px; text-align:center; margin-bottom: 10vh;">
            <h3>📷 Quét Part Number</h3>
            <div style="position: relative; width: 100%; max-height:240px;">
                <video id="camera" playsinline autoplay style="width:100%; max-height:240px; object-fit:cover; border-radius:6px;"></video>
                <div id="ocrGuideBox" style="position: absolute; border: 2px solid red; top: 35%; left: 10%; width: 80%; height: 20%; box-sizing: border-box; pointer-events: none;"></div>
            </div>
            <div id="zoomContainer" style="display:none; margin:10px auto; text-align:center;">
              🔍 Zoom:
              <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1" style="width:80%;"/>
            </div>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
                <button id="btnCapture" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">📸 Chụp &amp; Quét</button>
                <button id="btnApplyOcrFilter" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">✅ Lọc</button>
                <button id="btnCloseCamera" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">❌ Đóng</button>
            </div>
            <input id="ocrInput" type="text" placeholder="Kết quả OCR..." style="margin-top:10px; width:100%; padding:8px; font-size:14px;"/>
            <p id="ocrStatus" style="font-size:14px; margin-top:10px; margin-bottom: 20px; display: block;">Đang chờ thao tác...</p>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnScan = document.getElementById('btnScanCamera');
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const statusP = document.getElementById('ocrStatus');
      let inputOCR = document.getElementById('ocrInput');
      const btnCapture = document.getElementById('btnCapture');
      const btnClose = document.getElementById('btnCloseCamera');
      const btnApply = document.getElementById('btnApplyOcrFilter');
      const zoomSlider = document.getElementById("zoomSlider");
      const zoomContainer = document.getElementById("zoomContainer");
      let stream, intervalId;

      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          video.srcObject = null;
        }
        clearInterval(intervalId);
      }

      function cropCenterAndOCR(callback) {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const cropWidth = canvas.width * 0.8;
        const cropHeight = canvas.height * 0.2;
        const offsetX = canvas.width * 0.1;
        const offsetY = canvas.height * 0.35;
        const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = cropWidth;
        tempCanvas.height = cropHeight;
        tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

        Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
          .then(({ data: { text } }) => callback(text))
          .catch(() => statusP.textContent = '❌ Lỗi khi nhận diện.');
      }

      btnScan.addEventListener('click', async () => {
        modal.style.display = 'flex';
        statusP.textContent = '🔄 Đang khởi động camera...';
        inputOCR.value = '';
        document.getElementById("ocrInput").style.display = 'block';
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
          video.play();

          const track = stream.getVideoTracks()[0];
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            zoomContainer.style.display = 'block';
            zoomSlider.min = capabilities.zoom.min;
            zoomSlider.max = capabilities.zoom.max;
            zoomSlider.step = capabilities.zoom.step || 0.1;
            zoomSlider.value = capabilities.zoom.min;
            zoomSlider.addEventListener("input", () => {
              track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
            });
          }
          statusP.textContent = '✅ Đã kết nối camera. Nhấn "Chụp & Quét" hoặc giữ chế độ tự động';
        } catch (err) {
          statusP.textContent = '❌ Không thể truy cập camera.';
        }
      });

      btnCapture.addEventListener('click', () => {
        statusP.textContent = '🔍 Đang quét...';
        cropCenterAndOCR((text) => {
          const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
          if (lines.length === 0) return statusP.textContent = '❌ Không nhận được dòng nào.';

          if (lines.length === 1) {
            inputOCR.value = lines[0];
            statusP.textContent = '✅ Đã nhận 1 dòng.';
          } else {
            const selectHTML = `
              <select id="ocrLineSelector" style="width:100%; padding:8px; font-size:14px; margin-top:10px;">
                ${lines.map(l => `<option>${l}</option>`).join('')}
              </select>
            `;
            inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
            const selector = document.getElementById('ocrLineSelector');
            selector.addEventListener('change', () => {
              inputOCR.value = selector.value;
            });
            inputOCR.value = lines[0];
            statusP.textContent = `✅ Đã nhận ${lines.length} dòng. Đã chọn dòng đầu tiên, có thể chỉnh sửa.`;
          }
        });
      });

      btnApply.addEventListener('click', () => {
        const part = inputOCR.value.trim();
        if (!part) return alert('Bạn chưa nhập Part Number!');
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => { 
            $('#filter-value-1').val([part]).trigger('change'); 
            if (typeof applyFilters === 'function') applyFilters(true);
            statusP.textContent = `✅ Đã lọc với Part Number: ${part}`;
            saveSearchHistory(part);
            setTimeout(() => btnClose.click(), 1500);
        }, 50); 
      });

      btnClose.addEventListener('click', () => {
        modal.style.display = 'none';
        zoomContainer.style.display = 'none';
        stopStream();
        document.getElementById("ocrLineSelector")?.remove();
        inputOCR.value = '';
      });
    });
    </script>
    <script>
    window.addEventListener('resize', () => {
      const activeEl = document.activeElement;
      if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        setTimeout(() => {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const ocrInput = document.getElementById('ocrInput');
      if (ocrInput) {
        ocrInput.addEventListener('focus', () => {
          setTimeout(() => {
            ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('ocrInput');
      if (input) {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const inputs = document.querySelectorAll('.filter-bar input, .filter-bar select');
      inputs.forEach((input) => {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    });
    </script>
    <script>
    function showSpinner() {
      $('#loading-spinner').show();
    }
    function hideSpinner() {
      $('#loading-spinner').hide();
    }

    $('#quick-search').on('input', function () {
      const keyword = $(this).val().toLowerCase();
      $('#results-table tbody tr').each(function () {
        const partNumber = $(this).find('td:nth-child(2)').text().toLowerCase(); 
        $(this).toggle(partNumber.includes(keyword));
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const topContainer = document.querySelector('.top-container');
      const tableContainer = document.querySelector('.table-container');
      const quickSearch = document.getElementById('quick-search');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');

      let wasEditingTop = false;

      document.addEventListener('focusin', (e) => {
          if (window.innerWidth >= 768) return;
        const target = e.target;
        if (topContainer.contains(target) && ['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) {
          wasEditingTop = true;
          topContainer.classList.add('full-top-container');
          topContainer.classList.remove('hide-top-container');
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'none';
        } else if (target === quickSearch) {
          topContainer.classList.add('hide-top-container');
          tableContainer.classList.add('show-table-only');
        }
      });

      document.addEventListener('focusout', () => {
            if (window.innerWidth >= 768) return;
        setTimeout(() => {
          const active = document.activeElement;
          if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(active.tagName)) {
            if (wasEditingTop) {
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'none';
            } else {
              topContainer.classList.remove('full-top-container', 'hide-top-container');
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'block';
            }
          }
        }, 300);
      });

      function revealTableAndSearch() {
        wasEditingTop = false;
        topContainer.classList.remove('full-top-container', 'hide-top-container');
        quickSearch.style.display = 'block';
        tableContainer.classList.remove('show-table-only');
      }

      applyBtn?.addEventListener('click', revealTableAndSearch);
      clearBtn?.addEventListener('click', revealTableAndSearch);
    });
    </script>
    <button onclick="toggleHistoryPopup()" style="position: fixed; bottom: 20px; left: 20px; background: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 20px; cursor: pointer; z-index: 9999;" title="Lịch sử tìm kiếm">🕘</button>
    <div id="floating-history-popup" style="display: none; position: fixed; bottom: 80px; left: 20px; background: rgba(30,30,30,0.95); color: white; padding: 16px; border-radius: 12px; width: 300px; max-height: 360px; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0;">📜 Lịch sử tìm kiếm</h4>
            <button onclick="toggleHistoryPopup()" style="background: transparent; color: white; border: none; font-size: 20px; cursor: pointer;">×</button>
        </div>
        <ul id="searchHistory" style="list-style: none; padding-left: 0; margin: 12px 0;"></ul>
        <button onclick="clearSearchHistory()" style="margin-top: 8px; background:#cc4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width:100%;">🗑️ Xóa lịch sử</button>
    </div>

    <a href="/voice_search" style="position: fixed; bottom: 20px; right: 20px; background: #0066ff; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999;" title="Tìm kiếm bằng giọng nói">
      🎤
    </a>

    <script>
      function saveSearchHistory(partNumber) {
        if (!partNumber) return;
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const now = new Date().toLocaleString("vi-VN");
        const existingIndex = history.findIndex(item => item.partNumber === partNumber);
        if (existingIndex > -1) {
            history.splice(existingIndex, 1);
        }
        history.unshift({ partNumber, time: now });
        if (history.length > 30) history.pop();
        localStorage.setItem("partSearchHistory", JSON.stringify(history));
        renderSearchHistory();
      }

      function renderSearchHistory() {
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const list = document.getElementById("searchHistory");
        if (!list) return;
        list.innerHTML = "";
        history.forEach(item => {
          const li = document.createElement("li");
          li.style.marginBottom = "6px";
          li.innerHTML = `<button onclick="quickSearchFromHistory('${item.partNumber}'); navigator.clipboard.writeText('${item.partNumber}')" title="Click để tra cứu và sao chép" style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width: calc(100% - 70px); text-align:left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.partNumber}</button> <small style="color:#ccc; font-size: 10px;">(${item.time.split(',')[0]})</small>`;
          list.appendChild(li);
        });
      }

      function quickSearchFromHistory(partNumber) {
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => {
            $('#filter-value-1').val([partNumber]).trigger('change');
            applyFilters(true);
            toggleHistoryPopup(); 
        }, 50);
      }

      function clearSearchHistory() {
        localStorage.removeItem("partSearchHistory");
        renderSearchHistory();
      }
      
      function toggleHistoryPopup() {
          const popup = document.getElementById("floating-history-popup");
          if (popup) {
            const isOpen = popup.style.display === "block";
            popup.style.display = isOpen ? "none" : "block";
            if (!isOpen) {
              renderSearchHistory();
            }
          }
      }
      window.addEventListener("DOMContentLoaded", renderSearchHistory);
    </script>
</body>
</html>
