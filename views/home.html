<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Basic CSS setup */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif; /* Apply Inter font */
            background-color: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Light text color */
        }

        /* Responsive CSS for desktop */
        @media (min-width: 768px) {
            html, body {
                overflow: hidden; /* Prevent main scrollbar */
            }

            body {
                overflow-y: auto; /* Allow content to scroll if needed */
            }

            input, select, textarea {
                touch-action: manipulation;
                -webkit-user-select: text;
                user-select: text;
                caret-color: auto;
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                box-shadow: none;
            }
        }

        /* General styling for containers */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #2a2a4a; /* Slightly lighter dark background for containers */
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid #3a3a5a;
        }

        /* Form elements styling */
        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #c0c0c0;
        }

        input[type="text"],
        select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #4a4a6a;
            border-radius: 8px;
            background-color: #3a3a5a;
            color: #e0e0e0;
            box-sizing: border-box;
            font-size: 1rem;
        }

        input[type="text"]::placeholder {
            color: #888;
        }

        /* Button styling */
        button {
            background-color: #007bff; /* Primary blue */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.2);
            margin-right: 10px; /* Spacing between buttons */
        }

        button:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .button-group {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* DataTables specific styling adjustments (kept for general table look, though DataTables is not used for main table) */
        .dataTables_wrapper .dataTables_filter input {
            margin-left: 0.5em;
            border-radius: 8px;
            padding: 8px 12px;
            background-color: #3a3a5a;
            border: 1px solid #4a4a6a;
            color: #e0e0e0;
        }

        .dataTables_wrapper .dataTables_length select {
            border-radius: 8px;
            padding: 8px 12px;
            background-color: #3a3a5a;
            border: 1px solid #4a4a6a;
            color: #e0e0e0;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            background-color: #3a3a5a;
            color: #e0e0e0 !important;
            border: 1px solid #4a4a6a;
            border-radius: 8px;
            margin: 0 5px;
            padding: 6px 12px;
            transition: background-color 0.3s ease;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current,
        .dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
            background-color: #007bff;
            color: white !important;
            border-color: #007bff;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background-color: #0056b3;
            color: white !important;
        }

        table.dataTable thead th,
        table.dataTable tbody td {
            color: #e0e0e0;
            border-bottom: 1px solid #4a4a6a;
            padding: 12px 15px;
        }

        table.dataTable thead th {
            background-color: #3a3a5a;
            font-weight: 600;
        }

        table.dataTable.dtr-inline.collapsed > tbody > tr > td:first-child:before,
        table.dataTable.dtr-inline.collapsed > tbody > tr > th:first-child:before {
            background-color: #007bff !important;
        }

        /* Custom styling for copyable Part Number in history popup (original) */
        .copyable-part-number {
            cursor: copy; /* Indicate that it's copyable */
            text-decoration: underline; /* Visual cue */
            color: #87ceeb; /* A distinct color */
            transition: color 0.2s ease;
        }

        .copyable-part-number:hover {
            color: #4682b4; /* Darker on hover */
        }

        /* NEW: Custom styling for copyable Part Number in the main table */
        .copyable-table-part-number {
            cursor: copy; /* Indicate that it's copyable */
            text-decoration: underline; /* Visual cue */
            color: #87ceeb; /* A distinct color */
            transition: color 0.2s ease;
        }

        .copyable-table-part-number:hover {
            color: #4682b4; /* Darker on hover */
        }


        /* Floating History Popup */
        #floating-history-popup {
            display: none; /* Hidden by default */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a4a;
            border: 1px solid #3a3a5a;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            padding: 25px;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
            max-width: 400px;
        }

        #floating-history-popup h3 {
            color: #e0e0e0;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        #floating-history-popup ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        #floating-history-popup ul li {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #floating-history-popup ul li button {
            background-color: #444;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            width: calc(100% - 70px);
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            box-shadow: none; /* Remove button shadow */
            transition: background-color 0.2s ease;
        }
        #floating-history-popup ul li button:hover {
            background-color: #555;
            transform: none; /* No transform on history buttons */
        }

        #floating-history-popup ul li small {
            color: #ccc;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        #floating-history-popup .popup-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        #floating-history-popup .popup-buttons button {
            flex-grow: 1;
            margin: 0 5px;
        }

        /* Custom Message Box Styling (NEW) */
        #custom-message-box {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #3a3a5a;
            color: #e0e0e0;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1001; /* Higher than history popup */
            text-align: center;
            max-width: 300px;
            width: 80%;
        }

        #custom-message-box p {
            margin: 0 0 15px 0;
            font-size: 1.1rem;
        }

        #custom-message-box button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #custom-message-box button:hover {
            background-color: #0056b3;
        }

        /* Original CSS from your file */
        html, body { height: 100%; margin: 0; padding: 0; }
        body {
          font-family: Arial, sans-serif;
          background: url('background.jpg') no-repeat center center/cover;
          color: #333;
          display: flex;
          flex-direction: column;
        }
        .page-container {
          display: flex;
          flex-direction: column;
          height: 100%;
        }
        .top-container {
          flex: 0 0 auto;
          background: rgba(0, 0, 0, 0.85);
          padding: 15px;
          max-height: 40vh;
          overflow-y: auto;
          position: relative;
        }
        .header {
          text-align: center;
          padding: 10px;
          position: relative;
        }
        .tasks-link {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            background: #007bff;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        .tasks-link:hover {
            background: #0056b3;
        }
        .header h1 { margin: 0; font-size: 28px; color: white; }
        .header p { margin: 5px 0 0; font-size: 16px; color: #ddd; }
        /* Language switcher ·ªü g√≥c tr√™n b√™n ph·∫£i */
        .language-switcher {
          position: absolute;
          top: 10px;
          right: 10px;
        }
        .language-switcher button {
          padding: 4px 8px;
          margin-left: 5px;
          font-size: 12px;
          cursor: pointer;
          border: none;
          border-radius: 3px;
          background: #ff8c00;
          color: white;
          transition: background 0.3s;
        }
        .language-switcher button:hover {
          background: #ff6500;
        }
        /* Kh·ªëi ch·ª©a c√°c ti√™u ch√≠ l·ªçc */
        .filter-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .filter-block {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          width: 220px; /* TƒÉng chi·ªÅu r·ªông ƒë·ªÉ ch·ª©a 2 date input */
          font-size: 12px;
          color: white;
          box-sizing: border-box;
        }
        .filter-block label {
          display: block;
          margin-bottom: 3px;
          font-weight: bold;
        }
        .filter-block select, .filter-block input[type="date"] {
          width: 100%;
          padding: 3px;
          margin-bottom: 3px;
          font-size: 12px;
          box-sizing: border-box;
          border-radius: 3px;
          border: 1px solid #666;
        }
        .filter-block input[type="date"] {
            background-color: #fff;
            color: #333;
        }
        .date-range-inputs {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        .date-range-inputs label {
            font-size: 10px;
            margin-top: 5px;
            margin-bottom: 1px;
        }


        /* Kh·ªëi ch·ª©a c√°c n√∫t ch·ª©c nƒÉng */
        .action-bar {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          padding: 5px;
        }
        .action-bar > div {
          background: #444;
          border-radius: 5px;
          padding: 5px;
          margin: 5px;
          font-size: 12px;
          color: white;
          text-align: center;
        }
        .action-bar button {
          padding: 6px 12px;
          font-size: 12px;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          transition: 0.3s;
          margin: 3px;
        }
        .filter-actions button {
          background: linear-gradient(45deg, #ff8c00, #ff4500);
          color: white;
        }
        .filter-actions button:hover {
          background: linear-gradient(45deg, #ff6500, #ff0000);
        }
        .download-container button {
          background: linear-gradient(45deg, #007bff, #0056b3);
          color: white;
        }
        .download-container button:hover {
          background: linear-gradient(45deg, #3399ff, #007bff);
        }
        .zoom-controls button {
          background: linear-gradient(45deg, #28a745, #218838);
          color: white;
        }
        .zoom-controls button:hover {
          background: linear-gradient(45deg, #34d058, #28a745);
        }
        /* Ph·∫ßn hi·ªÉn th·ªã t·ªïng s·ªë d√≤ng */
        .results-count {
          text-align: center;
          margin: 5px;
          font-size: 14px;
          color: white;
        }
        /* B·∫£ng d·ªØ li·ªáu */
        .table-container {
          flex: 1 1 auto;
          margin: 5px auto;
          width: 98%;
          max-height: calc(100vh - 260px); /* ƒêi·ªÅu ch·ªânh n·∫øu top-container thay ƒë·ªïi chi·ªÅu cao */
          overflow-y: auto;
          overflow-x: auto;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 5px;
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        table {
          width: auto; /* Cho ph√©p b·∫£ng co gi√£n theo n·ªôi dung */
          min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng chi·∫øm √≠t nh·∫•t to√†n b·ªô chi·ªÅu r·ªông container */
          border-collapse: collapse;
          table-layout: fixed; /* Gi√∫p c·ªôt c·ªë ƒë·ªãnh ho·∫°t ƒë·ªông t·ªët h∆°n */
        }
        th, td {
          padding: 6px 8px;
          border: 1px solid #ccc;
          font-size: 12px;
          text-align: center;
          white-space: nowrap;
        }
        th {
          background: #4a76a8;
          color: white;
          position: sticky;
          top: 0;
          z-index: 2;
        }
        .sticky-col-1 {
          position: sticky;
          left: 0;
          width: 40px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho c·ªôt No */
          min-width: 40px;
          background: #4a76a8; /* M√†u n·ªÅn gi·ªëng th */
          z-index: 3; /* Cao h∆°n th th∆∞·ªùng v√† td th∆∞·ªùng */
        }
        .sticky-col-2 {
          position: sticky;
          left: 40px; /* No (40px) */
          width: 100px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho Part Number */
          min-width: 100px;
          background: #4a76a8;
          z-index: 3;
        }
        .sticky-col-3 {
          position: sticky;
          left: 140px; /* No (40px) + Part Number (100px) */
          width: 50px; /* C·ªë ƒë·ªãnh chi·ªÅu r·ªông cho REV */
          min-width: 50px;
          background: #4a76a8;
          z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
          background: #e6e6e6; /* M√†u n·ªÅn kh√°c cho td c·ªë ƒë·ªãnh ƒë·ªÉ ph√¢n bi·ªát */
          color: #333;
          z-index: 1; /* Cao h∆°n td th∆∞·ªùng nh∆∞ng th·∫•p h∆°n th c·ªë ƒë·ªãnh */
        }
        tr.selected { background-color: #ffeb99 !important; }
        .footer {
          flex: 0 0 auto;
          text-align: center;
          padding: 5px;
          font-size: 14px;
          background: #333;
          color: white;
        }

        /* CSS cho popup ·∫£nh */
        #image-popup {
            display: none;
            position: fixed;
            border: 1px solid #ccc;
            background: white;
            padding: 5px;
            z-index: 10000;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            max-width: 250px; /* Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc popup ban ƒë·∫ßu */
            max-height: 250px;
            cursor: default;
            transition: all 0.3s ease-in-out;
            overflow: auto; /* Cho ph√©p cu·ªôn khi ·∫£nh l·ªõn h∆°n popup ƒë√£ zoom */
        }
        #image-popup img {
            max-width: 100%;
            max-height: 100%;
            display: block; /* Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a d∆∞·ªõi ·∫£nh */
            cursor: zoom-in; /* Con tr·ªè ban ƒë·∫ßu */
            object-fit: contain; /* ƒê·∫£m b·∫£o ·∫£nh lu√¥n v·ª´a v·∫∑n */
            width: 100%; 
            height: 100%;
        }
        
        #image-popup .no-image-text {
            padding: 10px;
            text-align: center;
            color: #555;
        }

        /* Class cho tr·∫°ng th√°i ph√≥ng to */
        #image-popup.zoomed {
            max-width: 90vw; /* Chi·∫øm 90% chi·ªÅu r·ªông viewport */
            max-height: 90vh; /* Chi·∫øm 90% chi·ªÅu cao viewport */
            width: auto;  /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu r·ªông theo n·ªôi dung ·∫£nh */
            height: auto; /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu cao theo n·ªôi dung ·∫£nh */
            padding: 15px; /* TƒÉng padding khi zoom */
        }

        #image-popup.zoomed img {
            cursor: zoom-out; /* ƒê·ªïi cursor khi ·∫£nh ƒë√£ ƒë∆∞·ª£c ph√≥ng to */
        }

        /* N√∫t ƒë√≥ng (X) */
        .image-popup-close {
            position: absolute;
            top: 0px; 
            right: 8px;
            font-size: 24px; 
            font-weight: bold;
            cursor: pointer;
            color: #333;
            z-index: 10001; 
            padding: 2px 5px;
            background-color: rgba(255,255,255,0.7);
            border-radius: 50%;
            line-height: 1;
        }
        .image-popup-close:hover {
            color: #000;
            background-color: rgba(255,255,255,0.9);
        }

        /* CSS cho spinner t·∫£i ·∫£nh trong popup */
        .image-popup-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none; /* ·∫®n ban ƒë·∫ßu */
            z-index: 10002; /* Tr√™n ·∫£nh */
        }

        @media (max-width: 768px) {
          .language-switcher {
            position: static;
            margin-top: 10px;
            text-align: center;
          }
          .language-switcher button {
            padding: 3px 6px;
            margin: 0 3px;
            font-size: 10px;
          }
          .filter-bar, .action-bar {
            flex-direction: column;
            align-items: stretch;
          }
          .filter-block, .action-bar > div {
            width: 90%; /* TƒÉng chi·ªÅu r·ªông cho d·ªÖ thao t√°c */
            margin: 5px auto;
          }
          .header h1 { font-size: 24px; }
          .header p { font-size: 14px; }
          table, th, td { font-size: 10px; }
          .table-container {
            max-height: calc(100vh - 320px); /* ƒêi·ªÅu ch·ªânh n·∫øu c·∫ßn */
          }
           .top-container {
                max-height: 45vh !important; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa cho v√πng filter */
                padding: 8px !important;
                overflow-y: auto;
            }
            .action-bar button,
            .language-switcher button {
                font-size: 16px; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ cho n√∫t */
                padding: 10px 16px; /* TƒÉng padding cho n√∫t */
            }
             #quick-search {
                font-size: 13px !important; /* ƒê·∫£m b·∫£o quick search d·ªÖ th·∫•y */
            }
        }
        @media (max-width: 480px) {
          .tasks-link {
            position: relative;
            top: 0;
            left: 0;
            display: block;
            width: 100%;
            text-align: center;
            padding: 10px 0;
            font-size: 16px;
          }
          .header h1 { font-size: 20px; }
          .header p { font-size: 12px; }
          table, th, td { font-size: 9px; }
        }

        @media (max-width: 768px) {
          body {
            padding-bottom: 300px; /* ch·ª´a ch·ªó cho b√†n ph√≠m */
          }
        }

        @media screen and (orientation: landscape), (orientation: portrait) {
          .table-container {
            max-height: 60vh;
            overflow-y: auto;
            overflow-x: auto;
            touch-action: pan-y; /* Cho ph√©p cu·ªôn d·ªçc b·∫±ng c·∫£m ·ª©ng */
          }
          table {
            width: auto; /* Cho ph√©p b·∫£ng co gi√£n theo n·ªôi dung */
            min-width: 100%; /* ƒê·∫£m b·∫£o b·∫£ng chi·∫øm √≠t nh·∫•t to√†n b·ªô chi·ªÅu r·ªông container */
            border-collapse: collapse;
            table-layout: fixed; /* Gi√∫p c·ªôt c·ªë ƒë·ªãnh ho·∫°t ƒë·ªông t·ªët h∆°n */
          }
          td, th {
            word-break: break-word; /* Cho ph√©p ng·∫Øt t·ª´ n·∫øu c·∫ßn */
          }
        }

        /* T·ªëi ∆∞u b·∫£ng cho ƒëi·ªán tho·∫°i xoay ngang/d·ªçc v√† khi m·ªü b√†n ph√≠m */
        .table-container {
          width: 100vw; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông viewport */
          max-height: 50vh; /* Chi·ªÅu cao t·ªëi ƒëa */
          overflow-x: auto;
          overflow-y: auto;
          -webkit-overflow-scrolling: touch; /* Cu·ªôn m∆∞·ª£t tr√™n iOS */
          scroll-behavior: smooth;
          touch-action: auto; /* Cho ph√©p c·∫£ cu·ªôn ngang v√† d·ªçc */
        }

        @media screen and (orientation: landscape) {
          .table-container {
            max-height: 60vh;
          }
        }

        @media screen and (orientation: portrait) {
          .table-container {
            max-height: 50vh;
          }
        }

        table {
          min-width: 800px; /* Chi·ªÅu r·ªông t·ªëi thi·ªÉu c·ªßa b·∫£ng, ƒëi·ªÅu ch·ªânh n·∫øu c·∫ßn */
        }

        th, td {
          word-break: break-word;
          white-space: nowrap;
        }

        .table-container {
            width: 100%; /* ƒê·∫£m b·∫£o container chi·∫øm to√†n b·ªô chi·ªÅu r·ªông cha */
            overflow-x: auto;
            overflow-y: auto;
            max-height: 60vh; /* Ho·∫∑c gi√° tr·ªã ph√π h·ª£p */
            -webkit-overflow-scrolling: touch;
        }
        table {
            border-collapse: collapse;
            min-width: 1000px; /* Ho·∫∑c gi√° tr·ªã ph√π h·ª£p v·ªõi s·ªë c·ªôt */
        }
        th, td {
            white-space: nowrap; /* Gi·ªØ n·ªôi dung tr√™n m·ªôt d√≤ng */
            padding: 6px; /* ƒêi·ªÅu ch·ªânh padding n·∫øu c·∫ßn */
            font-size: 12px;
        }
        .sticky-col-1 {
            position: sticky; left: 0; background: #4a76a8; z-index: 3;
        }
        .sticky-col-2 {
            position: sticky; left: 40px; background: #4a76a8; z-index: 3;
        }
        .sticky-col-3 {
            position: sticky; left: 140px; background: #4a76a8; z-index: 3;
        }
        td.sticky-col-1, td.sticky-col-2, td.sticky-col-3 {
            background: #f3f3f3; /* M√†u n·ªÅn s√°ng h∆°n cho td c·ªë ƒë·ªãnh */
        }

        /* --- C·∫£i ti·∫øn cho input khi focus --- */
        input:focus, select:focus {
          outline: 2px solid #ff8c00; /* Vi·ªÅn cam n·ªïi b·∫≠t khi focus */
          background-color: #fffce6; /* N·ªÅn v√†ng nh·∫°t khi focus */
        }

        /* TƒÉng font input tr√™n ƒëi·ªán tho·∫°i ƒë·ªÉ d·ªÖ nh·∫≠p */
        @media (max-width: 768px) {
          input, select {
            font-size: 16px; /* K√≠ch th∆∞·ªõc ch·ªØ l·ªõn h∆°n cho input tr√™n mobile */
          }
        }

        /* C·∫£i thi·ªán b·∫£ng khi xoay ngang */
        @media screen and (orientation: landscape) {
            .top-container {
                max-height: 30vh; /* Gi·∫£m chi·ªÅu cao v√πng filter khi xoay ngang */
                overflow-y: auto;
            }
            .table-container {
                height: auto; /* Cho ph√©p b·∫£ng t·ª± ƒëi·ªÅu ch·ªânh chi·ªÅu cao */
                max-height: 90vh; /* TƒÉng chi·ªÅu cao t·ªëi ƒëa cho b·∫£ng */
                min-height: 70vh; /* Chi·ªÅu cao t·ªëi thi·ªÉu cho b·∫£ng */
                overflow-x: auto;
                overflow-y: auto;
            }
            table {
                min-width: 1200px; /* TƒÉng chi·ªÅu r·ªông t·ªëi thi·ªÉu c·ªßa b·∫£ng khi xoay ngang */
            }
        }


        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        #results-table td, #results-table th {
          user-select: text; /* Cho ph√©p ch·ªçn vƒÉn b·∫£n trong b·∫£ng */
        }


        @media (max-width: 768px) {
            .top-container {
                max-height: 40vh !important; /* Quan tr·ªçng: ƒê·∫£m b·∫£o ghi ƒë√® c√°c style kh√°c */
                padding: 8px !important;
                overflow-y: auto;
            }

            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }

            .filter-block,
            .action-bar > div {
                padding: 4px;
                margin: 3px;
                font-size: 11px;
            }

            .action-bar button,
            .language-switcher button {
                font-size: 16px; /* TƒÉng k√≠ch th∆∞·ªõc ch·ªØ cho n√∫t */
                padding: 10px 16px; /* TƒÉng padding cho n√∫t */
            }

            .filter-block select {
                font-size: 12px;
            }

            .results-count {
                font-size: 12px;
            }

            #quick-search {
                font-size: 13px !important; /* ƒê·∫£m b·∫£o quick search d·ªÖ th·∫•y */
            }
        }


        /* Hi·ªáu ·ª©ng m∆∞·ª£t cho v√πng ƒë·ªông */
        .top-container,
        .table-container,
        #quick-search {
          transition: all 0.3s ease-in-out;
        }
        .full-top-container {
          height: 100vh !important;
          max-height: 100vh !important;
          overflow-y: auto;
        }
        .hide-top-container {
          height: 0 !important;
          max-height: 0 !important;
          overflow: hidden;
          padding: 0 !important;
          opacity: 0;
          pointer-events: none;
        }
        .show-table-only {
          height: calc(100vh - 60px); /* 60px l√† chi·ªÅu cao c·ªßa quick search v√† footer */
        }

    </style>
</head>
<body>
    <div id="custom-message-box" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #3a3a5a; color: #e0e0e0; padding: 20px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); z-index: 1001; text-align: center; max-width: 300px; width: 80%;">
        <p id="message-text"></p>
        <button onclick="document.getElementById('custom-message-box').style.display = 'none';">OK</button>
    </div>

    <div id="loading-spinner" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); z-index:9999;">
        <div style="border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
    </div>

    <div class="page-container">
        <div class="top-container">
            <div class="header">
                <a class="tasks-link" href="/tasks">Tasks</a>
                <h1 id="header-title">FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR</h1>
                <p id="header-subtitle">Tra c·ª©u t√¨nh tr·∫°ng FAIR</p>
                <div class="language-switcher">
                    <button onclick="changeLanguage('vi')">Vi</button>
                    <button onclick="changeLanguage('en')">En</button>
                    <button onclick="changeLanguage('ko')">Ko</button>
                </div>
            </div>

            <div class="filter-bar">
                <div class="filter-block" id="filter-block-project">
                    <label for="filter-project" id="label-filter-project">Ch·ªçn d·ª± √°n (Customer)</label>
                    <select class="value-select" id="filter-project" multiple="multiple"></select>
                </div>
                <div class="filter-block" id="filter-block-1">
                    <label for="filter-column-1" id="label-criteria-1">Ch·ªçn ti√™u ch√≠ s·ªë 1:</label>
                    <select id="filter-column-1">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-1" id="label-filter-value-1">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select" id="filter-value-1" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-1">
                        <label for="filter-date-start-1">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-1">
                        <label for="filter-date-end-1">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-1">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-2">
                    <label for="filter-column-2" id="label-criteria-2">Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):</label>
                    <select id="filter-column-2">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-2" id="label-filter-value-2">Ch·ªçn gi√° tr·ªã</label>
                    <select id="filter-value-2" multiple="multiple"></select>
                     <div class="date-range-inputs" id="date-range-2">
                        <label for="filter-date-start-2">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-2">
                        <label for="filter-date-end-2">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-2">
                    </div>
                </div>
                <div class="filter-block" id="filter-block-3">
                    <label for="filter-column-3" id="label-criteria-3">Ch·ªçn ti√™u ch√≠ s·ªë 3:</label>
                    <select id="filter-column-3">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-3" id="label-filter-value-3">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select" id="filter-value-3" multiple="multiple"></select>
                    <div class="date-range-inputs" id="date-range-3">
                        <label for="filter-date-start-3">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start" id="filter-date-start-3">
                        <label for="filter-date-end-3">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end" id="filter-date-end-3">
                    </div>
                </div>
            </div>

            <div class="action-bar">
                <div class="filter-actions">
                    <button id="apply-filters">√Åp D·ª•ng L·ªçc</button>
                    <button id="clear-filters">X√≥a L·ªçc</button>
                </div>
                <div class="download-container">
                    <button id="download-excel">Xu·∫•t Excel (ƒêang xem)</button>
                    <button id="export-all">Xu·∫•t Excel (T·∫•t c·∫£)</button>
                </div>
                <div class="zoom-controls">
                    <button id="zoom-in">Ph√≥ng to</button>
                    <button id="zoom-out">Thu nh·ªè</button>
                </div>
            </div>
            <div class="scan-camera" style="text-align:center; margin-top:10px;">
                <button id="btnScanCamera">üì∑ Qu√©t Camera</button>
            </div>
            <div class="results-count" id="results-count">Total rows: 0</div>
        </div>

        <div style="text-align:center; margin: 10px;">
            <input id="quick-search" placeholder="üîç T√¨m Part Number..." style="padding:5px; width: 60%; font-size:14px;" type="text"/>
        </div>

        <div class="table-container">
            <table id="results-table">
                <thead><tr>
                    <th class="sticky-col-1" data-column="No">No</th>
                    <th class="sticky-col-2" data-column="Part Number">Part Number</th>
                    <th class="sticky-col-3" data-column="REV">REV</th>
                    <th data-column="Approval Status">Approval Status</th>
                    <th data-column="Customer">Customer</th>
                    <th data-column="Commodity">Commodity</th>
                    <th data-column="Production Status">Production Status</th>
                    <th data-column="Part Pictures">Part Pictures</th>
                    <th data-column="Packaging Pictures">Packaging Pictures</th>
                    <th data-column="Critical">Critical</th>
                    <th data-column="CE">CE</th>
                    <th data-column="PO Number">PO Number</th>
                    <th data-column="Description">Description</th>
                    <th data-column="ERP-CODE">ERP-CODE</th>
                    <th data-column="Note Number">Note Number</th>
                    <th data-column="PO received date">PO received date</th>
                    <th data-column="Customer need date">Customer need date</th>
                    <th data-column="Requirements">Requirements</th>
                    <th data-column="FAIR Cover sheet">FAIR Cover sheet</th>
                    <th data-column="Bubble Drawings">Bubble Drawings</th>
                    <th data-column="Datasheet form">Datasheet form</th>
                    <th data-column="LAIR Data">LAIR Data</th>
                    <th data-column="FAIR Data">FAIR Data</th>
                    <th data-column="COC">COC</th>
                    <th data-column="BOM">BOM</th
                    ><th data-column="Mill">Mill</th
                    ><th data-column="Test reports / evidences">Test reports / evidences</th
                    ><th data-column="Remark 1">Remark 1</th
                    ><th data-column="Remark 2">Remark 2</th
                    ><th data-column="Submit date">Submit date</th
                    ><th data-column="Reject comments">Reject comments</th>
                </tr></thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="load-more-container" style="text-align:center; margin:10px;">
            <button id="load-more">Load More</button>
            <button id="load-all">Load All</button>
        </div>
        <div class="footer" id="footer-text">Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o</div>
    </div>

    <div id="image-popup"> <span class="image-popup-close">&times;</span> <div class="image-popup-spinner"></div> <img src="" alt="Part Image" style="display:none;"> <span class="no-image-text" style="display:none;"></span>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>

    <script>
        // Custom message box function (NEW)
        function showMessageBox(message) {
            const msgBox = document.getElementById('custom-message-box');
            document.getElementById('message-text').innerText = message;
            msgBox.style.display = 'block';
        }

        // Kh·ªüi t·∫°o i18next
        i18next.use(i18nextBrowserLanguageDetector).init({
          fallbackLng: 'vi',
          debug: false,
          resources: {
            en: {
              translation: {
                "header_title": "FAIR TEAM - Search Status",
                "header_subtitle": "Search FAIR status",
                "choose_project": "Choose Project",
                "choose_value": "Choose Value",
                "choose_criteria_1": "Select Criteria 1:",
                "choose_criteria_2": "Select Criteria 2 (paste excel):",
                "choose_criteria_3": "Select Criteria 3:",
                "apply_filter": "Apply Filter",
                "clear_filter": "Clear Filter",
                "download_excel": "Export Excel (Current)",
                "export_all": "Export Excel (All)",
                "zoom_in": "Zoom In",
                "zoom_out": "Zoom Out",
                "load_more": "Load More",
                "load_all": "Load All",
                "total_rows": "Total rows: {{count}} / {{total}}",
                "developer": "Developer: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "From Date:",
                "date_to": "To Date:"
              }
            },
            ko: {
              translation: {
                "header_title": "FAIR TEAM - Í≤ÄÏÉâ ÏÉÅÌÉú",
                "header_subtitle": "FAIR ÏÉÅÌÉú Í≤ÄÏÉâ",
                "choose_project": "ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù",
                "choose_value": "Í∞í ÏÑ†ÌÉù",
                "choose_criteria_1": "Í∏∞Ï§Ä 1 ÏÑ†ÌÉù:",
                "choose_criteria_2": "Í∏∞Ï§Ä 2 ÏÑ†ÌÉù (ÏóëÏÖÄ Î∂ôÏó¨ÎÑ£Í∏∞):",
                "choose_criteria_3": "Í∏∞Ï§Ä 3 ÏÑ†ÌÉù:",
                "apply_filter": "ÌïÑÌÑ∞ Ï†ÅÏö©",
                "clear_filter": "ÌïÑÌÑ∞ ÏßÄÏö∞Í∏∞",
                "download_excel": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌòÑÏû¨ Î≥¥Í∏∞)",
                "export_all": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Ï†ÑÏ≤¥)",
                "zoom_in": "ÌôïÎåÄ",
                "zoom_out": "Ï∂ïÏÜå",
                "load_more": "Îçî Î∂àÎü¨Ïò§Í∏∞",
                "load_all": "Ï†ÑÏ≤¥ Î∂àÎü¨Ïò§Í∏∞",
                "total_rows": "Ï¥ù Ìñâ: {{count}} / {{total}}",
                "developer": "Í∞úÎ∞úÏûê: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "ÏãúÏûë ÎÇ†Ïßú:",
                "date_to": "Ï¢ÖÎ£å ÎÇ†Ïßú:"
              }
            },
            vi: {
              translation: {
                "header_title": "FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "header_subtitle": "Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "choose_project": "Ch·ªçn d·ª± √°n",
                "choose_value": "Ch·ªçn gi√° tr·ªã",
                "choose_criteria_1": "Ch·ªçn ti√™u ch√≠ s·ªë 1:",
                "choose_criteria_2": "Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):",
                "choose_criteria_3": "Ch·ªçn ti√™u ch√≠ s·ªë 3:",
                "apply_filter": "√Åp d·ª•ng l·ªçc",
                "clear_filter": "X√≥a l·ªçc",
                "download_excel": "Xu·∫•t Excel (ƒêang xem)",
                "export_all": "Xu·∫•t Excel (T·∫•t c·∫£)",
                "zoom_in": "Ph√≥ng to",
                "zoom_out": "Thu nh·ªè",
                "load_more": "T·∫£i th√™m",
                "load_all": "T·∫£i to√†n b·ªô",
                "total_rows": "T·ªïng s·ªë d√≤ng: {{count}} / {{total}}",
                "developer": "Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "T·ª´ ng√†y:",
                "date_to": "ƒê·∫øn ng√†y:"
              }
            }
          }
        }, function(err, t) {
          updateStaticContent();
        });

        function reinitializeSelect2(selector, placeholder, extraOptions) {
          var $el = $(selector);
          var currentValue = $el.val();
          if ($el.data('select2')) { 
            $el.select2("destroy");
          }
          $el.select2($.extend({
            placeholder: placeholder,
            allowClear: true,
            width: '100%'
          }, extraOptions));
          if(currentValue) { 
            $el.val(currentValue).trigger('change.select2'); 
          }
        }

        function updateStaticContent() {
          document.getElementById("header-title").innerText = i18next.t("header_title");
          document.getElementById("header-subtitle").innerText = i18next.t("header_subtitle");
          var labelSheet = document.querySelector('label[for="filter-project"]');
          if (labelSheet) { labelSheet.innerText = i18next.t("choose_project"); }
          
          for (let i = 1; i <= 3; i++) {
            var labelCriteria = document.getElementById(`label-criteria-${i}`);
            if (labelCriteria) { labelCriteria.innerText = i18next.t(`choose_criteria_${i}`); }
            
            var labelValue = document.getElementById(`label-filter-value-${i}`);
            if (labelValue) { labelValue.innerText = i18next.t("choose_value"); }

            var labelDateFrom = $(`#date-range-${i} label[for="filter-date-start-${i}"]`);
            if (labelDateFrom.length) { labelDateFrom.text(i18next.t("date_from")); }
            var labelDateTo = $(`#date-range-${i} label[for="filter-date-end-${i}"]`);
            if (labelDateTo.length) { labelDateTo.text(i18next.t("date_to")); }
          }
          
          var tbodyCount = $('#results-table tbody').children().length;
          $('#results-count').text(i18next.t("total_rows", { count: tbodyCount, total: totalData }));

          reinitializeSelect2('#filter-project', i18next.t("choose_project"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-1', i18next.t("choose_value"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-2', i18next.t("choose_value"), {});
          reinitializeSelect2('#filter-value-3', i18next.t("choose_value"), { closeOnSelect: false });

          document.getElementById("apply-filters").innerText = i18next.t("apply_filter");
          document.getElementById("clear-filters").innerText = i18next.t("clear_filter");
          document.getElementById("download-excel").innerText = i18next.t("download_excel");
          document.getElementById("export-all").innerText = i18next.t("export_all");
          document.getElementById("zoom-in").innerText = i18next.t("zoom_in");
          document.getElementById("zoom-out").innerText = i18next.t("zoom_out");
          document.getElementById("load-more").innerText = i18next.t("load_more");
          document.getElementById("load-all").innerText = i18next.t("load_all");
          document.getElementById("footer-text").innerText = i18next.t("developer");
        }

        function changeLanguage(lng) {
          i18next.changeLanguage(lng, function() {
            updateStaticContent();
            $('.value-select').each(function() {
                const placeholderText = $(this).attr('id') === 'filter-project' ? i18next.t("choose_project") : i18next.t("choose_value");
                $(this).data('select2').$container.find('.select2-selection__placeholder').text(placeholderText);
            });
          });
        }
    </script>
    <script>
        function formatExcelDate(val) {
            if (!val) return '';
            if (typeof val === 'number') {
                let date = new Date(Date.UTC(1899, 11, 30 + val)); 
                if (!isNaN(date)) {
                    const yyyy = date.getUTCFullYear();
                    const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const dd = String(date.getUTCDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            } else if (typeof val === 'string') {
                const parsed = new Date(val);
                if (!isNaN(parsed)) {
                    const yyyy = parsed.getFullYear(); 
                    const mm = String(parsed.getMonth() + 1).padStart(2, '0');
                    const dd = String(parsed.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            }
            return val; 
        }

        let currentFilters = {};
        let currentOffset = 0;
        const pageSize = 50;
        let totalData = 0;
        let currentZoom = 1;
        let allData = null;

        // --- C√ÅC BI·∫æN THAM CHI·∫æU POPUP ·∫¢NH (KHAI B√ÅO M·ªòT L·∫¶N) ---
        const imagePopup = $('#image-popup');
        const popupImg = imagePopup.find('img');
        const popupText = imagePopup.find('span.no-image-text');
        const popupCloseButton = imagePopup.find('.image-popup-close');
        const popupSpinner = imagePopup.find('.image-popup-spinner'); // Spinner m·ªõi


        function loadAllData() {
          console.log("loadAllData: ƒêang t·∫£i to√†n b·ªô d·ªØ li·ªáu...");
          $.getJSON('/search?limit=1000000', function(response) {
            console.log("loadAllData: Ph·∫£n h·ªìi t·ª´ server:", response);
            allData = response.data;
            totalData = response.total;
            if (!allData || allData.length === 0) {
                console.warn("loadAllData: allData tr·ªëng ho·∫∑c null. Ki·ªÉm tra server.js v√† endpoint /search.");
                showMessageBox("Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu ban ƒë·∫ßu. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi ho·∫∑c server.");
            } else {
                console.log("loadAllData: allData ƒë√£ ƒë∆∞·ª£c t·∫£i th√†nh c√¥ng. S·ªë l∆∞·ª£ng:", allData.length);
            }
            updateFilterValuesForBlock(1);
            updateCascade(2);
          }).fail(function(jqXHR, textStatus, errorThrown) {
              console.error("loadAllData: L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ /search:", textStatus, errorThrown, jqXHR);
              showMessageBox("L·ªói m·∫°ng ho·∫∑c server khi t·∫£i d·ªØ li·ªáu ban ƒë·∫ßu. Vui l√≤ng th·ª≠ l·∫°i.");
          });
        }

        function loadDistinctValuesForProject() {
          const selectElem = $('#filter-project');
          selectElem.empty();
          console.log("loadDistinctValuesForProject: ƒêang t·∫£i gi√° tr·ªã ƒë·ªôc l·∫≠p cho Project...");
          $.getJSON('/filters', function(data) {
            console.log("loadDistinctValuesForProject: Ph·∫£n h·ªìi t·ª´ /filters:", data);
            if (data['Customer']) {
              data['Customer'].forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
              });
              console.log("loadDistinctValuesForProject: ƒê√£ ƒëi·ªÅn gi√° tr·ªã cho Project.");
            } else {
                console.warn("loadDistinctValuesForProject: Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu 'Customer' t·ª´ /filters.");
            }
            selectElem.trigger('change');
          }).fail(function(jqXHR, textStatus, errorThrown) {
              console.error("loadDistinctValuesForProject: L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ /filters:", textStatus, errorThrown, jqXHR);
              showMessageBox("L·ªói m·∫°ng ho·∫∑c server khi t·∫£i danh s√°ch d·ª± √°n.");
          });
        }

        function handleFilterTypeChange(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const valueSelectContainer = $('#filter-value-' + blockIndex).next('.select2-container');
            const valueSelect = $('#filter-value-' + blockIndex);
            const dateRangeInputs = $(`#date-range-${blockIndex}`);
            const labelValue = $(`label[for="filter-value-${blockIndex}"]`);

            const selectedOptionDataType = columnSelect.find('option:selected').data('type');
            console.log(`handleFilterTypeChange(${blockIndex}): C·ªôt ƒë∆∞·ª£c ch·ªçn: ${columnSelect.val()}, Ki·ªÉu d·ªØ li·ªáu: ${selectedOptionDataType}`);

            if (selectedOptionDataType === 'date') {
                valueSelectContainer.hide();
                valueSelect.hide();
                dateRangeInputs.show();
                labelValue.hide(); 
            } else {
                dateRangeInputs.hide();
                valueSelectContainer.show();
                valueSelect.show();
                labelValue.show().text(i18next.t("choose_value"));
            }
        }


        $(document).ready(function() {
            console.log("Document Ready: B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o.");
            loadAllData();
            loadDistinctValuesForProject();

            $('.value-select').not('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-project').select2({
                placeholder: i18next.t("choose_project"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%'
            });

            handleFilterTypeChange(1);
            handleFilterTypeChange(2);
            handleFilterTypeChange(3);


            $(document).on('paste', '#filter-value-2 ~ .select2 .select2-search__field', function(e) {
                e.preventDefault();
                var clipboardData = e.originalEvent.clipboardData.getData('text/plain');
                var values = clipboardData.split(/\r?\n/).reduce(function(acc, line) {
                  return acc.concat(line.split('\t'));
                }, []).filter(function(val) {
                  return val.trim() !== '';
                });
                var $select = $('#filter-value-2');
                var currentValues = $select.val() || [];
                var newValues = currentValues.concat(values);
                newValues = Array.from(new Set(newValues));
                $select.val(newValues).trigger('change');
                console.log("Paste event: ƒê√£ d√°n c√°c gi√° tr·ªã v√†o filter-value-2:", newValues);
            });

            $('#filter-project').on('change', function(){
                console.log("filter-project changed:", $(this).val());
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });

            $('#filter-column-1').on('change', function() {
                console.log("filter-column-1 changed:", $(this).val());
                handleFilterTypeChange(1);
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });
            $('#filter-value-1, #filter-date-start-1, #filter-date-end-1').on('change', function() {
                console.log("filter-value-1 or date changed.");
                updateCascade(2);
            });
            $('#filter-column-2').on('change', function() {
                console.log("filter-column-2 changed:", $(this).val());
                handleFilterTypeChange(2);
                updateFilterValuesForBlock(2);
                updateCascade(3);
            });
            $('#filter-value-2, #filter-date-start-2, #filter-date-end-2').on('change', function() {
                console.log("filter-value-2 or date changed.");
                updateCascade(3);
            });
            $('#filter-column-3').on('change', function() {
                console.log("filter-column-3 changed:", $(this).val());
                handleFilterTypeChange(3);
                updateFilterValuesForBlock(3);
            });

            $('#apply-filters').on('click', function() {
                console.log("Apply Filters clicked.");
                const col1 = $('#filter-column-1').val();
                const val1 = $('#filter-value-1').val();
                if (col1 === 'Part Number' && val1 && val1.length > 0) {
                  val1.forEach(p => saveSearchHistory(p));
                }
                applyFilters(true);
            });
            $('#clear-filters').on('click', function() {
                console.log("Clear Filters clicked.");
                $('.value-select').val(null).trigger('change');
                $('#filter-value-2').val(null).trigger('change');
                $('.date-select-start').val(''); 
                $('.date-select-end').val(''); 
                handleFilterTypeChange(1);
                handleFilterTypeChange(2);
                handleFilterTypeChange(3);
                applyFilters(true);
            });
            $('#load-more').on('click', function() {
                console.log("Load More clicked. Current offset:", currentOffset, "Total data:", totalData);
                let loadMoreFilters = { ...currentFilters, offset: currentOffset, limit: pageSize };
                delete loadMoreFilters.limit; 
                
                if (currentOffset < totalData) {
                    showSpinner();
                    $.getJSON(`/search?${$.param(loadMoreFilters)}`, function(response) {
                        console.log("Load More: Ph·∫£n h·ªìi t·ª´ server:", response);
                        currentOffset += response.data.length; 
                        updateTable(response.data, false); 
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        console.error("Load More: L·ªói khi t·∫£i th√™m d·ªØ li·ªáu t·ª´ /search:", textStatus, errorThrown, jqXHR);
                        showMessageBox("L·ªói m·∫°ng ho·∫∑c server khi t·∫£i th√™m d·ªØ li·ªáu.");
                    }).always(function() {
                        hideSpinner();
                    });
                } else {
                    showMessageBox("ƒê√£ t·∫£i h·∫øt d·ªØ li·ªáu!"); 
                }
            });
            $('#load-all').on('click', function() {
                console.log("Load All clicked.");
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                queryParams.limit = 1000000; 
                queryParams.offset = 0;
                showSpinner();
                $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                  console.log("Load All: Ph·∫£n h·ªìi t·ª´ server:", response);
                  currentOffset = response.total; 
                  updateTable(response.data, true); 
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error("Load All: L·ªói khi t·∫£i to√†n b·ªô d·ªØ li·ªáu t·ª´ /search:", textStatus, errorThrown, jqXHR);
                    showMessageBox("L·ªói m·∫°ng ho·∫∑c server khi t·∫£i to√†n b·ªô d·ªØ li·ªáu.");
                }).always(function() {
                    hideSpinner();
                });
            });
            $('#download-excel').on('click', function() { console.log("Download Excel clicked."); downloadExcel(); });
            $('#export-all').on('click', function() {
                console.log("Export All clicked.");
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                const queryString = $.param(queryParams);
                window.location.href = `/export?${queryString}`;
            });
            $('#zoom-in').on('click', function() {
                console.log("Zoom In clicked.");
                currentZoom += 0.1;
                $('#results-table').css('zoom', currentZoom);
            });
            $('#zoom-out').on('click', function() {
                console.log("Zoom Out clicked.");
                if (currentZoom > 0.5) {
                  currentZoom -= 0.1;
                  $('#results-table').css('zoom', currentZoom);
                }
            });
            try {
                if (typeof $.fn.colResizable === 'function') {
                  $('#results-table').colResizable({ liveDrag: true });
                  console.log("colResizable ƒë√£ ƒë∆∞·ª£c kh·ªüi t·∫°o.");
                }
            } catch(e) {
                console.log("colResizable kh√¥ng kh·∫£ d·ª•ng:", e);
            }

            // --- C√ÅC S·ª∞ KI·ªÜN CHO POPUP ·∫¢NH (G·∫ÆN M·ªòT L·∫¶N) ---
            popupCloseButton.off('click.closepopup').on('click.closepopup', function() {
                closeImagePopup();
                console.log("Popup ·∫£nh ƒë√£ ƒë√≥ng.");
            });

            $(document).off('mouseup.imagePopupOutside').on('mouseup.imagePopupOutside', function(e) {
                if (imagePopup.is(':visible') && !imagePopup.is(e.target) && imagePopup.has(e.target).length === 0) {
                    closeImagePopup();
                    console.log("Click b√™n ngo√†i popup ·∫£nh, ƒë√£ ƒë√≥ng.");
                }
            });
            
            popupImg.off('load.zoom error.zoom').on('click.zoom', function() { // Added .zoom namespace
                const $thisImage = $(this);
                if (imagePopup.is(':visible') && $thisImage.is(':visible')) {
                    imagePopup.toggleClass('zoomed');
                    console.log("Popup ·∫£nh: ƒê√£ chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i zoom.");
                    
                    popupSpinner.show(); 
                    $thisImage.hide(); 
                    popupText.hide(); 

                    if (imagePopup.hasClass('zoomed')) {
                        const highQualityUrl = imagePopup.data('high-quality-url');
                        if (highQualityUrl) {
                            $thisImage.attr('src', highQualityUrl);
                            console.log("Popup ·∫£nh: ƒêang t·∫£i ·∫£nh ch·∫•t l∆∞·ª£ng cao:", highQualityUrl);
                        } else {
                            console.warn("Popup ·∫£nh: Kh√¥ng t√¨m th·∫•y URL ·∫£nh ch·∫•t l∆∞·ª£ng cao.");
                            popupText.text('L·ªói: Kh√¥ng c√≥ URL ·∫£nh l·ªõn.').show();
                            popupSpinner.hide();
                        }
                    } else {
                        const thumbnailUrl = imagePopup.data('thumbnail-url');
                        if (thumbnailUrl) {
                            $thisImage.attr('src', thumbnailUrl);
                            console.log("Popup ·∫£nh: ƒêang t·∫£i ·∫£nh thumbnail:", thumbnailUrl);
                        } else {
                            console.warn("Popup ·∫£nh: Kh√¥ng t√¨m th·∫•y URL ·∫£nh thumbnail.");
                            popupText.text('L·ªói: Kh√¥ng c√≥ URL ·∫£nh thumbnail.').show();
                            popupSpinner.hide();
                        }
                    }
                }
            });
            // Re-attach load/error handlers for popupImg
            popupImg.on('load', function() {
                const expectedErp = imagePopup.data('current-erp');
                if (expectedErp && $(this).attr('src') && $(this).attr('src').includes(expectedErp)) {
                    popupSpinner.hide();
                    $(this).show();
                    popupText.hide().text('');
                    if (imagePopup.is(':hidden')) {
                        imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                    }
                    console.log("Popup ·∫£nh: ·∫¢nh ƒë√£ t·∫£i xong.");
                }
            });

            popupImg.on('error', function() {
                const expectedErp = imagePopup.data('current-erp');
                const pn = imagePopup.data('current-part-number') || "N/A";
                if (expectedErp && ($(this).attr('src') === '' || ($(this).attr('src') && $(this).attr('src').includes(expectedErp)))) {
                    popupSpinner.hide();
                    $(this).hide();
                    popupText.text(`·∫¢nh cho Part Number "${pn}" (ERP: ${expectedErp}) kh√¥ng t·ªìn t·∫°i.`).show();
                    if (imagePopup.is(':hidden')) {
                        imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                    }
                    console.warn("Popup ·∫£nh: L·ªói t·∫£i ·∫£nh. ERP:", expectedErp);
                }
            });
            // K·∫øt th√∫c c√°c s·ª± ki·ªán cho popup ·∫£nh

            // NEW: Event listener for copying Part Number from the main table
            $(document).on('click', '.copyable-table-part-number', function(e) {
                e.stopPropagation(); // Prevent the parent <td>'s click event (for image popup)
                const partNumberToCopy = $(this).data('part-number');
                console.log("Copy Part Number clicked:", partNumberToCopy);

                navigator.clipboard.writeText(partNumberToCopy).then(() => {
                    showMessageBox('ƒê√£ sao ch√©p: ' + partNumberToCopy);
                    console.log('ƒê√£ sao ch√©p th√†nh c√¥ng: ' + partNumberToCopy);
                }).catch(err => {
                    console.error('Kh√¥ng th·ªÉ sao ch√©p vƒÉn b·∫£n:', err);
                    const textArea = document.createElement("textarea");
                    textArea.value = partNumberToCopy;
                    document.body.appendChild(textArea);
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        showMessageBox('ƒê√£ sao ch√©p (fallback): ' + partNumberToCopy);
                        console.log('ƒê√£ sao ch√©p th√†nh c√¥ng (fallback): ' + partNumberToCopy);
                    } catch (err) {
                        console.error('Kh√¥ng th·ªÉ sao ch√©p vƒÉn b·∫£n b·∫±ng fallback:', err);
                        showMessageBox('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng ch·ªçn v√† sao ch√©p th·ªß c√¥ng: ' + partNumberToCopy);
                    }
                    document.body.removeChild(textArea);
                });
            });

            applyFilters(true); // Initial load
            console.log("Document Ready: ƒê√£ ho√†n t·∫•t kh·ªüi t·∫°o.");
        });

        function updateFilterValuesForBlock(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            console.log(`updateFilterValuesForBlock(${blockIndex}): ƒêang c·∫≠p nh·∫≠t gi√° tr·ªã l·ªçc cho kh·ªëi ${blockIndex}. allData hi·ªán t·∫°i:`, allData);

            if (selectedOptionDataType === 'date') {
                console.log(`updateFilterValuesForBlock(${blockIndex}): C·ªôt l√† ki·ªÉu ng√†y, b·ªè qua c·∫≠p nh·∫≠t dropdown.`);
                return;
            }
            
            if (!allData) {
                console.warn(`updateFilterValuesForBlock(${blockIndex}): allData ch∆∞a s·∫µn s√†ng ho·∫∑c tr·ªëng. ƒêang th·ª≠ l·∫°i sau 100ms.`);
                setTimeout(function(){ updateFilterValuesForBlock(blockIndex); }, 100);
                return;
            }
            let filteredData = allData.slice();
            console.log(`updateFilterValuesForBlock(${blockIndex}): D·ªØ li·ªáu ban ƒë·∫ßu ƒë·ªÉ l·ªçc:`, filteredData.length, "h√†ng.");

            const projectValues = $('#filter-project').val();
            if (projectValues && projectValues.length > 0) {
                filteredData = filteredData.filter(row => 
                    projectValues.some(s => row['Customer'] && row['Customer'].toString().toLowerCase().includes(s.toLowerCase()))
                );
                console.log(`updateFilterValuesForBlock(${blockIndex}): ƒê√£ l·ªçc theo Project. C√≤n l·∫°i:`, filteredData.length, "h√†ng.");
            }

            for (let i = 1; i < blockIndex; i++) {
                const colSelectPrev = $(`#filter-column-${i}`);
                const colPrev = colSelectPrev.val();
                const prevOptionType = colSelectPrev.find('option:selected').data('type');
                
                if (prevOptionType === 'date') {
                    const dateStartPrev = $(`#filter-date-start-${i}`).val();
                    const dateEndPrev = $(`#filter-date-end-${i}`).val();
                    if (colPrev && (dateStartPrev || dateEndPrev)) {
                        filteredData = filteredData.filter(row => {
                            const itemDateStr = formatExcelDate(row[colPrev]);
                            if (!itemDateStr) return false;
                            const itemDate = new Date(itemDateStr);
                            let match = true;
                            if (dateStartPrev) {
                                match = match && itemDate >= new Date(dateStartPrev);
                            }
                            if (dateEndPrev) {
                                match = match && itemDate <= new Date(dateEndPrev);
                            }
                            return match;
                        });
                        console.log(`updateFilterValuesForBlock(${blockIndex}): ƒê√£ l·ªçc theo ng√†y cho kh·ªëi ${i}. C√≤n l·∫°i:`, filteredData.length, "h√†ng.");
                    }
                } else {
                    const valuesPrev = $('#filter-value-' + i).val();
                    if (colPrev && valuesPrev && valuesPrev.length > 0) {
                        filteredData = filteredData.filter(row =>
                            valuesPrev.some(v => row[colPrev] && row[colPrev].toString().toLowerCase().includes(v.toLowerCase()))
                        );
                        console.log(`updateFilterValuesForBlock(${blockIndex}): ƒê√£ l·ªçc theo gi√° tr·ªã cho kh·ªëi ${i}. C√≤n l·∫°i:`, filteredData.length, "h√†ng.");
                    }
                }
            }
            
            let dependentColumn = $('#filter-column-' + blockIndex).val();
            let valuesInColumn = filteredData.map(function(row) {
                let cellVal = row[dependentColumn];
                if (columnSelect.find('option[value="' + dependentColumn + '"]').data('type') === 'date') {
                    cellVal = formatExcelDate(cellVal);
                }
                if (cellVal == null || cellVal.toString().trim() === "") return null;
                if (typeof cellVal === 'string') {
                    return cellVal.trim().toUpperCase();
                }
                return cellVal.toString().toUpperCase();
            }).filter(function(v) { return v !== null; });

            let distinctValues = Array.from(new Set(valuesInColumn));
            distinctValues.sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));
            console.log(`updateFilterValuesForBlock(${blockIndex}): C√°c gi√° tr·ªã ƒë·ªôc l·∫≠p cho c·ªôt '${dependentColumn}':`, distinctValues);

            const selectElem = $('#filter-value-' + blockIndex);
            const currentValue = selectElem.val();
            selectElem.empty();
            distinctValues.forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
            });
            
            if (currentValue) {
                const validCurrentValues = currentValue.filter(v => distinctValues.includes(v));
                selectElem.val(validCurrentValues);
                console.log(`updateFilterValuesForBlock(${blockIndex}): ƒê√£ gi·ªØ l·∫°i c√°c gi√° tr·ªã hi·ªán t·∫°i h·ª£p l·ªá:`, validCurrentValues);
            }
            selectElem.trigger('change.select2');
            console.log(`updateFilterValuesForBlock(${blockIndex}): ƒê√£ ho√†n t·∫•t c·∫≠p nh·∫≠t dropdown.`);
        }

        function updateCascade(startBlock) {
            console.log(`updateCascade: B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t cascading t·ª´ kh·ªëi ${startBlock}.`);
            for (let i = startBlock; i <= 3; i++) {
                updateFilterValuesForBlock(i);
            }
            console.log(`updateCascade: ƒê√£ ho√†n t·∫•t c·∫≠p nh·∫≠t cascading.`);
        }

        function applyFilters(reset = true) {
            console.log(`applyFilters: ƒêang √°p d·ª•ng b·ªô l·ªçc. Reset: ${reset}.`);
            if (reset) {
                currentOffset = 0;
            }
            let queryParams = { limit: pageSize, offset: currentOffset };
            const projectFilterValues = $('#filter-project').val();
            if (projectFilterValues && projectFilterValues.length > 0) {
                queryParams["Customer"] = projectFilterValues.join(',');
            }

            for (let i = 1; i <= 3; i++) {
                const colSelect = $(`#filter-column-${i}`);
                const col = colSelect.val();
                const selectedOptionDataType = colSelect.find('option:selected').data('type');
                
                if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;    
                } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                        queryParams[col] = values.join(',');
                    }
                }
            }
            
            currentFilters = {...queryParams}; 
            console.log("applyFilters: Tham s·ªë truy v·∫•n g·ª≠i ƒë·∫øn server:", queryParams);
            
            showSpinner();
            $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                console.log("applyFilters: Ph·∫£n h·ªìi t·ª´ server:", response);
                totalData = response.total;
                currentOffset = reset ? response.data.length : currentOffset + response.data.length;
                updateTable(response.data, reset);
                if (!response.data || response.data.length === 0) {
                    showMessageBox("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p v·ªõi b·ªô l·ªçc hi·ªán t·∫°i.");
                    console.warn("applyFilters: D·ªØ li·ªáu tr·∫£ v·ªÅ tr·ªëng.");
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error("applyFilters: L·ªói khi t·∫£i d·ªØ li·ªáu t·ª´ /search:", textStatus, errorThrown, jqXHR);
                showMessageBox("L·ªói m·∫°ng ho·∫∑c server khi √°p d·ª•ng b·ªô l·ªçc. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.");
            }).always(function() {
                hideSpinner();
            });
        }

        // --- H√ÄM ƒê√ìNG V√Ä RESET POPUP (ƒê√É C√ì TRONG FILE G·ªêC, ƒê·∫¢M B·∫¢O N√ì ƒê∆Ø·ª¢C S·ª¨ D·ª§NG) ---
        function closeImagePopup() {
            imagePopup.hide().removeClass('zoomed');
            popupImg.off('load error').attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ·∫®n spinner khi ƒë√≥ng
            imagePopup.removeData('current-erp');
            imagePopup.removeData('current-part-number');
            imagePopup.removeData('thumbnail-url');
            imagePopup.removeData('high-quality-url');
            console.log("closeImagePopup: Popup ·∫£nh ƒë√£ ƒë√≥ng v√† reset.");
        }

function updateTable(data, reset) {
    console.log("updateTable: ƒêang c·∫≠p nh·∫≠t b·∫£ng. Reset:", reset, "D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:", data);
    const tbody = $('#results-table tbody');
    if (reset) tbody.empty();

    if (!data || data.length === 0) {
        console.log("updateTable: Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.");
        tbody.append('<tr><td colspan="31" style="text-align:center; padding:20px;">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ hi·ªÉn th·ªã.</td></tr>');
    }

    data.forEach(function(row) {
        const tr = $('<tr>');
        const partNumberValue = row['Part Number'] || 'N/A'; 

        // C·ªôt "No." - s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t l·∫°i sau khi s·∫Øp x·∫øp
        tr.append(`<td class="sticky-col-1"></td>`); 
        
        // C·ªôt "Part Number" v·ªõi kh·∫£ nƒÉng sao ch√©p
        const partNumberCell = $(`<td class="sticky-col-2"><span class="copyable-table-part-number" data-part-number="${partNumberValue}">${partNumberValue}</span></td>`);
        partNumberCell.css('cursor', 'pointer'); // Gi·ªØ nguy√™n style con tr·ªè

        // G·∫Øn s·ª± ki·ªán click cho √¥ Part Number ƒë·ªÉ m·ªü popup ·∫£nh
        partNumberCell.on('click', function(e) {
            // e.stopPropagation() is handled by the span click handler if it originates from the span
            const currentErpCode = row['ERP-CODE']?.trim().toUpperCase();
            const currentPartNumberValueFromRow = row['Part Number'] || 'N/A'; // L·∫•y tr·ª±c ti·∫øp t·ª´ row
            console.log("Part Number cell clicked. ERP:", currentErpCode, "PN:", currentPartNumberValueFromRow);

            // Reset tr·∫°ng th√°i popup
            imagePopup.removeClass('zoomed');
            popupImg.off('load error').attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ƒê·∫£m b·∫£o spinner ·∫©n ban ƒë·∫ßu

            // L∆∞u th√¥ng tin c·∫ßn thi·∫øt v√†o data c·ªßa popup
            imagePopup.data('current-erp', currentErpCode);
            imagePopup.data('current-part-number', currentPartNumberValueFromRow);

            if (currentErpCode) {
                const thumbnailUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_250,h_250,c_limit,f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;
                const highQualityUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;

                imagePopup.data('thumbnail-url', thumbnailUrl);
                imagePopup.data('high-quality-url', highQualityUrl);

                popupSpinner.show(); // Hi·ªÉn th·ªã spinner tr∆∞·ªõc khi t·∫£i
                popupImg.attr('src', thumbnailUrl); // B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh thumbnail
                console.log("ƒêang t·∫£i ·∫£nh thumbnail:", thumbnailUrl);

                // G·∫Øn l·∫°i s·ª± ki·ªán load v√† error
                popupImg.on('load', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    if (expectedErp && $(this).attr('src') && $(this).attr('src').includes(expectedErp)) {
                        popupSpinner.hide(); // ·∫®n spinner khi ·∫£nh t·∫£i xong
                        $(this).show();
                        popupText.hide().text('');
                        if (imagePopup.is(':hidden')) {
                            imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                        }
                        console.log("·∫¢nh thumbnail ƒë√£ t·∫£i xong.");
                    }
                });

                popupImg.on('error', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    const pn = imagePopup.data('current-part-number') || "N/A";
                    if (expectedErp && ($(this).attr('src') === '' || ($(this).attr('src') && $(this).attr('src').includes(expectedErp)))) {
                        popupSpinner.hide(); // ·∫®n spinner khi c√≥ l·ªói
                        $(this).hide();
                        popupText.text(`·∫¢nh cho Part Number "${pn}" (ERP: ${expectedErp}) kh√¥ng t·ªìn t·∫°i.`).show();
                        if (imagePopup.is(':hidden')) {
                            imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                        }
                        console.warn("L·ªói t·∫£i ·∫£nh. ERP:", expectedErp);
                    }
                });
                
                if (imagePopup.is(':hidden')) {
                     imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                }

            } else { // Kh√¥ng c√≥ ERP-CODE
                popupSpinner.hide();
                popupImg.hide();
                popupText.text(`Kh√¥ng c√≥ ·∫£nh cho Part Number "${currentPartNumberValueFromRow}". (Thi·∫øu ERP-CODE)`).show();
                imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                console.log("Kh√¥ng c√≥ ERP-CODE, kh√¥ng th·ªÉ t·∫£i ·∫£nh.");
            }
        });
        
        tr.append(partNumberCell);

        tr.append(`<td class="sticky-col-3">${row['REV'] || ''}</td>`);
        tr.append(`<td>${row['Approval Status'] || ''}</td>`);
        tr.append(`<td>${row['Customer'] || ''}</td>`);
        tr.append(`<td>${row['Commodity'] || ''}</td>`);
        tr.append(`<td>${row['Production Status'] || ''}</td>`);
        tr.append(`<td>${row['Part Pictures'] || ''}</td>`);
        tr.append(`<td>${row['Packaging Pictures'] || ''}</td>`);

        tr.append(`<td>${row['Critical'] || ''}</td>`);
        tr.append(`<td>${row['CE'] || ''}</td>`);
        tr.append(`<td>${row['PO Number'] || ''}</td>`);
        tr.append(`<td>${row['Description'] || ''}</td>`);
        tr.append(`<td>${row['ERP-CODE'] || ''}</td>`); 
        tr.append(`<td>${row['Note Number'] || ''}</td>`);
        tr.append(`<td>${formatExcelDate(row['PO received date'])}</td>`);
        tr.append(`<td>${formatExcelDate(row['Customer need date'])}</td>`);
        tr.append(`<td>${row['Requirements'] || ''}</td>`);
        tr.append(`<td>${row['FAIR Cover sheet'] || ''}</td>`);
        tr.append(`<td>${row['Bubble Drawings'] || ''}</td>`);
        tr.append(`<td>${row['Datasheet form'] || ''}</td>`);
        tr.append(`<td>${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
        tr.append(`<td>${row['FAIR Data'] || ''}</td>`);
        tr.append(`<td>${row['COC'] || ''}</td>`);
        tr.append(`<td>${row['BOM'] || ''}</td>`);
        tr.append(`<td>${row['Mill'] || ''}</td>`);
        tr.append(`<td>${row['Test reports / evidences'] || ''}</td>`);
        tr.append(`<td>${row['Remark 1'] || ''}</td>`);
        tr.append(`<td>${row['Remark 2'] || ''}</td>`);
        tr.append(`<td>${formatExcelDate(row['Submit date'])}</td>`);
        tr.append(`<td>${row['Reject comments'] || ''}</td>`);

        tbody.append(tr);
    });

    // Re-calculate and update "No." column after all rows are appended/updated
    tbody.children('tr').each(function(index) {
        $(this).find('td').eq(0).text(index + 1); // Update the first column (No.)
    });
    console.log("updateTable: ƒê√£ c·∫≠p nh·∫≠t s·ªë th·ª© t·ª± cho c√°c h√†ng.");

    var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
    $('#results-count').text(totalText);
    console.log("updateTable: ƒê√£ c·∫≠p nh·∫≠t t·ªïng s·ªë d√≤ng:", totalText);

    try {
        if ($.fn.colResizable) {
          $('#results-table').colResizable({ liveDrag: true, partialRefresh: true });
          console.log("updateTable: colResizable ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.");
        }
    } catch (e) {
        console.log("colResizable kh√¥ng kh·∫£ d·ª•ng trong updateTable:", e);
    }
}


        function downloadExcel() {
            const table = document.getElementById('results-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const dateColumns = ['PO received date', 'Customer need date', 'Submit date']; // Not used in this function, but kept for context

            const data = rows.map(tr => {
                const cells = Array.from(tr.querySelectorAll('td'));
                const rowObj = {};
                cells.forEach((td, index) => {
                    let val = td.textContent.trim();
                    const header = headers[index];
                    rowObj[header] = val;
                });
                return rowObj;
            });
            console.log("downloadExcel: D·ªØ li·ªáu ƒë·ªÉ xu·∫•t Excel:", data);

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, 'ketqua.xlsx');
            console.log("downloadExcel: ƒê√£ t·∫°o v√† t·∫£i file Excel 'ketqua.xlsx'.");
        }

        function getColumnIndex(columnName) {
          let index = -1;
          $('#results-table th').each(function(i) {
            if ($(this).data('column') === columnName) {
              index = i;
              return false;
            }
          });
          console.log(`getColumnIndex: C·ªôt '${columnName}' c√≥ ch·ªâ m·ª•c: ${index}`);
          return index;
        }
        function sortTable(column, order) {
          console.log(`sortTable: ƒêang s·∫Øp x·∫øp c·ªôt '${column}' theo th·ª© t·ª± '${order}'.`);
          let rows = $('#results-table tbody tr').get();
          let colIndex = getColumnIndex(column);
          if (colIndex === -1) {
              console.warn(`sortTable: Kh√¥ng t√¨m th·∫•y ch·ªâ m·ª•c cho c·ªôt '${column}'.`);
              return;
          }

          const isDateColumn = ['PO received date', 'Customer need date', 'Submit date'].includes(column);

          rows.sort(function(a, b) {
            let valA = $(a).children('td').eq(colIndex).text().toUpperCase();
            let valB = $(b).children('td').eq(colIndex).text().toUpperCase();

            if (isDateColumn) {
                const dateA = new Date(valA);
                const dateB = new Date(valB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                }
            }
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });
          
          // Re-append sorted rows and update "No." column
          const tbody = $('#results-table tbody');
          tbody.empty(); // Clear existing rows
          $.each(rows, function(index, row) {
            tbody.append(row);
            // Update the "No." column for the re-appended row
            $(row).find('td').eq(0).text(index + 1); 
          });
          console.log("sortTable: ƒê√£ s·∫Øp x·∫øp v√† c·∫≠p nh·∫≠t s·ªë th·ª© t·ª±.");
        }
        $(document).on('click', '#results-table th', function () {
            const col = $(this).data('column');
            console.log("Header clicked. Column:", col);
            if (!col || col === 'No') { // Prevent sorting by "No." column
                console.log("Kh√¥ng s·∫Øp x·∫øp c·ªôt 'No' ho·∫∑c c·ªôt kh√¥ng c√≥ data-column.");
                return; 
            }

            const currentOrder = $(this).data('order') || 'asc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            console.log(`S·∫Øp x·∫øp: C·ªôt '${col}', Th·ª© t·ª± c≈©: '${currentOrder}', Th·ª© t·ª± m·ªõi: '${newOrder}'.`);

            $('#results-table th').each(function () {
                $(this).data('order', null);
                const text = $(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim();
                $(this).text(text);
            });

            const arrow = newOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
            $(this).text($(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim() + arrow);
            $(this).data('order', newOrder);

            sortTable(col, newOrder);
        });
    </script>
    <div id="cameraModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:9999; overflow-y:auto; transition: all 0.3s ease;">
        <div style="background:#fff; padding:16px; border-radius:8px; width:95%; max-width:400px; text-align:center; margin-bottom: 10vh;">
            <h3>üì∑ Qu√©t Part Number</h3>
            <div style="position: relative; width: 100%; max-height:240px;">
                <video id="camera" playsinline autoplay style="width:100%; max-height:240px; object-fit:cover; border-radius:6px;"></video>
                <div id="ocrGuideBox" style="position: absolute; border: 2px solid red; top: 35%; left: 10%; width: 80%; height: 20%; box-sizing: border-box; pointer-events: none;"></div>
            </div>
            <div id="zoomContainer" style="display:none; margin:10px auto; text-align:center;">
              üîç Zoom:
              <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1" style="width:80%;"/>
            </div>
            <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px;">
                <button id="btnCapture" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">üì∏ Ch·ª•p &amp; Qu√©t</button>
                <button id="btnApplyOcrFilter" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">‚úÖ L·ªçc</button>
                <button id="btnCloseCamera" style="padding:10px 14px; font-size:14px; flex:1 0 40%;">‚ùå ƒê√≥ng</button>
            </div>
            <input id="ocrInput" type="text" placeholder="K·∫øt qu·∫£ OCR..." style="margin-top:10px; width:100%; padding:8px; font-size:14px;"/>
            <p id="ocrStatus" style="font-size:14px; margin-top:10px; margin-bottom: 20px; display: block;">ƒêang ch·ªù thao t√°c...</p>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const btnScan = document.getElementById('btnScanCamera');
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const statusP = document.getElementById('ocrStatus');
      let inputOCR = document.getElementById('ocrInput');
      const btnCapture = document.getElementById('btnCapture');
      const btnClose = document.getElementById('btnCloseCamera');
      const btnApply = document.getElementById('btnApplyOcrFilter');
      const zoomSlider = document.getElementById("zoomSlider");
      const zoomContainer = document.getElementById("zoomContainer");
      let stream, intervalId;

      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          video.srcObject = null;
        }
        clearInterval(intervalId);
        console.log("Camera: ƒê√£ d·ª´ng stream.");
      }

      function cropCenterAndOCR(callback) {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const cropWidth = canvas.width * 0.8;
        const cropHeight = canvas.height * 0.2;
        const offsetX = canvas.width * 0.1;
        const offsetY = canvas.height * 0.35;
        const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = cropWidth;
        tempCanvas.height = cropHeight;
        tempCanvas.getContext("2d").putImageData(imageData, 0, 0);
        console.log("Camera: ƒê√£ ch·ª•p v√† c·∫Øt ·∫£nh ƒë·ªÉ OCR.");

        Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
          .then(({ data: { text } }) => {
            console.log("OCR: K·∫øt qu·∫£ nh·∫≠n di·ªán:", text);
            callback(text);
          })
          .catch((err) => {
            statusP.textContent = '‚ùå L·ªói khi nh·∫≠n di·ªán.';
            console.error("OCR: L·ªói nh·∫≠n di·ªán:", err);
          });
      }

      btnScan.addEventListener('click', async () => {
        modal.style.display = 'flex';
        statusP.textContent = 'üîÑ ƒêang kh·ªüi ƒë·ªông camera...';
        inputOCR.value = '';
        document.getElementById("ocrInput").style.display = 'block';
        console.log("Camera: ƒêang y√™u c·∫ßu truy c·∫≠p camera.");
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
          video.play();

          const track = stream.getVideoTracks()[0];
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            zoomContainer.style.display = 'block';
            zoomSlider.min = capabilities.zoom.min;
            zoomSlider.max = capabilities.zoom.max;
            zoomSlider.step = capabilities.zoom.step || 0.1;
            zoomSlider.value = capabilities.zoom.min;
            zoomSlider.addEventListener("input", () => {
              track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
              console.log("Camera: ƒê√£ thay ƒë·ªïi zoom:", zoomSlider.value);
            });
            console.log("Camera: Ch·ª©c nƒÉng zoom kh·∫£ d·ª•ng.");
          }
          statusP.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi camera. Nh·∫•n "Ch·ª•p & Qu√©t" ho·∫∑c gi·ªØ ch·∫ø ƒë·ªô t·ª± ƒë·ªông';
          console.log("Camera: ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng.");
        } catch (err) {
          statusP.textContent = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera.';
          console.error("Camera: L·ªói truy c·∫≠p camera:", err);
        }
      });

      btnCapture.addEventListener('click', () => {
        statusP.textContent = 'üîç ƒêang qu√©t...';
        console.log("Camera: N√∫t 'Ch·ª•p & Qu√©t' ƒë√£ ƒë∆∞·ª£c nh·∫•n.");
        cropCenterAndOCR((text) => {
          const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
          if (lines.length === 0) {
            statusP.textContent = '‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d√≤ng n√†o.';
            console.warn("OCR: Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c vƒÉn b·∫£n.");
            return;
          }

          if (lines.length === 1) {
            inputOCR.value = lines[0];
            statusP.textContent = '‚úÖ ƒê√£ nh·∫≠n 1 d√≤ng.';
            console.log("OCR: ƒê√£ nh·∫≠n di·ªán 1 d√≤ng:", lines[0]);
          } else {
            const selectorId = 'ocrLineSelector';
            // Remove existing selector if any
            document.getElementById(selectorId)?.remove();

            const selectHTML = `
              <select id="${selectorId}" style="width:100%; padding:8px; font-size:14px; margin-top:10px;">
                ${lines.map(l => `<option>${l}</option>`).join('')}
              </select>
            `;
            inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
            const selector = document.getElementById(selectorId);
            selector.addEventListener('change', () => {
              inputOCR.value = selector.value;
              console.log("OCR: ƒê√£ ch·ªçn d√≤ng m·ªõi:", selector.value);
            });
            inputOCR.value = lines[0];
            statusP.textContent = `‚úÖ ƒê√£ nh·∫≠n ${lines.length} d√≤ng. ƒê√£ ch·ªçn d√≤ng ƒë·∫ßu ti√™n, c√≥ th·ªÉ ch·ªânh s·ª≠a.`;
            console.log("OCR: ƒê√£ nh·∫≠n di·ªán nhi·ªÅu d√≤ng. D√≤ng ƒë·∫ßu ti√™n:", lines[0]);
          }
        });
      });

      btnApply.addEventListener('click', () => {
        const part = inputOCR.value.trim();
        console.log("Camera: N√∫t 'L·ªçc' ƒë√£ ƒë∆∞·ª£c nh·∫•n. Part Number:", part);
        if (!part) {
            showMessageBox('B·∫°n ch∆∞a nh·∫≠p Part Number!'); 
            console.warn("Camera: Part Number tr·ªëng, kh√¥ng th·ªÉ l·ªçc.");
            return;
        }
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => { 
            $('#filter-value-1').val([part]).trigger('change'); 
            if (typeof applyFilters === 'function') {
                applyFilters(true);
                console.log("Camera: ƒê√£ g·ªçi applyFilters.");
            } else {
                console.warn("Camera: applyFilters function is not defined.");
            }
            statusP.textContent = `‚úÖ ƒê√£ l·ªçc v·ªõi Part Number: ${part}`;
            saveSearchHistory(part);
            setTimeout(() => btnClose.click(), 1500);
        }, 50); 
      });

      btnClose.addEventListener('click', () => {
        modal.style.display = 'none';
        zoomContainer.style.display = 'none';
        stopStream();
        document.getElementById("ocrLineSelector")?.remove();
        inputOCR.value = '';
        console.log("Camera: Modal ƒë√£ ƒë√≥ng.");
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const activeEl = document.activeElement;
      if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        setTimeout(() => {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const ocrInput = document.getElementById('ocrInput');
      if (ocrInput) {
        ocrInput.addEventListener('focus', () => {
          setTimeout(() => {
            ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('ocrInput');
      if (input) {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const inputs = document.querySelectorAll('.filter-bar input, .filter-bar select');
      inputs.forEach((input) => {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    });
    </script>
    <script>
    function showSpinner() {
      $('#loading-spinner').show();
      console.log("Spinner: Hi·ªÉn th·ªã.");
    }
    function hideSpinner() {
      $('#loading-spinner').hide();
      console.log("Spinner: ·∫®n.");
    }

    $('#quick-search').on('input', function () {
      const keyword = $(this).val().toLowerCase();
      console.log("Quick Search: T·ª´ kh√≥a:", keyword);
      $('#results-table tbody tr').each(function () {
        const partNumber = $(this).find('td:nth-child(2)').text().toLowerCase(); 
        $(this).toggle(partNumber.includes(keyword));
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const topContainer = document.querySelector('.top-container');
      const tableContainer = document.querySelector('.table-container');
      const quickSearch = document.getElementById('quick-search');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');

      let wasEditingTop = false;

      document.addEventListener('focusin', (e) => {
          if (window.innerWidth >= 768) return;
        const target = e.target;
        if (topContainer.contains(target) && ['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) {
          wasEditingTop = true;
          topContainer.classList.add('full-top-container');
          topContainer.classList.remove('hide-top-container');
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'none';
          console.log("Responsive UI: ƒê√£ t·∫≠p trung v√†o input/select trong top-container. ·∫®n quick search.");
        } else if (target === quickSearch) {
          topContainer.classList.add('hide-top-container');
          tableContainer.classList.add('show-table-only');
          console.log("Responsive UI: ƒê√£ t·∫≠p trung v√†o quick search. ·∫®n top-container.");
        }
      });

      document.addEventListener('focusout', () => {
            if (window.innerWidth >= 768) return;
        setTimeout(() => {
          const active = document.activeElement;
          if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(active.tagName)) {
            if (wasEditingTop) {
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'none';
              console.log("Responsive UI: ƒê√£ tho√°t kh·ªèi input/select trong top-container. Gi·ªØ quick search ·∫©n.");
            } else {
              topContainer.classList.remove('full-top-container', 'hide-top-container');
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'block';
              console.log("Responsive UI: ƒê√£ tho√°t kh·ªèi quick search. Hi·ªÉn th·ªã l·∫°i top-container v√† quick search.");
            }
          }
        }, 300);
      });

      function revealTableAndSearch() {
        wasEditingTop = false;
        topContainer.classList.remove('full-top-container', 'hide-top-container');
        quickSearch.style.display = 'block';
        tableContainer.classList.remove('show-table-only');
        console.log("Responsive UI: ƒê√£ hi·ªÉn th·ªã l·∫°i b·∫£ng v√† quick search.");
      }

      applyBtn?.addEventListener('click', revealTableAndSearch);
      clearBtn?.addEventListener('click', revealTableAndSearch);
    });
    </script>
    <button onclick="toggleHistoryPopup()" style="position: fixed; bottom: 20px; left: 20px; background: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; font-size: 20px; cursor: pointer; z-index: 9999;" title="L·ªãch s·ª≠ t√¨m ki·∫øm">üïò</button>
    <div id="floating-history-popup" style="display: none; position: fixed; bottom: 80px; left: 20px; background: rgba(30,30,30,0.95); color: white; padding: 16px; border-radius: 12px; width: 300px; max-height: 360px; overflow-y: auto; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 9999;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h4 style="margin: 0;">üìú L·ªãch s·ª≠ t√¨m ki·∫øm</h4>
            <button onclick="toggleHistoryPopup()" style="background: transparent; color: white; border: none; font-size: 20px; cursor: pointer;">√ó</button>
        </div>
        <ul id="searchHistory" style="list-style: none; padding-left: 0; margin: 12px 0;"></ul>
        <button onclick="clearSearchHistory()" style="margin-top: 8px; background:#cc4444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width:100%;">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
    </div>

    <a href="/voice_search" style="position: fixed; bottom: 20px; right: 20px; background: #0066ff; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999;" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
      üé§
    </a>

    <script>
      function saveSearchHistory(partNumber) {
        if (!partNumber) return;
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const now = new Date().toLocaleString("vi-VN");
        const existingIndex = history.findIndex(item => item.partNumber === partNumber);
        if (existingIndex > -1) {
            history.splice(existingIndex, 1);
        }
        history.unshift({ partNumber, time: now });
        if (history.length > 30) history.pop();
        localStorage.setItem("partSearchHistory", JSON.stringify(history));
        renderSearchHistory();
        console.log("L·ªãch s·ª≠ t√¨m ki·∫øm: ƒê√£ l∆∞u Part Number:", partNumber);
      }

      function renderSearchHistory() {
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const list = document.getElementById("searchHistory");
        if (!list) return;
        list.innerHTML = "";
        if (history.length === 0) {
            list.innerHTML = '<li style="text-align: center; color: #aaa;">Ch∆∞a c√≥ l·ªãch s·ª≠ tra c·ª©u.</li>';
        }
        history.forEach(item => {
          const li = document.createElement("li");
          li.style.marginBottom = "6px";
          li.innerHTML = `<button onclick="quickSearchFromHistory('${item.partNumber.replace(/'/g, "\\'")}')" title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" style="background:#444; color:white; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; width: calc(100% - 70px); text-align:left; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${item.partNumber}</button> <small style="color:#ccc; font-size: 10px;">(${item.time.split(',')[0]})</small>`;
          list.appendChild(li);
        });
        console.log("L·ªãch s·ª≠ t√¨m ki·∫øm: ƒê√£ render l·∫°i l·ªãch s·ª≠.");
      }

      function quickSearchFromHistory(partNumber) {
        console.log("L·ªãch s·ª≠ t√¨m ki·∫øm: ƒêang tra c·ª©u nhanh t·ª´ l·ªãch s·ª≠:", partNumber);
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => {
            $('#filter-value-1').val([partNumber]).trigger('change');
            applyFilters(true);
            toggleHistoryPopup(); 
            navigator.clipboard.writeText(partNumber).then(() => {
                showMessageBox('ƒê√£ sao ch√©p t·ª´ l·ªãch s·ª≠: ' + partNumber);
                console.log('L·ªãch s·ª≠ t√¨m ki·∫øm: ƒê√£ sao ch√©p t·ª´ l·ªãch s·ª≠ th√†nh c√¥ng: ' + partNumber);
            }).catch(err => {
                console.error('L·ªãch s·ª≠ t√¨m ki·∫øm: Kh√¥ng th·ªÉ sao ch√©p t·ª´ l·ªãch s·ª≠:', err);
                showMessageBox('Kh√¥ng th·ªÉ sao ch√©p t·ª´ l·ªãch s·ª≠. Vui l√≤ng sao ch√©p th·ªß c√¥ng: ' + partNumber);
            });
        }, 50);
      }

      function clearSearchHistory() {
        localStorage.removeItem("partSearchHistory");
        renderSearchHistory();
        showMessageBox('ƒê√£ x√≥a l·ªãch s·ª≠ tra c·ª©u.'); 
        console.log("L·ªãch s·ª≠ t√¨m ki·∫øm: ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠.");
      }
      
      function toggleHistoryPopup() {
          const popup = document.getElementById("floating-history-popup");
          if (popup) {
            const isOpen = popup.style.display === "block";
            popup.style.display = isOpen ? "none" : "block";
            if (!isOpen) {
              renderSearchHistory();
            }
            console.log("L·ªãch s·ª≠ t√¨m ki·∫øm: ƒê√£ b·∫≠t/t·∫Øt popup l·ªãch s·ª≠. Tr·∫°ng th√°i:", popup.style.display);
          }
      }
      window.addEventListener("DOMContentLoaded", renderSearchHistory);
    </script>
</body>
</html>
