<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"> <style>
        /* ƒêo·∫°n CSS responsive m√°y t√≠nh */
        @media (min-width: 768px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }

            body {
                overflow-y: auto;
            }

            input, select, textarea {
                touch-action: manipulation;
                -webkit-user-select: text;
                user-select: text;
                caret-color: auto;
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                box-shadow: none;
            }
        }
        /* C√†i ƒë·∫∑t CSS c∆° b·∫£n */
        html {line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}
        /* Th√™m ƒëo·∫°n CSS c·ªßa Tailwind CSS */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        /* CƒÉn gi·ªØa popup l·ªãch s·ª≠ t√¨m ki·∫øm */
        #floating-history-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }

        /* Hi·ªáu ·ª©ng m·ªù n·ªÅn khi popup hi·ªán ra */
        #floating-history-popup.show {
            display: block;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .select2-container .select2-selection--single {
            height: 40px !important; /* Adjust as needed */
            display: flex;
            align-items: center;
            border-radius: 6px;
            border: 1px solid #4a4a4a !important;
            background-color: #333 !important;
            color: white !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: white !important; /* Text color */
            line-height: 40px; /* Vertically align text */
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: white transparent transparent transparent !important; /* Arrow color */
        }

        .select2-dropdown {
            background-color: #333 !important;
            border: 1px solid #4a4a4a !important;
        }

        .select2-results__option {
            color: white !important;
        }

        .select2-results__option--highlighted {
            background-color: #007bff !important;
            color: white !important;
        }

        .select2-search__field {
            background-color: #4a4a4a !important;
            color: white !important;
            border: 1px solid #666 !important;
        }

        /* ·∫®n input t√¨m ki·∫øm v√† datepicker */
        .search-input-group, .date-input-group {
            display: none;
        }
        /* Hi·ªÉn th·ªã input t√¨m ki·∫øm m·∫∑c ƒë·ªãnh */
        .search-input-group.active, .date-input-group.active {
            display: block;
        }

        /* Custom Flatpickr styles to match dark theme */
        .flatpickr-calendar {
            background-color: #333; /* Dark background */
            border: 1px solid #555;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: #eee; /* Light text */
        }
        .flatpickr-day.selected, .flatpickr-day.selected:hover {
            background-color: #007bff; /* Highlight color */
            border-color: #007bff;
            color: white;
        }
        .flatpickr-day.start-date, .flatpickr-day.end-date {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .flatpickr-day.in-range {
            background-color: rgba(0, 123, 255, 0.2); /* Lighter blue for range */
            border-color: rgba(0, 123, 255, 0.2);
        }
        .flatpickr-day.today {
            border-color: #007bff;
        }
        .flatpickr-day:hover {
            background-color: #555; /* Hover color */
        }
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: #eee; /* Arrows color */
        }
        .flatpickr-current-month .flatpickr-month,
        .flatpickr-current-month .flatpickr-year {
            color: #eee;
        }
        .numInputWrapper {
            color: #eee; /* Year/month input color */
        }
        .flatpickr-weekdays {
            background-color: #444;
            color: #ccc;
        }
        .flatpickr-weekday {
            color: #ccc;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col justify-center items-center p-4">
<div class="w-full max-w-4xl bg-gray-800 p-6 rounded-lg shadow-lg">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-center text-blue-400" data-i18n="title">Tra c·ª©u Part Number</h1>
        <div class="flex items-center space-x-2">
            <button class="bg-gray-600 text-white px-3 py-1 rounded-md" id="lang-vi">VI</button>
            <button class="bg-gray-600 text-white px-3 py-1 rounded-md" id="lang-en">EN</button>
        </div>
    </div>

    <form id="search-form" class="mb-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-400 text-sm font-bold mb-2" for="filter-select" data-i18n="filterLabel">
                    L·ªçc theo:
                </label>
                <select class="shadow border border-gray-700 rounded w-full py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="filter-select">
                    <option value="Part Number" data-i18n="partNumberOption">Part Number</option>
                    <option value="Description" data-i18n="descriptionOption">Description</option>
                    <option value="Customer" data-i18n="customerOption">Customer</option>
                    <option value="Commodity" data-i18n="commodityOption">Commodity</option>
                    <option value="PO Number" data-i18n="poNumberOption">PO Number</option>
                    <option value="PO received date" data-i18n="poReceivedDateOption">PO received date</option> <option value="Customer need date" data-i18n="customerNeedDateOption">Customer need date</option> <option value="Approval Status" data-i18n="approvalStatusOption">Approval Status</option>
                    <option value="Production Status" data-i18n="productionStatusOption">Production Status</option>
                    <option value="ERP-CODE" data-i18n="erpCodeOption">ERP-CODE</option>
                </select>
            </div>
            <div id="text-search-group" class="search-input-group active">
                <label class="block text-gray-400 text-sm font-bold mb-2" for="search-input" data-i18n="partNumberLabel">
                    Nh·∫≠p gi√° tr·ªã:
                </label>
                <input autocomplete="off" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="search-input" type="text"/>
            </div>
            <div id="date-search-group" class="date-input-group">
                <label class="block text-gray-400 text-sm font-bold mb-2" data-i18n="dateRangeLabel">
                    Ch·ªçn kho·∫£ng ng√†y:
                </label>
                <div class="flex space-x-2">
                    <input class="shadow appearance-none border border-gray-700 rounded w-1/2 py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700 flatpickr" id="date-start" type="text" placeholder="T·ª´ ng√†y"/>
                    <input class="shadow appearance-none border border-gray-700 rounded w-1/2 py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700 flatpickr" id="date-end" type="text" placeholder="ƒê·∫øn ng√†y"/>
                </div>
            </div>
        </div>
        <div class="flex justify-center space-x-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="searchButton" type="submit">
                T√¨m ki·∫øm
            </button>
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="viewAllButton" id="view-all-btn" type="button">
                Xem t·∫•t c·∫£
            </button>
            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="historyButton" id="toggle-history-btn" type="button">
                L·ªãch s·ª≠
            </button>
        </div>
    </form>

    <div class="mb-4">
        <label class="block text-gray-400 text-sm font-bold mb-2" for="entries-per-page" data-i18n="showEntriesLabel">
            Hi·ªÉn th·ªã:
        </label>
        <select class="shadow border border-gray-700 rounded py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="entries-per-page">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <div class="overflow-x-auto bg-gray-700 rounded-lg shadow">
        <table class="min-w-full leading-normal">
            <thead>
            <tr>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="flex justify-between items-center mt-4">
        <span class="text-gray-400" id="pagination-info"></span>
        <div class="flex space-x-2">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="prev-page" disabled>Tr∆∞·ªõc</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="next-page" disabled>Ti·∫øp</button>
        </div>
    </div>
</div>

<div id="overlay"></div>
<div id="floating-history-popup">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" data-i18n="searchHistoryTitle">L·ªãch s·ª≠ T√¨m ki·∫øm</h2>
        <button class="text-gray-400 hover:text-white" id="close-history-popup">‚úñ</button>
    </div>
    <div id="history-list" class="space-y-2">
        </div>
    <div class="mt-4 text-right">
        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" data-i18n="clearHistoryButton" id="clear-history-btn">
            X√≥a l·ªãch s·ª≠
        </button>
    </div>
</div>

<a href="voice_search.html" style="position: fixed; bottom: 20px; right: 20px; background-color: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999;" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
    üé§
</a>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script> <script>
    // i18next configuration
    i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
            fallbackLng: 'vi',
            debug: true,
            resources: {
                en: {
                    translation: {
                        title: "Part Number Lookup",
                        partNumberLabel: "Enter Value:",
                        filterLabel: "Filter by:",
                        partNumberOption: "Part Number",
                        descriptionOption: "Description",
                        customerOption: "Customer",
                        commodityOption: "Commodity",
                        poNumberOption: "PO Number",
                        poReceivedDateOption: "PO Received Date",
                        customerNeedDateOption: "Customer Need Date",
                        approvalStatusOption: "Approval Status",
                        productionStatusOption: "Production Status",
                        erpCodeOption: "ERP-CODE",
                        searchButton: "Search",
                        viewAllButton: "View All",
                        historyButton: "History",
                        showEntriesLabel: "Show entries:",
                        searchHistoryTitle: "Search History",
                        clearHistoryButton: "Clear History",
                        dateRangeLabel: "Select Date Range:",
                        // Add other translations as needed
                    }
                },
                vi: {
                    translation: {
                        title: "Tra c·ª©u Part Number",
                        partNumberLabel: "Nh·∫≠p gi√° tr·ªã:",
                        filterLabel: "L·ªçc theo:",
                        partNumberOption: "Part Number",
                        descriptionOption: "Description",
                        customerOption: "Customer",
                        commodityOption: "Commodity",
                        poNumberOption: "PO Number",
                        poReceivedDateOption: "Ng√†y nh·∫≠n PO",
                        customerNeedDateOption: "Ng√†y kh√°ch c·∫ßn",
                        approvalStatusOption: "Tr·∫°ng th√°i ph√™ duy·ªát",
                        productionStatusOption: "Tr·∫°ng th√°i s·∫£n xu·∫•t",
                        erpCodeOption: "ERP-CODE",
                        searchButton: "T√¨m ki·∫øm",
                        viewAllButton: "Xem t·∫•t c·∫£",
                        historyButton: "L·ªãch s·ª≠",
                        showEntriesLabel: "Hi·ªÉn th·ªã:",
                        searchHistoryTitle: "L·ªãch s·ª≠ T√¨m ki·∫øm",
                        clearHistoryButton: "X√≥a l·ªãch s·ª≠",
                        dateRangeLabel: "Ch·ªçn kho·∫£ng ng√†y:",
                        // Add other translations as needed
                    }
                }
            }
        }, function (err, t) {
            updateContent();
        });

    function updateContent() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            element.textContent = i18next.t(element.dataset.i18n);
        });
        document.getElementById('date-start').placeholder = i18next.t('T·ª´ ng√†y');
        document.getElementById('date-end').placeholder = i18next.t('ƒê·∫øn ng√†y');
    }

    document.getElementById('lang-vi').addEventListener('click', () => {
        i18next.changeLanguage('vi').then(updateContent);
    });

    document.getElementById('lang-en').addEventListener('click', () => {
        i18next.changeLanguage('en').then(updateContent);
    });

    // Global variables
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let entriesPerPage = parseInt(document.getElementById('entries-per-page').value);
    let myFlatpickrStart, myFlatpickrEnd; // Bi·∫øn l∆∞u instance c·ªßa flatpickr

    // Date fields that should trigger date range picker
    const dateFields = ["PO received date", "Customer need date"];

    // Function to initialize Flatpickr
    function initializeFlatpickr() {
        myFlatpickrStart = flatpickr("#date-start", {
            dateFormat: "Y-m-d",
            locale: i18next.language, // Use current i18next language
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0 && myFlatpickrEnd) {
                    myFlatpickrEnd.set("minDate", selectedDates[0]);
                }
            }
        });
        myFlatpickrEnd = flatpickr("#date-end", {
            dateFormat: "Y-m-d",
            locale: i18next.language, // Use current i18next language
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0 && myFlatpickrStart) {
                    myFlatpickrStart.set("maxDate", selectedDates[0]);
                }
            }
        });
    }


    // Function to toggle input field based on filter selection
    function toggleInputField() {
        const filterSelect = document.getElementById('filter-select');
        const searchInputGroup = document.getElementById('text-search-group');
        const dateInputGroup = document.getElementById('date-search-group');
        const searchInput = document.getElementById('search-input');
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');

        if (dateFields.includes(filterSelect.value)) {
            searchInputGroup.classList.remove('active');
            dateInputGroup.classList.add('active');
            searchInput.value = ''; // Clear text input
            // Clear date inputs
            if (myFlatpickrStart) myFlatpickrStart.clear();
            if (myFlatpickrEnd) myFlatpickrEnd.clear();
        } else {
            searchInputGroup.classList.add('active');
            dateInputGroup.classList.remove('active');
            dateStartInput.value = ''; // Clear date inputs
            dateEndInput.value = '';
        }
    }

    // Event listener for filter select change
    document.getElementById('filter-select').addEventListener('change', toggleInputField);

    // Fetch data from server
    async function fetchData() {
        try {
            const response = await fetch('/api/data'); // S·ª≠ d·ª•ng API endpoint t·ª´ server.js
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allData = data; // Store all data
            filteredData = allData; // Initially, all data is filtered
            renderTable();
        } catch (error) {
            console.error('Error fetching data:', error);
            document.getElementById('results-table').innerHTML = '<p class="text-red-400">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>';
        }
    }

    // Render table headers
    function renderTableHeaders(headers) {
        const thead = document.querySelector('table thead tr');
        thead.innerHTML = ''; // Clear existing headers
        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = 'px-5 py-3 border-b-2 border-gray-600 bg-gray-600 text-left text-xs font-semibold text-gray-200 uppercase tracking-wider';
            th.textContent = header;
            thead.appendChild(th);
        });
    }

    // Render table data for current page
    function renderTable() {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = ''; // Clear existing data

        const startIndex = (currentPage - 1) * entriesPerPage;
        const endIndex = startIndex + entriesPerPage;
        const dataToDisplay = filteredData.slice(startIndex, endIndex);

        if (filteredData.length > 0) {
            const headers = Object.keys(filteredData[0]); // Get headers from the first item
            renderTableHeaders(headers);

            dataToDisplay.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-600'; // Add hover effect
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-5 py-5 border-b border-gray-600 text-sm';
                    let cellValue = item[header];

                    // Handle date fields: Convert Excel serial date to YYYY-MM-DD
                    if (dateFields.includes(header) && typeof cellValue === 'number' && cellValue > 0) {
                        cellValue = excelSerialDateToJSDate(cellValue).toISOString().slice(0, 10);
                    }

                    td.textContent = cellValue;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        } else {
            renderTableHeaders([]); // Clear headers if no data
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 99; // Span across all potential columns
            td.className = 'px-5 py-5 text-center text-gray-400';
            td.textContent = 'Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.';
            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        updatePaginationInfo();
        updatePaginationButtons();
    }

    // Convert Excel serial date to JavaScript Date object
    function excelSerialDateToJSDate(serial) {
        const utc_days = Math.floor(serial - 25569);
        const utc_value = utc_days * 86400; // 86400 seconds in a day
        const date_info = new Date(utc_value * 1000);
        return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
    }

    // Update pagination info (e.g., "Showing 1 to 10 of 100 entries")
    function updatePaginationInfo() {
        const totalEntries = filteredData.length;
        const startIndex = (currentPage - 1) * entriesPerPage + 1;
        const endIndex = Math.min(startIndex + entriesPerPage - 1, totalEntries);
        const paginationInfo = document.getElementById('pagination-info');
        paginationInfo.textContent = `Hi·ªÉn th·ªã ${startIndex} ƒë·∫øn ${endIndex} c·ªßa ${totalEntries} m·ª•c`;
    }

    // Update pagination buttons (enable/disable)
    function updatePaginationButtons() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const totalPages = Math.ceil(filteredData.length / entriesPerPage);

        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Event listeners for pagination
    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredData.length / entriesPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Event listener for entries per page change
    document.getElementById('entries-per-page').addEventListener('change', (event) => {
        entriesPerPage = parseInt(event.target.value);
        currentPage = 1; // Reset to first page
        renderTable();
    });

    // Handle search form submission
    document.getElementById('search-form').addEventListener('submit', async function (event) {
        event.preventDefault();
        const searchInput = document.getElementById('search-input');
        const filterSelect = document.getElementById('filter-select');
        const searchTerm = searchInput.value.trim();
        const filterBy = filterSelect.value;
        const dateStart = document.getElementById('date-start').value;
        const dateEnd = document.getElementById('date-end').value;

        // Save search to history (only for actual search)
        if (searchTerm || (dateStart && dateEnd && dateFields.includes(filterBy))) {
            let historyItem = `${filterBy}: `;
            if (dateFields.includes(filterBy)) {
                historyItem += `${dateStart} - ${dateEnd}`;
            } else {
                historyItem += searchTerm;
            }
            saveSearchHistory(historyItem);
        }

        try {
            let url = `/api/search?filterBy=${encodeURIComponent(filterBy)}`;
            if (dateFields.includes(filterBy)) {
                if (dateStart) url += `&startDate=${encodeURIComponent(dateStart)}`;
                if (dateEnd) url += `&endDate=${encodeURIComponent(dateEnd)}`;
            } else {
                if (searchTerm) url += `&searchTerm=${encodeURIComponent(searchTerm)}`;
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            filteredData = data.data; // Server now sends data in a 'data' property
            currentPage = 1; // Reset page
            renderTable();
        } catch (error) {
            console.error('Error during search:', error);
            alert('ƒê√£ c√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    });


    // "View All" button functionality
    document.getElementById('view-all-btn').addEventListener('click', async () => {
        try {
            const response = await fetch('/api/data'); // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allData = data;
            filteredData = allData;
            currentPage = 1;
            renderTable();
        } catch (error) {
            console.error('Error viewing all data:', error);
            alert('Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    });

    // History Popup functions
    function toggleHistoryPopup() {
        const popup = document.getElementById("floating-history-popup");
        const overlay = document.getElementById("overlay");
        const isOpen = popup.classList.contains("show");

        if (isOpen) {
            popup.classList.remove("show");
            overlay.style.display = "none";
        } else {
            renderHistory(); // C·∫≠p nh·∫≠t l·ªãch s·ª≠ tr∆∞·ªõc khi hi·ªÉn th·ªã
            popup.classList.add("show");
            overlay.style.display = "block";
        }
    }

    document.getElementById("toggle-history-btn").addEventListener("click", toggleHistoryPopup);
    document.getElementById("close-history-popup").addEventListener("click", toggleHistoryPopup);
    document.getElementById("overlay").addEventListener("click", toggleHistoryPopup); // ƒê√≥ng popup khi click ra ngo√†i

    function saveSearchHistory(searchQuery) {
        let storedHistory = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");

        // Remove if already exists to move to top
        storedHistory = storedHistory.filter(item => item !== searchQuery);

        // Add new query to the beginning
        storedHistory.unshift(searchQuery);

        // Keep only the latest 10 items
        if (storedHistory.length > 10) {
            storedHistory = storedHistory.slice(0, 10);
        }

        localStorage.setItem("partSearchHistory", JSON.stringify(storedHistory));
        renderHistory(); // Re-render history list
    }

    function renderHistory() {
        const historyList = document.getElementById("history-list");
        historyList.innerHTML = ''; // Clear existing history
        const storedHistory = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");

        if (storedHistory.length > 0) {
            storedHistory.forEach(item => {
                const div = document.createElement("div");
                div.className = "text-white px-3 py-1 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 truncate";
                div.textContent = "üîç " + item;
                div.onclick = () => {
                    // Populate search fields and perform search
                    const [filterBy, value] = item.split(': ').map(s => s.trim());
                    document.getElementById('filter-select').value = filterBy;
                    toggleInputField(); // Adjust input type

                    if (dateFields.includes(filterBy)) {
                        const [startDate, endDate] = value.split(' - ');
                        if (myFlatpickrStart) myFlatpickrStart.setDate(startDate);
                        if (myFlatpickrEnd) myFlatpickrEnd.setDate(endDate);
                    } else {
                        document.getElementById('search-input').value = value;
                    }

                    document.getElementById('search-form').dispatchEvent(new Event('submit'));
                    toggleHistoryPopup(); // Close popup after search
                };
                historyList.appendChild(div);
            });
        } else {
            const emptyMsg = document.createElement("div");
            emptyMsg.className = "text-gray-400 px-3";
            emptyMsg.textContent = i18next.t('Kh√¥ng c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm.');
            historyList.appendChild(emptyMsg);
        }
    }

    document.getElementById("clear-history-btn").addEventListener("click", function () {
        localStorage.removeItem("partSearchHistory");
        renderHistory(); // Re-render history list to show empty message
    });


    // Initialize Select2
    $(document).ready(function() {
        $('#filter-select').select2({
            minimumResultsForSearch: Infinity // Hide search box for simplicity if not many options
        });
        // Initial setup for input fields
        toggleInputField();
        initializeFlatpickr(); // Initialize Flatpickr after DOM is ready
        fetchData(); // Load initial data
        updateContent(); // Apply initial translations
    });

</script>
</body>
</html>
