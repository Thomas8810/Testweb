<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css"> 

    <style>
        /* ƒêo·∫°n CSS responsive m√°y t√≠nh */
        @media (min-width: 768px) {
            html, body {
                height: 100%;
                overflow: hidden;
            }

            body {
                overflow-y: auto;
            }

            input, select, textarea {
                touch-action: manipulation;
                -webkit-user-select: text;
                user-select: text;
                caret-color: auto;
            }

            input:focus,
            select:focus,
            textarea:focus {
                outline: none;
                box-shadow: none;
            }
        }
        /* C√†i ƒë·∫∑t CSS c∆° b·∫£n */
        html {line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}template{display:none}[hidden]{display:none}
        /* Th√™m ƒëo·∫°n CSS c·ªßa Tailwind CSS */
        @tailwind base;
        @tailwind components;
        @tailwind utilities;

        /* CƒÉn gi·ªØa popup l·ªãch s·ª≠ t√¨m ki·∫øm */
        #floating-history-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            display: none; /* M·∫∑c ƒë·ªãnh ·∫©n */
        }

        /* Hi·ªáu ·ª©ng m·ªù n·ªÅn khi popup hi·ªán ra */
        #floating-history-popup.show {
            display: block;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .select2-container .select2-selection--single {
            height: 40px !important; /* Adjust as needed */
            display: flex;
            align-items: center;
            border-radius: 6px;
            border: 1px solid #4a4a4a !important;
            background-color: #333 !important;
            color: white !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: white !important; /* Text color */
            line-height: 40px; /* Vertically align text */
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow b {
            border-color: white transparent transparent transparent !important; /* Arrow color */
        }

        .select2-dropdown {
            background-color: #333 !important;
            border: 1px solid #4a4a4a !important;
        }

        .select2-results__option {
            color: white !important;
        }

        .select2-results__option--highlighted {
            background-color: #007bff !important;
            color: white !important;
        }

        .select2-search__field {
            background-color: #4a4a4a !important;
            color: white !important;
            border: 1px solid #666 !important;
        }

        /* ·∫®n input t√¨m ki·∫øm v√† datepicker */
        .search-input-group, .date-input-group {
            display: none;
        }
        /* Hi·ªÉn th·ªã input t√¨m ki·∫øm m·∫∑c ƒë·ªãnh */
        .search-input-group.active, .date-input-group.active {
            display: block;
        }

        /* Custom Flatpickr styles to match dark theme */
        .flatpickr-calendar {
            background-color: #333; /* Dark background */
            border: 1px solid #555;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            color: #eee; /* Light text */
            z-index: 1001; /* Ensure it's above overlay */
        }
        .flatpickr-day.selected, .flatpickr-day.selected:hover {
            background-color: #007bff; /* Highlight color */
            border-color: #007bff;
            color: white;
        }
        .flatpickr-day.start-date, .flatpickr-day.end-date {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .flatpickr-day.in-range {
            background-color: rgba(0, 123, 255, 0.2); /* Lighter blue for range */
            border-color: rgba(0, 123, 255, 0.2);
        }
        .flatpickr-day.today {
            border-color: #007bff;
        }
        .flatpickr-day:hover {
            background-color: #555; /* Hover color */
        }
        .flatpickr-months .flatpickr-prev-month,
        .flatpickr-months .flatpickr-next-month {
            color: #eee; /* Arrows color */
        }
        .flatpickr-current-month .flatpickr-month,
        .flatpickr-current-month .flatpickr-year {
            color: #eee;
        }
        .numInputWrapper {
            color: #eee; /* Year/month input color */
        }
        .flatpickr-weekdays {
            background-color: #444;
            color: #ccc;
        }
        .flatpickr-weekday {
            color: #ccc;
        }
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 1.5rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col justify-center items-center p-4">
<div class="w-full max-w-4xl bg-gray-800 p-6 rounded-lg shadow-lg">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-center text-blue-400" data-i18n="title">Tra c·ª©u Part Number</h1>
        <div class="flex items-center space-x-2">
            <button class="bg-gray-600 text-white px-3 py-1 rounded-md" id="lang-vi">VI</button>
            <button class="bg-gray-600 text-white px-3 py-1 rounded-md" id="lang-en">EN</button>
        </div>
    </div>

    <form id="search-form" class="mb-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-400 text-sm font-bold mb-2" for="filter-select" data-i18n="filterLabel">
                    L·ªçc theo:
                </label>
                <select class="shadow border border-gray-700 rounded w-full py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="filter-select">
                    <option value="Part Number" data-i18n="partNumberOption">Part Number</option>
                    <option value="Description" data-i18n="descriptionOption">Description</option>
                    <option value="Customer" data-i18n="customerOption">Customer</option>
                    <option value="Commodity" data-i18n="commodityOption">Commodity</option>
                    <option value="PO Number" data-i18n="poNumberOption">PO Number</option>
                    <option value="PO received date" data-i18n="poReceivedDateOption">PO received date</option>
                    <option value="Customer need date" data-i18n="customerNeedDateOption">Customer need date</option>
                    <option value="Approval Status" data-i18n="approvalStatusOption">Approval Status</option>
                    <option value="Production Status" data-i18n="productionStatusOption">Production Status</option>
                    <option value="ERP-CODE" data-i18n="erpCodeOption">ERP-CODE</option>
                </select>
            </div>
            <div id="text-search-group" class="search-input-group active">
                <label class="block text-gray-400 text-sm font-bold mb-2" for="search-input" data-i18n="inputValueLabel">
                    Nh·∫≠p gi√° tr·ªã:
                </label>
                <input autocomplete="off" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="search-input" type="text"/>
            </div>
            <div id="date-search-group" class="date-input-group">
                <label class="block text-gray-400 text-sm font-bold mb-2" data-i18n="dateRangeLabel">
                    Ch·ªçn kho·∫£ng ng√†y:
                </label>
                <div class="flex space-x-2">
                    <input class="shadow appearance-none border border-gray-700 rounded w-1/2 py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700 flatpickr" id="date-start" type="text" placeholder="T·ª´ ng√†y"/>
                    <input class="shadow appearance-none border border-gray-700 rounded w-1/2 py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700 flatpickr" id="date-end" type="text" placeholder="ƒê·∫øn ng√†y"/>
                </div>
            </div>
        </div>
        <div class="flex justify-center space-x-4">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="searchButton" type="submit">
                T√¨m ki·∫øm
            </button>
            <button class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="viewAllButton" id="view-all-btn" type="button">
                Xem t·∫•t c·∫£
            </button>
            <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" data-i18n="historyButton" id="toggle-history-btn" type="button">
                L·ªãch s·ª≠
            </button>
        </div>
    </form>

    <div class="mb-4">
        <label class="block text-gray-400 text-sm font-bold mb-2" for="entries-per-page" data-i18n="showEntriesLabel">
            Hi·ªÉn th·ªã:
        </label>
        <select class="shadow border border-gray-700 rounded py-2 px-3 text-white leading-tight focus:outline-none focus:shadow-outline bg-gray-700" id="entries-per-page">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
        </select>
    </div>

    <div class="overflow-x-auto bg-gray-700 rounded-lg shadow">
        <table class="min-w-full leading-normal">
            <thead>
            <tr>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="flex justify-between items-center mt-4">
        <span class="text-gray-400" id="pagination-info"></span>
        <div class="flex space-x-2">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="prev-page" disabled>Tr∆∞·ªõc</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" id="next-page" disabled>Ti·∫øp</button>
        </div>
    </div>
</div>

<div id="overlay"></div>
<div id="floating-history-popup">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold" data-i18n="searchHistoryTitle">L·ªãch s·ª≠ T√¨m ki·∫øm</h2>
        <button class="text-gray-400 hover:text-white" id="close-history-popup">‚úñ</button>
    </div>
    <div id="history-list" class="space-y-2">
        </div>
    <div class="mt-4 text-right">
        <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded" data-i18n="clearHistoryButton" id="clear-history-btn">
            X√≥a l·ªãch s·ª≠
        </button>
    </div>
</div>

<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <span class="ml-3" data-i18n="loadingMessage">ƒêang t·∫£i...</span>
</div>

<a href="voice_search.html" style="position: fixed; bottom: 20px; right: 20px; background-color: #00cc99; color: white; border: none; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 20px; text-decoration: none; z-index: 9999;" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
    üé§
</a>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/vn.js"></script> <script>
    // i18next configuration
    i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
            fallbackLng: 'vi',
            debug: false, // Set to true for debugging translation issues
            resources: {
                en: {
                    translation: {
                        title: "Part Number Lookup",
                        inputValueLabel: "Enter Value:",
                        filterLabel: "Filter by:",
                        partNumberOption: "Part Number",
                        descriptionOption: "Description",
                        customerOption: "Customer",
                        commodityOption: "Commodity",
                        poNumberOption: "PO Number",
                        poReceivedDateOption: "PO Received Date",
                        customerNeedDateOption: "Customer Need Date",
                        approvalStatusOption: "Approval Status",
                        productionStatusOption: "Production Status",
                        erpCodeOption: "ERP-CODE",
                        searchButton: "Search",
                        viewAllButton: "View All",
                        historyButton: "History",
                        showEntriesLabel: "Show entries:",
                        searchHistoryTitle: "Search History",
                        clearHistoryButton: "Clear History",
                        dateRangeLabel: "Select Date Range:",
                        noSearchResults: "No data found.",
                        noHistory: "No search history.",
                        loadingMessage: "Loading...",
                        // Pagination
                        previousButton: "Previous",
                        nextButton: "Next",
                        paginationInfo: "Showing {{start}} to {{end}} of {{total}} entries"
                    }
                },
                vi: {
                    translation: {
                        title: "Tra c·ª©u Part Number",
                        inputValueLabel: "Nh·∫≠p gi√° tr·ªã:",
                        filterLabel: "L·ªçc theo:",
                        partNumberOption: "Part Number",
                        descriptionOption: "M√¥ t·∫£",
                        customerOption: "Kh√°ch h√†ng",
                        commodityOption: "H√†ng h√≥a",
                        poNumberOption: "S·ªë PO",
                        poReceivedDateOption: "Ng√†y nh·∫≠n PO",
                        customerNeedDateOption: "Ng√†y kh√°ch c·∫ßn",
                        approvalStatusOption: "Tr·∫°ng th√°i ph√™ duy·ªát",
                        productionStatusOption: "Tr·∫°ng th√°i s·∫£n xu·∫•t",
                        erpCodeOption: "M√£ ERP",
                        searchButton: "T√¨m ki·∫øm",
                        viewAllButton: "Xem t·∫•t c·∫£",
                        historyButton: "L·ªãch s·ª≠",
                        showEntriesLabel: "Hi·ªÉn th·ªã:",
                        searchHistoryTitle: "L·ªãch s·ª≠ T√¨m ki·∫øm",
                        clearHistoryButton: "X√≥a l·ªãch s·ª≠",
                        dateRangeLabel: "Ch·ªçn kho·∫£ng ng√†y:",
                        noSearchResults: "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu.",
                        noHistory: "Kh√¥ng c√≥ l·ªãch s·ª≠ t√¨m ki·∫øm.",
                        loadingMessage: "ƒêang t·∫£i...",
                        // Pagination
                        previousButton: "Tr∆∞·ªõc",
                        nextButton: "Ti·∫øp",
                        paginationInfo: "Hi·ªÉn th·ªã {{start}} ƒë·∫øn {{end}} c·ªßa {{total}} m·ª•c"
                    }
                }
            }
        }, function (err, t) {
            if (err) return console.error('something went wrong loading', err);
            updateContent();
        });

    function updateContent() {
        document.querySelectorAll('[data-i18n]').forEach(element => {
            const key = element.dataset.i18n;
            if (element.tagName === 'OPTION') {
                // For select options, update textContent
                element.textContent = i18next.t(key);
            } else if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                element.placeholder = i18next.t(key);
            } else {
                element.textContent = i18next.t(key);
            }
        });
        // Update placeholders specifically for datepickers if they exist
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        if (dateStartInput) dateStartInput.placeholder = i18next.t('T·ª´ ng√†y');
        if (dateEndInput) dateEndInput.placeholder = i18next.t('ƒê·∫øn ng√†y');

        // Update button texts
        document.getElementById('prev-page').textContent = i18next.t('previousButton');
        document.getElementById('next-page').textContent = i18next.t('nextButton');
        
        // Re-render history with updated language
        renderHistory(); 
        // Re-update pagination info
        updatePaginationInfo();
    }

    document.getElementById('lang-vi').addEventListener('click', () => {
        i18next.changeLanguage('vi').then(() => {
            if (myFlatpickrStart) myFlatpickrStart.set('locale', 'vn');
            if (myFlatpickrEnd) myFlatpickrEnd.set('locale', 'vn');
            updateContent();
        });
    });

    document.getElementById('lang-en').addEventListener('click', () => {
        i18next.changeLanguage('en').then(() => {
            if (myFlatpickrStart) myFlatpickrStart.set('locale', 'en');
            if (myFlatpickrEnd) myFlatpickrEnd.set('locale', 'en');
            updateContent();
        });
    });

    // Global variables
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let entriesPerPage = parseInt(document.getElementById('entries-per-page').value);
    let myFlatpickrStart, myFlatpickrEnd; // Bi·∫øn l∆∞u instance c·ªßa flatpickr

    // Date fields that should trigger date range picker (MUST match your data.json keys)
    const dateFields = ["PO received date", "Customer need date"];

    // Function to show/hide loading overlay
    function showLoading() {
        document.getElementById('loading-overlay').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    // Function to initialize Flatpickr
    function initializeFlatpickr() {
        myFlatpickrStart = flatpickr("#date-start", {
            dateFormat: "Y-m-d",
            locale: i18next.language === 'vi' ? 'vn' : 'en', // Use appropriate locale
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0 && myFlatpickrEnd) {
                    myFlatpickrEnd.set("minDate", selectedDates[0]);
                }
            }
        });
        myFlatpickrEnd = flatpickr("#date-end", {
            dateFormat: "Y-m-d",
            locale: i18next.language === 'vi' ? 'vn' : 'en', // Use appropriate locale
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0 && myFlatpickrStart) {
                    myFlatpickrStart.set("maxDate", selectedDates[0]);
                }
            }
        });
    }

    // Function to toggle input field based on filter selection
    function toggleInputField() {
        const filterSelect = document.getElementById('filter-select');
        const searchInputGroup = document.getElementById('text-search-group');
        const dateInputGroup = document.getElementById('date-search-group');
        const searchInput = document.getElementById('search-input');

        if (dateFields.includes(filterSelect.value)) {
            searchInputGroup.classList.remove('active');
            dateInputGroup.classList.add('active');
            searchInput.value = ''; // Clear text input
            // Clear date inputs using Flatpickr's clear method
            if (myFlatpickrStart) myFlatpickrStart.clear();
            if (myFlatpickrEnd) myFlatpickrEnd.clear();
        } else {
            searchInputGroup.classList.add('active');
            dateInputGroup.classList.remove('active');
            // Clear text input if it was date picker previously
            if (myFlatpickrStart) myFlatpickrStart.clear();
            if (myFlatpickrEnd) myFlatpickrEnd.clear();
        }
    }

    // Event listener for filter select change
    document.getElementById('filter-select').addEventListener('change', toggleInputField);

    // Fetch data from server
    async function fetchData() {
        showLoading();
        try {
            const response = await fetch('/api/data'); // S·ª≠ d·ª•ng API endpoint t·ª´ server.js
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allData = data.data; // Server now sends data in a 'data' property
            filteredData = allData; // Initially, all data is filtered
            renderTable();
        } catch (error) {
            console.error('Error fetching data:', error);
            // Optionally display user-friendly error message
            const tbody = document.querySelector('table tbody');
            tbody.innerHTML = `<tr><td colspan="99" class="px-5 py-5 text-center text-red-400">${i18next.t('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.')}</td></tr>`;
        } finally {
            hideLoading();
        }
    }

    // Render table headers
    function renderTableHeaders(headers) {
        const thead = document.querySelector('table thead tr');
        thead.innerHTML = ''; // Clear existing headers
        headers.forEach(header => {
            const th = document.createElement('th');
            th.className = 'px-5 py-3 border-b-2 border-gray-600 bg-gray-600 text-left text-xs font-semibold text-gray-200 uppercase tracking-wider';
            th.textContent = header;
            thead.appendChild(th);
        });
    }

    // Render table data for current page
    function renderTable() {
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = ''; // Clear existing data

        const startIndex = (currentPage - 1) * entriesPerPage;
        const endIndex = startIndex + entriesPerPage;
        const dataToDisplay = filteredData.slice(startIndex, endIndex);

        if (filteredData.length > 0) {
            // Ensure headers are correctly extracted from the first item
            const headers = Object.keys(filteredData[0]); 
            renderTableHeaders(headers);

            dataToDisplay.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-600'; // Add hover effect
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-5 py-5 border-b border-gray-600 text-sm';
                    let cellValue = item[header];

                    // Handle date fields: Convert Excel serial date to YYYY-MM-DD
                    // This conversion happens only for display, not for search logic
                    if (dateFields.includes(header) && typeof cellValue === 'number' && cellValue > 0) {
                        try {
                             cellValue = excelSerialDateToJSDate(cellValue).toISOString().slice(0, 10);
                        } catch (e) {
                            console.warn(`Could not convert Excel date serial ${cellValue} for header ${header}:`, e);
                            cellValue = 'Invalid Date';
                        }
                    } else if (cellValue === null || cellValue === undefined) {
                        cellValue = '-'; // Display hyphen for null/undefined values
                    }

                    td.textContent = cellValue;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        } else {
            renderTableHeaders([]); // Clear headers if no data
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 99; // Span across all potential columns
            td.className = 'px-5 py-5 text-center text-gray-400';
            td.textContent = i18next.t('noSearchResults');
            tr.appendChild(td);
            tbody.appendChild(tr);
        }

        updatePaginationInfo();
        updatePaginationButtons();
    }

    // Convert Excel serial date to JavaScript Date object
    function excelSerialDateToJSDate(serial) {
        // Excel's epoch is Jan 1, 1900. But it has a bug that considers 1900 a leap year.
        // So, 1 means 1900-01-01, but internally it's calculated from 1899-12-31.
        // JS Date uses milliseconds from epoch (Jan 1, 1970).
        // Difference in days between 1970-01-01 and 1899-12-31 is 25569.
        // For UTC, Excel's 1899-12-31 is equivalent to 25569 days before 1970-01-01.
        const days = serial - 25569; // Subtract the epoch offset
        const date = new Date(days * 24 * 60 * 60 * 1000); // Convert days to milliseconds
        return date;
    }


    // Update pagination info (e.g., "Showing 1 to 10 of 100 entries")
    function updatePaginationInfo() {
        const totalEntries = filteredData.length;
        const startIndex = totalEntries === 0 ? 0 : (currentPage - 1) * entriesPerPage + 1;
        const endIndex = Math.min(startIndex + entriesPerPage - 1, totalEntries);
        const paginationInfo = document.getElementById('pagination-info');
        paginationInfo.textContent = i18next.t('paginationInfo', { start: startIndex, end: endIndex, total: totalEntries });
    }

    // Update pagination buttons (enable/disable)
    function updatePaginationButtons() {
        const prevBtn = document.getElementById('prev-page');
        const nextBtn = document.getElementById('next-page');
        const totalPages = Math.ceil(filteredData.length / entriesPerPage);

        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = currentPage === totalPages || totalPages === 0;
    }

    // Event listeners for pagination
    document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredData.length / entriesPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Event listener for entries per page change
    document.getElementById('entries-per-page').addEventListener('change', (event) => {
        entriesPerPage = parseInt(event.target.value);
        currentPage = 1; // Reset to first page
        renderTable();
    });

    // Handle search form submission
    document.getElementById('search-form').addEventListener('submit', async function (event) {
        event.preventDefault();
        showLoading();

        const searchInput = document.getElementById('search-input');
        const filterSelect = document.getElementById('filter-select');
        const searchTerm = searchInput.value.trim();
        const filterBy = filterSelect.value;
        const dateStart = document.getElementById('date-start').value;
        const dateEnd = document.getElementById('date-end').value;

        // Construct URL for API call
        let url = `/api/search?filterBy=${encodeURIComponent(filterBy)}`;
        let historyQuery = `${filterBy}: `;

        if (dateFields.includes(filterBy)) {
            // Date range search
            if (dateStart) {
                url += `&startDate=${encodeURIComponent(dateStart)}`;
                historyQuery += `${dateStart}`;
            } else {
                historyQuery += 'T·ª´ ƒë·∫ßu';
            }
            historyQuery += ' - ';
            if (dateEnd) {
                url += `&endDate=${encodeURIComponent(dateEnd)}`;
                historyQuery += `${dateEnd}`;
            } else {
                historyQuery += 'Hi·ªán t·∫°i';
            }
            if (!dateStart && !dateEnd) { // If no dates selected, treat as "View All" for this field
                url = `/api/data`; // or handle specifically to filter nothing by date
                historyQuery = `${filterBy}: To√†n b·ªô`;
            }
        } else {
            // Text search
            if (searchTerm) {
                url += `&searchTerm=${encodeURIComponent(searchTerm)}`;
                historyQuery += searchTerm;
            } else {
                historyQuery += 'Tr·ªëng'; // Or handle as an empty search
            }
        }

        // Save search to history only if there's an actual search term or date range
        if (searchTerm || (dateFields.includes(filterBy) && (dateStart || dateEnd))) {
            saveSearchHistory(historyQuery);
        }

        try {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            filteredData = data.data; // Server now sends data in a 'data' property
            currentPage = 1; // Reset page
            renderTable();
        } catch (error) {
            console.error('Error during search:', error);
            alert(i18next.t('ƒê√£ c√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm. Vui l√≤ng th·ª≠ l·∫°i.'));
            filteredData = []; // Clear results on error
            renderTable();
        } finally {
            hideLoading();
        }
    });


    // "View All" button functionality
    document.getElementById('view-all-btn').addEventListener('click', async () => {
        showLoading();
        try {
            const response = await fetch('/api/data'); // L·∫•y t·∫•t c·∫£ d·ªØ li·ªáu
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            allData = data.data; // Server now sends data in a 'data' property
            filteredData = allData;
            currentPage = 1;
            renderTable();
            saveSearchHistory(i18next.t('viewAllButton')); // Save "View All" to history
        } catch (error) {
            console.error('Error viewing all data:', error);
            alert(i18next.t('Kh√¥ng th·ªÉ t·∫£i t·∫•t c·∫£ d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.'));
        } finally {
            hideLoading();
        }
    });

    // History Popup functions
    function toggleHistoryPopup() {
        const popup = document.getElementById("floating-history-popup");
        const overlay = document.getElementById("overlay");
        const isOpen = popup.classList.contains("show");

        if (isOpen) {
            popup.classList.remove("show");
            overlay.style.display = "none";
        } else {
            renderHistory(); // C·∫≠p nh·∫≠t l·ªãch s·ª≠ tr∆∞·ªõc khi hi·ªÉn th·ªã
            popup.classList.add("show");
            overlay.style.display = "block";
        }
    }

    document.getElementById("toggle-history-btn").addEventListener("click", toggleHistoryPopup);
    document.getElementById("close-history-popup").addEventListener("click", toggleHistoryPopup);
    document.getElementById("overlay").addEventListener("click", toggleHistoryPopup); // ƒê√≥ng popup khi click ra ngo√†i

    function saveSearchHistory(searchQuery) {
        let storedHistory = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");

        // Remove if already exists to move to top
        storedHistory = storedHistory.filter(item => item !== searchQuery);

        // Add new query to the beginning
        storedHistory.unshift(searchQuery);

        // Keep only the latest 10 items
        if (storedHistory.length > 10) {
            storedHistory = storedHistory.slice(0, 10);
        }

        localStorage.setItem("partSearchHistory", JSON.stringify(storedHistory));
        // No need to call renderHistory() here, it's called when popup is opened
    }

    function renderHistory() {
        const historyList = document.getElementById("history-list");
        historyList.innerHTML = ''; // Clear existing history
        const storedHistory = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");

        if (storedHistory.length > 0) {
            storedHistory.forEach(item => {
                const div = document.createElement("div");
                div.className = "text-white px-3 py-1 bg-gray-700 rounded cursor-pointer hover:bg-gray-600 truncate";
                div.textContent = "üîç " + item;
                div.onclick = () => {
                    // Populate search fields and perform search
                    const parts = item.split(': ').map(s => s.trim());
                    const filterBy = parts[0];
                    const value = parts.slice(1).join(': '); // Re-join if there were multiple colons

                    document.getElementById('filter-select').value = filterBy;
                    // Trigger change event to ensure toggleInputField runs
                    document.getElementById('filter-select').dispatchEvent(new Event('change'));

                    if (dateFields.includes(filterBy)) {
                        // Handle "To√†n b·ªô" case for date fields
                        if (value === i18next.t('To√†n b·ªô') || value.includes('To√†n b·ªô')) {
                            if (myFlatpickrStart) myFlatpickrStart.clear();
                            if (myFlatpickrEnd) myFlatpickrEnd.clear();
                        } else {
                            const dateParts = value.split(' - ');
                            const startDate = dateParts[0] === i18next.t('T·ª´ ƒë·∫ßu') ? '' : dateParts[0];
                            const endDate = dateParts[1] === i18next.t('Hi·ªán t·∫°i') ? '' : dateParts[1];
                            if (myFlatpickrStart) myFlatpickrStart.setDate(startDate || null, false);
                            if (myFlatpickrEnd) myFlatpickrEnd.setDate(endDate || null, false);
                        }
                    } else {
                        document.getElementById('search-input').value = (value === i18next.t('Tr·ªëng') || value === '') ? '' : value;
                    }

                    document.getElementById('search-form').dispatchEvent(new Event('submit'));
                    toggleHistoryPopup(); // Close popup after search
                };
                historyList.appendChild(div);
            });
        } else {
            const emptyMsg = document.createElement("div");
            emptyMsg.className = "text-gray-400 px-3";
            emptyMsg.textContent = i18next.t('noHistory');
            historyList.appendChild(emptyMsg);
        }
    }

    document.getElementById("clear-history-btn").addEventListener("click", function () {
        localStorage.removeItem("partSearchHistory");
        renderHistory(); // Re-render history list to show empty message
    });


    // Initialize Select2 and other functions on DOM ready
    $(document).ready(function() {
        $('#filter-select').select2({
            minimumResultsForSearch: Infinity // Hide search box for simplicity if not many options
        });
        
        initializeFlatpickr(); // Initialize Flatpickr first
        toggleInputField(); // Then set initial state of input fields
        fetchData(); // Load initial data
        updateContent(); // Apply initial translations
    });

</script>
</body>
</html>
