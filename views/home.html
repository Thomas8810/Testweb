<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Web Tra C·ª©u - Nguy·ªÖn VƒÉn ƒê·∫°o</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Arial', 'sans-serif'],
                    },
                    colors: {
                        primary: '#3B82F6', // Blue 500
                        secondary: '#10B981', // Emerald 500
                        accent: '#F59E0B', // Amber 500
                        neutral: '#F3F4F6', // Gray 100
                        textDark: '#1F2937', // Gray 800
                        textLight: '#6B7280', // Gray 500
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
    <script src="https://unpkg.com/i18next@21.6.3/dist/umd/i18next.min.js"></script>
    <script src="https://unpkg.com/i18next-browser-languagedetector@6.1.2/dist/umd/i18nextBrowserLanguageDetector.min.js"></script>
    <style>
        /* Custom CSS for Select2 to match Tailwind aesthetics */
        .select2-container--default .select2-selection--multiple {
            @apply bg-white border border-gray-300 rounded-lg shadow-sm min-h-[42px] text-textDark;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice {
            @apply bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded-full flex items-center;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
            @apply text-blue-600 hover:text-blue-900 ml-1;
        }
        .select2-container--default .select2-selection--multiple .select2-selection__rendered {
            @apply p-1;
        }
        .select2-container--default .select2-selection--single {
            @apply bg-white border border-gray-300 rounded-lg shadow-sm h-[42px] flex items-center;
        }
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            @apply text-textDark leading-none px-3;
        }
        .select2-container--default .select2-results__option--highlighted.select2-results__option--selectable {
            @apply bg-primary text-white;
        }
        .select2-dropdown {
            @apply border border-gray-300 rounded-lg shadow-lg;
        }
        .select2-search input {
            @apply border border-gray-300 rounded-lg p-2;
        }
        /* Hide Select2 search input for single selects */
        .select2-container--default .select2-selection--single .select2-search__field {
            display: none;
        }

        /* Sticky table headers and columns */
        .table-container table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .table-container th,
        .table-container td {
            @apply border border-gray-200;
        }

        .table-container th {
            @apply bg-primary text-white sticky top-0 z-20;
        }

        .sticky-col-1 {
            position: sticky;
            left: 0;
            @apply bg-primary z-30;
        }
        .sticky-col-2 {
            position: sticky;
            left: 40px; /* Width of sticky-col-1 */
            @apply bg-primary z-30;
        }
        .sticky-col-3 {
            position: sticky;
            left: 140px; /* Width of sticky-col-1 + sticky-col-2 */
            @apply bg-primary z-30;
        }

        .table-container td.sticky-col-1,
        .table-container td.sticky-col-2,
        .table-container td.sticky-col-3 {
            @apply bg-white text-textDark z-10;
        }
        .table-container tbody tr:nth-child(even) td {
            @apply bg-gray-50;
        }

        /* Spinner animation */
        @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        #loading-spinner > div {
          animation: spin 1s linear infinite;
        }

        /* Image popup styling */
        #image-popup {
            @apply hidden fixed border border-gray-300 bg-white p-2 shadow-xl cursor-default transition-all duration-300 ease-in-out overflow-auto;
            z-index: 10000;
            max-width: 250px;
            max-height: 250px;
        }
        #image-popup img {
            @apply max-w-full max-h-full block object-contain w-full h-full cursor-zoom-in;
        }
        #image-popup.zoomed {
            @apply max-w-[90vw] max-h-[90vh] w-auto h-auto p-4;
        }
        #image-popup.zoomed img {
            @apply cursor-zoom-out;
        }
        .image-popup-close {
            @apply absolute top-0 right-2 text-2xl font-bold cursor-pointer text-gray-700 bg-white rounded-full leading-none px-1 py-0.5;
            z-index: 10001;
        }
        .image-popup-close:hover {
            @apply text-gray-900 bg-gray-100;
        }
        .image-popup-spinner {
            @apply absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 border-4 border-gray-200 border-t-4 border-t-blue-500 rounded-full w-8 h-8 hidden;
            animation: spin 1s linear infinite;
            z-index: 10002;
        }
        .no-image-text {
            @apply p-4 text-center text-gray-600;
        }

        /* Mobile specific adjustments */
        @media (max-width: 767px) {
            .top-area {
                @apply p-4;
            }
            .filter-grid, .action-grid {
                @apply grid-cols-1 gap-3;
            }
            .filter-block, .action-block {
                @apply w-full;
            }
            .header h1 { @apply text-2xl; }
            .header p { @apply text-base; }
            .language-switcher {
                @apply static flex justify-center mt-4;
            }
            .language-switcher button {
                @apply text-sm px-3 py-1.5;
            }
            .table-container {
                max-height: calc(100vh - 300px); /* Adjusted for more space */
            }
            body {
                padding-bottom: 300px; /* Space for keyboard */
            }
        }

        /* Landscape orientation adjustments */
        @media screen and (orientation: landscape) {
            .top-area {
                max-height: 40vh;
            }
            .table-container {
                height: auto;
                max-height: 90vh;
                min-height: 60vh;
            }
            table {
                min-width: 1200px;
            }
        }

        /* Dynamic container classes */
        .full-top-container {
            @apply h-screen max-h-screen overflow-y-auto;
        }
        .hide-top-container {
            @apply h-0 max-h-0 overflow-hidden p-0 opacity-0 pointer-events-none;
        }
        .show-table-only {
            @apply h-[calc(100vh-60px)]; /* Adjust based on quick search and footer height */
        }
    </style>
</head>
<body class="font-sans bg-neutral text-textDark flex flex-col min-h-screen">
    <div id="loading-spinner" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[9999]">
        <div class="border-6 border-gray-300 border-t-6 border-t-primary rounded-full w-10 h-10"></div>
    </div>

    <div class="page-container flex flex-col flex-grow">
        <div class="top-area bg-white p-6 shadow-lg relative overflow-y-auto max-h-[50vh] transition-all duration-300 ease-in-out rounded-b-xl">
            <div class="header text-center p-2 relative mb-4">
                <a class="tasks-link absolute top-2 left-2 bg-secondary hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300" href="/tasks">Tasks</a>
                <h1 id="header-title" class="text-4xl font-extrabold text-textDark mb-1">FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR</h1>
                <p id="header-subtitle" class="text-lg text-textLight">Tra c·ª©u t√¨nh tr·∫°ng FAIR</p>
                <div class="language-switcher absolute top-2 right-2 flex space-x-2">
                    <button onclick="changeLanguage('vi')" class="bg-accent hover:bg-amber-600 text-white text-base font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">Vi</button>
                    <button onclick="changeLanguage('en')" class="bg-accent hover:bg-amber-600 text-white text-base font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">En</button>
                    <button onclick="changeLanguage('ko')" class="bg-accent hover:bg-amber-600 text-white text-base font-semibold py-2 px-4 rounded-lg transition duration-300 shadow-md">Ko</button>
                </div>
            </div>

            <div class="filter-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="filter-block bg-neutral p-5 rounded-xl shadow-inner">
                    <label for="filter-project" id="label-filter-project" class="block mb-3 font-semibold text-textDark">Ch·ªçn d·ª± √°n (Customer)</label>
                    <select class="value-select w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-project" multiple="multiple"></select>
                </div>
                <div class="filter-block bg-neutral p-5 rounded-xl shadow-inner">
                    <label for="filter-column-1" id="label-criteria-1" class="block mb-3 font-semibold text-textDark">Ch·ªçn ti√™u ch√≠ s·ªë 1:</label>
                    <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-column-1">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-1" id="label-filter-value-1" class="block mt-4 mb-3 font-semibold text-textDark">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-value-1" multiple="multiple"></select>
                    <div class="date-range-inputs hidden mt-3">
                        <label for="filter-date-start-1" class="block text-sm mb-1 text-textLight">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-start-1">
                        <label for="filter-date-end-1" class="block text-sm mt-3 mb-1 text-textLight">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-end-1">
                    </div>
                </div>
                <div class="filter-block bg-neutral p-5 rounded-xl shadow-inner">
                    <label for="filter-column-2" id="label-criteria-2" class="block mb-3 font-semibold text-textDark">Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):</label>
                    <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-column-2">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-2" id="label-filter-value-2" class="block mt-4 mb-3 font-semibold text-textDark">Ch·ªçn gi√° tr·ªã</label>
                    <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-value-2" multiple="multiple"></select>
                     <div class="date-range-inputs hidden mt-3">
                        <label for="filter-date-start-2" class="block text-sm mb-1 text-textLight">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-start-2">
                        <label for="filter-date-end-2" class="block text-sm mt-3 mb-1 text-textLight">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-end-2">
                    </div>
                </div>
                <div class="filter-block bg-neutral p-5 rounded-xl shadow-inner">
                    <label for="filter-column-3" id="label-criteria-3" class="block mb-3 font-semibold text-textDark">Ch·ªçn ti√™u ch√≠ s·ªë 3:</label>
                    <select class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-column-3">
                        <option value="Part Number" selected>Part Number</option>
                        <option value="Approval Status">Approval Status</option>
                        <option value="Production Status">Production Status</option>
                        <option value="Part Pictures">Part Pictures</option>
                        <option value="Packaging Pictures">Packaging Pictures</option>
                        <option value="Customer">Customer</option>
                        <option value="Commodity">Commodity</option>
                        <option value="Critical">Critical</option>
                        <option value="CE">CE</option>
                        <option value="PO Number">PO Number</option>
                        <option value="ERP-CODE">ERP-CODE</option>
                        <option value="REV">REV</option>
                        <option value="Description">Description</option>
                        <option value="Note Number">Note Number</option>
                        <option value="PO received date" data-type="date">PO received date</option>
                        <option value="Customer need date" data-type="date">Customer need date</option>
                        <option value="Requirements">Requirements</option>
                        <option value="FAIR Cover sheet">FAIR Cover sheet</option>
                        <option value="Bubble Drawings">Bubble Drawings</option>
                        <option value="Datasheet form">Datasheet form</option>
                        <option value="LAIR data">LAIR data</option>
                        <option value="FAIR Data">FAIR Data</option>
                        <option value="COC">COC</option>
                        <option value="BOM">BOM</option>
                        <option value="Mill">Mill</option>
                        <option value="Test reports / evidences">Test reports / evidences</option>
                        <option value="Remark 1">Remark 1</option>
                        <option value="Remark 2">Remark 2</option>
                        <option value="Submit date" data-type="date">Submit date</option>
                        <option value="Reject comments">Reject comments</option>
                    </select>
                    <label for="filter-value-3" id="label-filter-value-3" class="block mt-4 mb-3 font-semibold text-textDark">Ch·ªçn gi√° tr·ªã</label>
                    <select class="value-select w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-value-3" multiple="multiple"></select>
                    <div class="date-range-inputs hidden mt-3">
                        <label for="filter-date-start-3" class="block text-sm mb-1 text-textLight">T·ª´ ng√†y:</label>
                        <input type="date" class="date-select-start w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-start-3">
                        <label for="filter-date-end-3" class="block text-sm mt-3 mb-1 text-textLight">ƒê·∫øn ng√†y:</label>
                        <input type="date" class="date-select-end w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary" id="filter-date-end-3">
                    </div>
                </div>
            </div>

            <div class="action-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="action-block flex flex-col sm:flex-row justify-center gap-3">
                    <button id="apply-filters" class="flex-1 bg-primary hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 3a1 1 0 011-1h12a1 1 0 011 1v3a1 1 0 01-.293.707L12 9.586V15a1 1 0 01-.293.707l-2 2A1 1 0 018 17v-5.414L4.293 6.707A1 1 0 014 6V3z" clip-rule="evenodd"></path></svg>
                        √Åp D·ª•ng L·ªçc
                    </button>
                    <button id="clear-filters" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                        X√≥a L·ªçc
                    </button>
                </div>
                <div class="action-block flex flex-col sm:flex-row justify-center gap-3">
                    <button id="download-excel" class="flex-1 bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Xu·∫•t Excel (ƒêang xem)
                    </button>
                    <button id="export-all" class="flex-1 bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                        Xu·∫•t Excel (T·∫•t c·∫£)
                    </button>
                </div>
                <div class="action-block flex flex-col sm:flex-row justify-center gap-3">
                    <button id="zoom-in" class="flex-1 bg-accent hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                        Ph√≥ng to
                    </button>
                    <button id="zoom-out" class="flex-1 bg-accent hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
                        Thu nh·ªè
                    </button>
                </div>
            </div>
            <div class="scan-camera text-center mt-6">
                <button id="btnScanCamera" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300">
                    <svg class="inline-block w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A1 1 0 0011.382 3H8.618a1 1 0 00-.707.293L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                    </svg>
                    Qu√©t Camera
                </button>
            </div>
            <div class="results-count text-center mt-6 text-textDark text-lg font-medium" id="results-count">Total rows: 0</div>
        </div>

        <div class="text-center my-6">
            <input id="quick-search" placeholder="üîç T√¨m Part Number..." type="text" class="p-4 w-11/12 md:w-3/5 lg:w-2/5 rounded-full border border-gray-300 shadow-xl focus:outline-none focus:ring-3 focus:ring-primary transition-all duration-300 text-textDark text-lg"/>
        </div>

        <div class="table-container flex-grow mx-auto w-11/12 bg-white rounded-xl shadow-xl overflow-auto max-h-[calc(100vh-360px)] transition-all duration-300 ease-in-out mb-6">
            <table id="results-table" class="min-w-full table-auto">
                <thead>
                    <tr>
                        <th class="sticky-col-1 py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="No">No</th>
                        <th class="sticky-col-2 py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Part Number">Part Number</th>
                        <th class="sticky-col-3 py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="REV">REV</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Approval Status">Approval Status</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Customer">Customer</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Commodity">Commodity</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Production Status">Production Status</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Part Pictures">Part Pictures</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Packaging Pictures">Packaging Pictures</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Critical">Critical</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="CE">CE</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="PO Number">PO Number</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Description">Description</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="ERP-CODE">ERP-CODE</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Note Number">Note Number</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="PO received date">PO received date</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Customer need date">Customer need date</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Requirements">Requirements</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="FAIR Cover sheet">FAIR Cover sheet</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Bubble Drawings">Bubble Drawings</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Datasheet form">Datasheet form</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="LAIR Data">LAIR Data</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="FAIR Data">FAIR Data</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="COC">COC</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="BOM">BOM</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Mill">Mill</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Test reports / evidences">Test reports / evidences</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Remark 1">Remark 1</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Remark 2">Remark 2</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Submit date">Submit date</th>
                        <th class="py-3 px-4 text-xs font-semibold uppercase tracking-wider text-center" data-column="Reject comments">Reject comments</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <div id="load-more-container" class="text-center my-6 flex justify-center gap-4">
            <button id="load-more" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300">T·∫£i th√™m</button>
            <button id="load-all" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-lg shadow-md transition duration-300">T·∫£i to√†n b·ªô</button>
        </div>
        <div class="footer text-center py-4 bg-white text-textLight text-sm shadow-inner" id="footer-text">Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o</div>
    </div>

    <div id="image-popup" class="rounded-lg">
        <span class="image-popup-close">&times;</span>
        <div class="image-popup-spinner"></div>
        <img src="" alt="Part Image" class="rounded-md">
        <span class="no-image-text"></span>
    </div>
    
    <button onclick="toggleHistoryPopup()" class="fixed bottom-5 left-5 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg transition duration-300 z-50" title="L·ªãch s·ª≠ t√¨m ki·∫øm">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd"></path>
        </svg>
    </button>

    <div id="floating-history-popup" class="hidden fixed bottom-24 left-5 bg-white text-textDark p-5 rounded-xl w-80 max-h-96 overflow-y-auto shadow-2xl z-50 border border-gray-200">
        <div class="flex justify-between items-center mb-4">
            <h4 class="m-0 text-xl font-semibold">üìú L·ªãch s·ª≠ t√¨m ki·∫øm</h4>
            <button onclick="toggleHistoryPopup()" class="bg-transparent text-gray-500 text-3xl leading-none hover:text-gray-700 transition duration-300">&times;</button>
        </div>
        <ul id="searchHistory" class="list-none p-0 m-0 space-y-3"></ul>
        <button onclick="clearSearchHistory()" class="mt-5 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg w-full shadow-md transition duration-300">
            <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
            </svg>
            X√≥a l·ªãch s·ª≠
        </button>
    </div>

    <a href="/voice_search" class="fixed bottom-5 right-5 bg-green-500 hover:bg-green-600 text-white rounded-full w-14 h-14 flex items-center justify-center text-3xl shadow-lg transition duration-300 z-50" title="T√¨m ki·∫øm b·∫±ng gi·ªçng n√≥i">
        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0 5 5 0 01-5 5 1 1 0 00-1 1v1a1 1 0 102 0v-1.172a2 2 0 00-.586-1.414L10 10.586V13a1 1 0 001 1.93z" clip-rule="evenodd"></path>
        </svg>
    </a>

    <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[9999] overflow-y-auto transition-all duration-300 ease">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-11/12 max-w-md text-center mb-20">
            <h3 class="text-2xl font-bold mb-4 text-textDark">üì∑ Qu√©t Part Number</h3>
            <div class="relative w-full max-h-60 overflow-hidden rounded-lg bg-gray-200 mb-4">
                <video id="camera" playsinline autoplay class="w-full h-full object-cover"></video>
                <div id="ocrGuideBox" class="absolute border-2 border-red-500 top-[35%] left-[10%] w-[80%] h-[20%] box-border pointer-events-none rounded-md"></div>
            </div>
            <div id="zoomContainer" class="hidden my-4 text-textLight">
              üîç Zoom:
              <input id="zoomSlider" type="range" min="1" max="3" step="0.1" value="1" class="w-4/5 accent-primary"/>
            </div>
            <canvas id="canvas" width="320" height="240" class="hidden"></canvas>
            <div class="flex flex-wrap justify-center gap-3 mt-4">
                <button id="btnCapture" class="bg-primary hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 flex-1 min-w-[120px]">
                    <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4 5a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-1.586a1 1 0 01-.707-.293l-1.121-1.121A1 1 0 0011.382 3H8.618a1 1 0 00-.707.293L6.293 4.707A1 1 0 015.586 5H4zm6 9a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
                    </svg>
                    Ch·ª•p &amp; Qu√©t
                </button>
                <button id="btnApplyOcrFilter" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 flex-1 min-w-[120px]">
                    <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    L·ªçc
                </button>
                <button id="btnCloseCamera" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 flex-1 min-w-[120px]">
                    <svg class="inline-block w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                    ƒê√≥ng
                </button>
            </div>
            <input id="ocrInput" type="text" placeholder="K·∫øt qu·∫£ OCR..." class="mt-4 w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary text-textDark"/>
            <p id="ocrStatus" class="text-sm mt-3 mb-5 text-textLight">ƒêang ch·ªù thao t√°c...</p>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/colresizable/1.6/colResizable-1.6.min.js"></script>

    <script>
        // Kh·ªüi t·∫°o i18next
        i18next.use(i18nextBrowserLanguageDetector).init({
          fallbackLng: 'vi',
          debug: false,
          resources: {
            en: {
              translation: {
                "header_title": "FAIR TEAM - Search Status",
                "header_subtitle": "Search FAIR status",
                "choose_project": "Choose Project",
                "choose_value": "Choose Value",
                "choose_criteria_1": "Select Criteria 1:",
                "choose_criteria_2": "Select Criteria 2 (paste excel):",
                "choose_criteria_3": "Select Criteria 3:",
                "apply_filter": "Apply Filter",
                "clear_filter": "Clear Filter",
                "download_excel": "Export Excel (Current)",
                "export_all": "Export Excel (All)",
                "zoom_in": "Zoom In",
                "zoom_out": "Zoom Out",
                "load_more": "Load More",
                "load_all": "Load All",
                "total_rows": "Total rows: {{count}} / {{total}}",
                "developer": "Developer: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "From Date:",
                "date_to": "To Date:",
                "no_image_found": "No image found for Part Number \"{{partNumber}}\" (ERP: {{erpCode}}).",
                "no_erp_code": "No image for Part Number \"{{partNumber}}\". (Missing ERP-CODE)"
              }
            },
            ko: {
              translation: {
                "header_title": "FAIR TEAM - Í≤ÄÏÉâ ÏÉÅÌÉú",
                "header_subtitle": "FAIR ÏÉÅÌÉú Í≤ÄÏÉâ",
                "choose_project": "ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù",
                "choose_value": "Í∞í ÏÑ†ÌÉù",
                "choose_criteria_1": "Í∏∞Ï§Ä 1 ÏÑ†ÌÉù:",
                "choose_criteria_2": "Í∏∞Ï§Ä 2 ÏÑ†ÌÉù (ÏóëÏÖÄ Î∂ôÏó¨ÎÑ£Í∏∞):",
                "choose_criteria_3": "Í∏∞Ï§Ä 3 ÏÑ†ÌÉù:",
                "apply_filter": "ÌïÑÌÑ∞ Ï†ÅÏö©",
                "clear_filter": "ÌïÑÌÑ∞ ÏßÄÏö∞Í∏∞",
                "download_excel": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (ÌòÑÏû¨ Î≥¥Í∏∞)",
                "export_all": "ÏóëÏÖÄ ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (Ï†ÑÏ≤¥)",
                "zoom_in": "ÌôïÎåÄ",
                "zoom_out": "Ï∂ïÏÜå",
                "load_more": "Îçî Î∂àÎü¨Ïò§Í∏∞",
                "load_all": "Ï†ÑÏ≤¥ Î∂àÎü¨Ïò§Í∏∞",
                "total_rows": "Ï¥ù Ìñâ: {{count}} / {{total}}",
                "developer": "Í∞úÎ∞úÏûê: Nguy·ªÖn VƒÉn VƒÉn",
                "date_from": "ÏãúÏûë ÎÇ†Ïßú:",
                "date_to": "Ï¢ÖÎ£å ÎÇ†Ïßú:",
                "no_image_found": "Î∂ÄÌíà Î≤àÌò∏ \"{{partNumber}}\" (ERP: {{erpCode}})Ïóê ÎåÄÌïú Ïù¥ÎØ∏ÏßÄÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.",
                "no_erp_code": "Î∂ÄÌíà Î≤àÌò∏ \"{{partNumber}}\"Ïóê ÎåÄÌïú Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§. (ERP-CODE ÎàÑÎùΩ)"
              }
            },
            vi: {
              translation: {
                "header_title": "FAIR TEAM - Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "header_subtitle": "Tra c·ª©u t√¨nh tr·∫°ng FAIR",
                "choose_project": "Ch·ªçn d·ª± √°n",
                "choose_value": "Ch·ªçn gi√° tr·ªã",
                "choose_criteria_1": "Ch·ªçn ti√™u ch√≠ s·ªë 1:",
                "choose_criteria_2": "Ch·ªçn ti√™u ch√≠ s·ªë 2 (paste ex):",
                "choose_criteria_3": "Ch·ªçn ti√™u ch√≠ s·ªë 3:",
                "apply_filter": "√Åp d·ª•ng l·ªçc",
                "clear_filter": "X√≥a l·ªçc",
                "download_excel": "Xu·∫•t Excel (ƒêang xem)",
                "export_all": "Xu·∫•t Excel (T·∫•t c·∫£)",
                "zoom_in": "Ph√≥ng to",
                "zoom_out": "Thu nh·ªè",
                "load_more": "T·∫£i th√™m",
                "load_all": "T·∫£i to√†n b·ªô",
                "total_rows": "T·ªïng s·ªë d√≤ng: {{count}} / {{total}}",
                "developer": "Ng∆∞·ªùi ph√°t tri·ªÉn: Nguy·ªÖn VƒÉn ƒê·∫°o",
                "date_from": "T·ª´ ng√†y:",
                "date_to": "ƒê·∫øn ng√†y:",
                "no_image_found": "·∫¢nh cho Part Number \"{{partNumber}}\" (ERP: {{erpCode}}) kh√¥ng t·ªìn t·∫°i.",
                "no_erp_code": "Kh√¥ng c√≥ ·∫£nh cho Part Number \"{{partNumber}}\". (Thi·∫øu ERP-CODE)"
              }
            }
          }
        }, function(err, t) {
          updateStaticContent();
        });

        function reinitializeSelect2(selector, placeholder, extraOptions) {
          var $el = $(selector);
          var currentValue = $el.val();
          if ($el.data('select2')) { 
            $el.select2("destroy");
          }
          $el.select2($.extend({
            placeholder: placeholder,
            allowClear: true,
            width: '100%'
          }, extraOptions));
          if(currentValue) { 
            $el.val(currentValue).trigger('change.select2'); 
          }
        }

        function updateStaticContent() {
          document.getElementById("header-title").innerText = i18next.t("header_title");
          document.getElementById("header-subtitle").innerText = i18next.t("header_subtitle");
          var labelSheet = document.querySelector('label[for="filter-project"]');
          if (labelSheet) { labelSheet.innerText = i18next.t("choose_project"); }
          
          for (let i = 1; i <= 3; i++) {
            var labelCriteria = document.getElementById(`label-criteria-${i}`);
            if (labelCriteria) { labelCriteria.innerText = i18next.t(`choose_criteria_${i}`); }
            
            var labelValue = document.getElementById(`label-filter-value-${i}`);
            if (labelValue) { labelValue.innerText = i18next.t("choose_value"); }

            var labelDateFrom = $(`#date-range-${i} label[for="filter-date-start-${i}"]`);
            if (labelDateFrom.length) { labelDateFrom.text(i18next.t("date_from")); }
            var labelDateTo = $(`#date-range-${i} label[for="filter-date-end-${i}"]`);
            if (labelDateTo.length) { labelDateTo.text(i18next.t("date_to")); }
          }
          
          var tbodyCount = $('#results-table tbody').children().length;
          $('#results-count').text(i18next.t("total_rows", { count: tbodyCount, total: totalData }));

          reinitializeSelect2('#filter-project', i18next.t("choose_project"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-1', i18next.t("choose_value"), { closeOnSelect: false });
          reinitializeSelect2('#filter-value-2', i18next.t("choose_value"), {});
          reinitializeSelect2('#filter-value-3', i18next.t("choose_value"), { closeOnSelect: false });

          document.getElementById("apply-filters").innerText = i18next.t("apply_filter");
          document.getElementById("clear-filters").innerText = i18next.t("clear_filter");
          document.getElementById("download-excel").innerText = i18next.t("download_excel");
          document.getElementById("export-all").innerText = i18next.t("export_all");
          document.getElementById("zoom-in").innerText = i18next.t("zoom_in");
          document.getElementById("zoom-out").innerText = i18next.t("zoom_out");
          document.getElementById("load-more").innerText = i18next.t("load_more");
          document.getElementById("load-all").innerText = i18next.t("load_all");
          document.getElementById("footer-text").innerText = i18next.t("developer");
        }

        function changeLanguage(lng) {
          i18next.changeLanguage(lng, function() {
            updateStaticContent();
            $('.value-select').each(function() {
                const placeholderText = $(this).attr('id') === 'filter-project' ? i18next.t("choose_project") : i18next.t("choose_value");
                $(this).data('select2').$container.find('.select2-selection__placeholder').text(placeholderText);
            });
          });
        }
    </script>
    <script>
        function formatExcelDate(val) {
            if (!val) return '';
            if (typeof val === 'number') {
                let date = new Date(Date.UTC(1899, 11, 30 + val)); 
                if (!isNaN(date)) {
                    const yyyy = date.getUTCFullYear();
                    const mm = String(date.getUTCMonth() + 1).padStart(2, '0');
                    const dd = String(date.getUTCDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            } else if (typeof val === 'string') {
                const parsed = new Date(val);
                if (!isNaN(parsed)) {
                    const yyyy = parsed.getFullYear(); 
                    const mm = String(parsed.getMonth() + 1).padStart(2, '0');
                    const dd = String(parsed.getDate()).padStart(2, '0');
                    return `${yyyy}-${mm}-${dd}`;
                }
            }
            return val; 
        }

        let currentFilters = {};
        let currentOffset = 0;
        const pageSize = 50;
        let totalData = 0;
        let currentZoom = 1;
        let allData = null;

        // --- C√ÅC BI·∫æN THAM CHI·∫æU POPUP ·∫¢NH (KHAI B√ÅO M·ªòT L·∫¶N) ---
        const imagePopup = $('#image-popup');
        const popupImg = imagePopup.find('img');
        const popupText = imagePopup.find('span.no-image-text');
        const popupCloseButton = imagePopup.find('.image-popup-close');
        const popupSpinner = imagePopup.find('.image-popup-spinner'); // Spinner m·ªõi


        function loadAllData() {
          $.getJSON('/search?limit=1000000', function(response) { 
            allData = response.data;
            totalData = response.total;
            updateFilterValuesForBlock(1);
            updateCascade(2); 
          });
        }

        function loadDistinctValuesForProject() {
          const selectElem = $('#filter-project');
          selectElem.empty();
          $.getJSON('/filters', function(data) {
            if (data['Customer']) {
              data['Customer'].forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
              });
            }
            selectElem.trigger('change');
          });
        }

        function handleFilterTypeChange(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const valueSelectContainer = $('#filter-value-' + blockIndex).next('.select2-container');
            const valueSelect = $('#filter-value-' + blockIndex);
            const dateRangeInputs = $(`#date-range-${blockIndex}`);
            const labelValue = $(`label[for="filter-value-${blockIndex}"]`);

            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                valueSelectContainer.hide();
                valueSelect.hide();
                dateRangeInputs.show();
                labelValue.hide(); 
            } else {
                dateRangeInputs.hide();
                valueSelectContainer.show();
                valueSelect.show();
                labelValue.show().text(i18next.t("choose_value"));
            }
        }


        $(document).ready(function() {
            loadAllData();
            loadDistinctValuesForProject();

            $('.value-select').not('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-project').select2({
                placeholder: i18next.t("choose_project"),
                allowClear: true,
                width: '100%',
                closeOnSelect: false
            });
            $('#filter-value-2').select2({
                placeholder: i18next.t("choose_value"),
                allowClear: true,
                width: '100%'
            });

            handleFilterTypeChange(1);
            handleFilterTypeChange(2);
            handleFilterTypeChange(3);


            $(document).on('paste', '#filter-value-2 ~ .select2 .select2-search__field', function(e) {
                e.preventDefault();
                var clipboardData = e.originalEvent.clipboardData.getData('text/plain');
                var values = clipboardData.split(/\r?\n/).reduce(function(acc, line) {
                  return acc.concat(line.split('\t'));
                }, []).filter(function(val) {
                  return val.trim() !== '';
                });
                var $select = $('#filter-value-2');
                var currentValues = $select.val() || [];
                var newValues = currentValues.concat(values);
                newValues = Array.from(new Set(newValues));
                $select.val(newValues).trigger('change');
            });

            $('#filter-project').on('change', function(){
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });

            $('#filter-column-1').on('change', function() {
                handleFilterTypeChange(1);
                updateFilterValuesForBlock(1);
                updateCascade(2);
            });
            $('#filter-value-1, #filter-date-start-1, #filter-date-end-1').on('change', function() {
                updateCascade(2);
            });
            $('#filter-column-2').on('change', function() {
                handleFilterTypeChange(2);
                updateFilterValuesForBlock(2);
                updateCascade(3);
            });
            $('#filter-value-2, #filter-date-start-2, #filter-date-end-2').on('change', function() {
                updateCascade(3);
            });
            $('#filter-column-3').on('change', function() {
                handleFilterTypeChange(3);
                updateFilterValuesForBlock(3);
            });

            $('#apply-filters').on('click', function() {
                const col1 = $('#filter-column-1').val();
                const val1 = $('#filter-value-1').val();
                if (col1 === 'Part Number' && val1 && val1.length > 0) {
                  val1.forEach(p => saveSearchHistory(p));
                }
                applyFilters(true);
            });
            $('#clear-filters').on('click', function() {
                $('.value-select').val(null).trigger('change');
                $('#filter-value-2').val(null).trigger('change');
                $('.date-select-start').val(''); 
                $('.date-select-end').val(''); 
                handleFilterTypeChange(1);
                handleFilterTypeChange(2);
                handleFilterTypeChange(3);
                applyFilters(true);
            });
            $('#load-more').on('click', function() {
                let loadMoreFilters = { ...currentFilters, offset: currentOffset, limit: pageSize };
                delete loadMoreFilters.limit; 
                
                if (currentOffset < totalData) {
                    showSpinner();
                    $.getJSON(`/search?${$.param(loadMoreFilters)}`, function(response) {
                        currentOffset += response.data.length; 
                        updateTable(response.data, false); 
                    }).always(function() {
                        hideSpinner();
                    });
                } else {
                    // Using custom modal instead of alert
                    showCustomMessage("ƒê√£ t·∫£i h·∫øt d·ªØ li·ªáu!", "info");
                }
            });
            $('#load-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                queryParams.limit = 1000000; 
                queryParams.offset = 0;
                showSpinner();
                $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                  currentOffset = response.total; 
                  updateTable(response.data, true); 
                }).always(function() {
                    hideSpinner();
                });
            });
            $('#download-excel').on('click', function() { downloadExcel(); });
            $('#export-all').on('click', function() {
                let queryParams = {};
                const sheetValues = $('#filter-project').val();
                if (sheetValues && sheetValues.length > 0) {
                  queryParams["Customer"] = sheetValues.join(',');
                }
                for (let i = 1; i <= 3; i++) {
                  const colSelect = $(`#filter-column-${i}`);
                  const col = colSelect.val();
                  const selectedOptionDataType = colSelect.find('option:selected').data('type');
                  
                  if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;
                  } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                      queryParams[col] = values.join(',');
                    }
                  }
                }
                const queryString = $.param(queryParams);
                window.location.href = `/export?${queryString}`;
            });
            $('#zoom-in').on('click', function() {
                currentZoom += 0.1;
                $('#results-table').css('zoom', currentZoom);
            });
            $('#zoom-out').on('click', function() {
                if (currentZoom > 0.5) {
                  currentZoom -= 0.1;
                  $('#results-table').css('zoom', currentZoom);
                }
            });
            try {
                if (typeof $.fn.colResizable === 'function') {
                  $('#results-table').colResizable({ liveDrag: true });
                }
            } catch(e) {
                console.log("colResizable not available:", e);
            }

            // --- C√ÅC S·ª∞ KI·ªÜN CHO POPUP ·∫¢NH (G·∫ÆN M·ªòT L·∫¶N) ---
            popupCloseButton.off('click.closepopup').on('click.closepopup', function() {
                closeImagePopup();
            });

            $(document).off('mouseup.imagePopupOutside').on('mouseup.imagePopupOutside', function(e) {
                if (imagePopup.is(':visible') && !imagePopup.is(e.target) && imagePopup.has(e.target).length === 0) {
                    closeImagePopup();
                }
            });
            
            popupImg.off('click.zoom').on('click.zoom', function() {
                const $thisImage = $(this);
                if (imagePopup.is(':visible') && $thisImage.is(':visible')) {
                    imagePopup.toggleClass('zoomed');
                    
                    popupSpinner.show(); // Hi·ªÉn th·ªã spinner
                    $thisImage.hide(); // ·∫®n ·∫£nh hi·ªán t·∫°i trong khi t·∫£i ·∫£nh m·ªõi
                    popupText.hide(); // ·∫®n text (n·∫øu c√≥)

                    if (imagePopup.hasClass('zoomed')) {
                        // Popup ƒë∆∞·ª£c ph√≥ng to: T·∫£i ·∫£nh ch·∫•t l∆∞·ª£ng cao
                        const highQualityUrl = imagePopup.data('high-quality-url');
                        if (highQualityUrl) {
                            $thisImage.attr('src', highQualityUrl);
                        } else {
                            console.warn("Kh√¥ng t√¨m th·∫•y URL ·∫£nh ch·∫•t l∆∞·ª£ng cao.");
                            popupText.text(i18next.t('no_image_found', { partNumber: imagePopup.data('current-part-number') || 'N/A', erpCode: imagePopup.data('current-erp') || 'N/A' })).show();
                            popupSpinner.hide();
                            // $thisImage.show(); // Hi·ªán l·∫°i ·∫£nh c≈© n·∫øu c√≥ l·ªói
                        }
                    } else {
                        // Popup b·ªã thu nh·ªè: T·∫£i l·∫°i ·∫£nh thumbnail
                        const thumbnailUrl = imagePopup.data('thumbnail-url');
                        if (thumbnailUrl) {
                            $thisImage.attr('src', thumbnailUrl);
                        } else {
                            console.warn("Kh√¥ng t√¨m th·∫•y URL ·∫£nh thumbnail.");
                            popupText.text(i18next.t('no_image_found', { partNumber: imagePopup.data('current-part-number') || 'N/A', erpCode: imagePopup.data('current-erp') || 'N/A' })).show();
                            popupSpinner.hide();
                            // $thisImage.show(); // Hi·ªán l·∫°i ·∫£nh c≈© n·∫øu c√≥ l·ªói
                        }
                    }
                }
            });
            // K·∫øt th√∫c c√°c s·ª± ki·ªán cho popup ·∫£nh

            applyFilters(true); 
        });

        function updateFilterValuesForBlock(blockIndex) {
            const columnSelect = $('#filter-column-' + blockIndex);
            const selectedOptionDataType = columnSelect.find('option:selected').data('type');

            if (selectedOptionDataType === 'date') {
                return;
            }
            
            if (!allData) {
                setTimeout(function(){ updateFilterValuesForBlock(blockIndex); }, 100);
                return;
            }
            let filteredData = allData.slice();

            const projectValues = $('#filter-project').val();
            if (projectValues && projectValues.length > 0) {
                filteredData = filteredData.filter(row => 
                    projectValues.some(s => row['Customer'] && row['Customer'].toString().toLowerCase().includes(s.toLowerCase()))
                );
            }

            for (let i = 1; i < blockIndex; i++) {
                const colSelectPrev = $(`#filter-column-${i}`);
                const colPrev = colSelectPrev.val();
                const prevOptionType = colSelectPrev.find('option:selected').data('type');
                
                if (prevOptionType === 'date') {
                    const dateStartPrev = $(`#filter-date-start-${i}`).val();
                    const dateEndPrev = $(`#filter-date-end-${i}`).val();
                    if (colPrev && (dateStartPrev || dateEndPrev)) {
                        filteredData = filteredData.filter(row => {
                            const itemDateStr = formatExcelDate(row[colPrev]);
                            if (!itemDateStr) return false;
                            const itemDate = new Date(itemDateStr);
                            let match = true;
                            if (dateStartPrev) {
                                match = match && itemDate >= new Date(dateStartPrev);
                            }
                            if (dateEndPrev) {
                                match = match && itemDate <= new Date(dateEndPrev);
                            }
                            return match;
                        });
                    }
                } else {
                    const valuesPrev = $('#filter-value-' + i).val();
                    if (colPrev && valuesPrev && valuesPrev.length > 0) {
                        filteredData = filteredData.filter(row =>
                            valuesPrev.some(v => row[colPrev] && row[colPrev].toString().toLowerCase().includes(v.toLowerCase()))
                        );
                    }
                }
            }
            
            let dependentColumn = $('#filter-column-' + blockIndex).val();
            let valuesInColumn = filteredData.map(function(row) {
                let cellVal = row[dependentColumn];
                if (columnSelect.find('option[value="' + dependentColumn + '"]').data('type') === 'date') {
                    cellVal = formatExcelDate(cellVal);
                }
                if (cellVal == null || cellVal.toString().trim() === "") return null;
                if (typeof cellVal === 'string') {
                    return cellVal.trim().toUpperCase();
                }
                return cellVal.toString().toUpperCase();
            }).filter(function(v) { return v !== null; });

            let distinctValues = Array.from(new Set(valuesInColumn));
            distinctValues.sort((a, b) => a.localeCompare(b, undefined, {numeric: true, sensitivity: 'base'}));

            const selectElem = $('#filter-value-' + blockIndex);
            const currentValue = selectElem.val();
            selectElem.empty();
            distinctValues.forEach(function(val) {
                const option = new Option(val, val, false, false);
                selectElem.append(option);
            });
            
            if (currentValue) {
                const validCurrentValues = currentValue.filter(v => distinctValues.includes(v));
                selectElem.val(validCurrentValues);
            }
            selectElem.trigger('change.select2');
        }

        function updateCascade(startBlock) {
          for (let i = startBlock; i <= 3; i++) {
            updateFilterValuesForBlock(i);
          }
        }

        function applyFilters(reset = true) {
            if (reset) {
                currentOffset = 0;
            }
            let queryParams = { limit: pageSize, offset: currentOffset };
            const projectFilterValues = $('#filter-project').val();
            if (projectFilterValues && projectFilterValues.length > 0) {
                queryParams["Customer"] = projectFilterValues.join(',');
            }

            for (let i = 1; i <= 3; i++) {
                const colSelect = $(`#filter-column-${i}`);
                const col = colSelect.val();
                const selectedOptionDataType = colSelect.find('option:selected').data('type');
                
                if (selectedOptionDataType === 'date') {
                    const dateStart = $(`#filter-date-start-${i}`).val();
                    const dateEnd = $(`#filter-date-end-${i}`).val();
                    if (dateStart) queryParams[`${col}_start`] = dateStart;
                    if (dateEnd) queryParams[`${col}_end`] = dateEnd;    
                } else {
                    const values = $(`#filter-value-${i}`).val();
                    if (values && values.length > 0) {
                        queryParams[col] = values.join(',');
                    }
                }
            }
            
            currentFilters = {...queryParams}; 
            
            showSpinner();
            $.getJSON(`/search?${$.param(queryParams)}`, function(response) {
                totalData = response.total;
                currentOffset = reset ? response.data.length : currentOffset + response.data.length;
                updateTable(response.data, reset);
            }).always(function() {
                hideSpinner();
            });
        }

        // --- H√ÄM ƒê√ìNG V√Ä RESET POPUP (ƒê√É C√ì TRONG FILE G·ªêC, ƒê·∫¢M B·∫¢O N√ì ƒê∆Ø·ª¢C S·ª¨ D·ª§NG) ---
        function closeImagePopup() {
            imagePopup.hide().removeClass('zoomed');
            popupImg.off('load error').attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ·∫®n spinner khi ƒë√≥ng
            imagePopup.removeData('current-erp');
            imagePopup.removeData('current-part-number');
            imagePopup.removeData('thumbnail-url');
            imagePopup.removeData('high-quality-url');
        }

function updateTable(data, reset) {
    const tbody = $('#results-table tbody');
    if (reset) tbody.empty();

    data.forEach(function(row) {
        const serial = reset ? tbody.children().length + 1 : currentOffset - data.length + tbody.children().length + 1;
        const tr = $('<tr>');
        const partNumberValue = row['Part Number'] || 'N/A'; 

        tr.append(`<td class="sticky-col-1 py-3 px-4 text-sm text-center">${serial}</td>`);
        
        const partNumberCell = $(`<td class="py-3 px-4 text-sm text-center font-medium cursor-pointer text-blue-700 hover:underline">${part partNumberValue}</td>`).addClass('sticky-col-2');
        partNumberCell.css('cursor', 'pointer');

        // --- S·ª¨A ƒê·ªîI S·ª∞ KI·ªÜN CLICK CHO partNumberCell ---
        partNumberCell.on('click', function(e) {
            const currentErpCode = row['ERP-CODE']?.trim().toUpperCase();
            const currentPartNumberValueFromRow = row['Part Number'] || 'N/A'; // L·∫•y tr·ª±c ti·∫øp t·ª´ row

            // Reset tr·∫°ng th√°i popup
            imagePopup.removeClass('zoomed');
            popupImg.off('load error').attr('src', '').hide().css('cursor', 'zoom-in');
            popupText.text('').hide();
            popupSpinner.hide(); // ƒê·∫£m b·∫£o spinner ·∫©n ban ƒë·∫ßu

            // L∆∞u th√¥ng tin c·∫ßn thi·∫øt v√†o data c·ªßa popup
            imagePopup.data('current-erp', currentErpCode);
            imagePopup.data('current-part-number', currentPartNumberValueFromRow);

            if (currentErpCode) {
                const thumbnailUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/w_250,h_250,c_limit,f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;
                const highQualityUrl = `https://res.cloudinary.com/dyjcw9mlz/image/upload/f_auto,q_auto:good/ERP-CODE/${currentErpCode}.jpg`;

                imagePopup.data('thumbnail-url', thumbnailUrl);
                imagePopup.data('high-quality-url', highQualityUrl);

                popupSpinner.show(); // Hi·ªÉn th·ªã spinner tr∆∞·ªõc khi t·∫£i
                popupImg.attr('src', thumbnailUrl); // B·∫Øt ƒë·∫ßu t·∫£i ·∫£nh thumbnail

                // G·∫Øn l·∫°i s·ª± ki·ªán load v√† error
                popupImg.on('load', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    if (expectedErp && $(this).attr('src') && $(this).attr('src').includes(expectedErp)) {
                        popupSpinner.hide(); // ·∫®n spinner khi ·∫£nh t·∫£i xong
                        $(this).show();
                        popupText.hide().text('');
                        if (imagePopup.is(':hidden')) {
                            imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                        }
                    }
                });

                popupImg.on('error', function() {
                    const expectedErp = imagePopup.data('current-erp');
                    const pn = imagePopup.data('current-part-number') || "N/A";
                    if (expectedErp && ($(this).attr('src') === '' || ($(this).attr('src') && $(this).attr('src').includes(expectedErp)))) {
                        popupSpinner.hide(); // ·∫®n spinner khi c√≥ l·ªói
                        $(this).hide();
                        popupText.text(i18next.t('no_image_found', { partNumber: pn, erpCode: expectedErp })).show();
                        if (imagePopup.is(':hidden')) {
                            imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                        }
                    }
                });
                
                if (imagePopup.is(':hidden')) {
                     imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
                }

            } else { // Kh√¥ng c√≥ ERP-CODE
                popupSpinner.hide();
                popupImg.hide();
                popupText.text(i18next.t('no_erp_code', { partNumber: currentPartNumberValueFromRow })).show();
                imagePopup.css({ top: '50%', left: '50%', transform: 'translate(-50%, -50%)' }).show();
            }
        });
        // --- K·∫æT TH√öC S·ª¨A ƒê·ªîI S·ª∞ KI·ªÜN CLICK partNumberCell ---
        
        tr.append(partNumberCell);

        tr.append(`<td class="sticky-col-3 py-3 px-4 text-sm text-center">${row['REV'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Approval Status'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Customer'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Commodity'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Production Status'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Part Pictures'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Packaging Pictures'] || ''}</td>`);

        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Critical'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['CE'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['PO Number'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Description'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['ERP-CODE'] || ''}</td>`); 
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Note Number'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${formatExcelDate(row['PO received date'])}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${formatExcelDate(row['Customer need date'])}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Requirements'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['FAIR Cover sheet'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Bubble Drawings'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Datasheet form'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['LAIR Data'] || row['LAIR data'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['FAIR Data'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['COC'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['BOM'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Mill'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Test reports / evidences'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Remark 1'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Remark 2'] || ''}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${formatExcelDate(row['Submit date'])}</td>`);
        tr.append(`<td class="py-3 px-4 text-sm text-center">${row['Reject comments'] || ''}</td>`);

        tbody.append(tr);
    });

    var totalText = i18next.t("total_rows", { count: tbody.children().length, total: totalData });
    $('#results-count').text(totalText);

    try {
        if ($.fn.colResizable) {
          $('#results-table').colResizable({ liveDrag: true, partialRefresh: true });
        }
    } catch (e) {
        console.log("colResizable not available in updateTable:", e);
    }
}


        function downloadExcel() {
            const table = document.getElementById('results-table');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const dateColumns = ['PO received date', 'Customer need date', 'Submit date'];

            const data = rows.map(tr => {
                const cells = Array.from(tr.querySelectorAll('td'));
                const rowObj = {};
                cells.forEach((td, index) => {
                    let val = td.textContent.trim();
                    const header = headers[index];
                    rowObj[header] = val;
                });
                return rowObj;
            });

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
            XLSX.writeFile(wb, 'ketqua.xlsx');
        }

        function getColumnIndex(columnName) {
          let index = -1;
          $('#results-table th').each(function(i) {
            if ($(this).data('column') === columnName) {
              index = i;
              return false;
            }
          });
          return index;
        }
        function sortTable(column, order) {
          let rows = $('#results-table tbody tr').get();
          let colIndex = getColumnIndex(column);
          if (colIndex === -1) return;

          const isDateColumn = ['PO received date', 'Customer need date', 'Submit date'].includes(column);

          rows.sort(function(a, b) {
            let valA = $(a).children('td').eq(colIndex).text().toUpperCase();
            let valB = $(b).children('td').eq(colIndex).text().toUpperCase();

            if (isDateColumn) {
                const dateA = new Date(valA);
                const dateB = new Date(valB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                }
            }
            return order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          });
          $.each(rows, function(index, row) {
            $('#results-table tbody').append(row);
          });
        }
        $(document).on('click', '#results-table th', function () {
            const col = $(this).data('column');
            if (!col) return;

            const currentOrder = $(this).data('order') || 'asc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

            $('#results-table th').each(function () {
                $(this).data('order', null);
                const text = $(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim();
                $(this).text(text);
            });

            const arrow = newOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
            $(this).text($(this).text().replace(/[‚ñ≤‚ñº]/g, '').trim() + arrow);
            $(this).data('order', newOrder);

            sortTable(col, newOrder);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
    <script>
    // Custom message box function
    function showCustomMessage(message, type = 'info') {
        const modalId = 'customMessageModal';
        let modal = document.getElementById(modalId);
        if (!modal) {
            modal = document.createElement('div');
            modal.id = modalId;
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10000]';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                    <p id="customMessageText" class="text-lg font-semibold mb-4"></p>
                    <button class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">ƒê√≥ng</button>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('button').addEventListener('click', () => modal.style.display = 'none');
        }
        modal.querySelector('#customMessageText').textContent = message;
        modal.style.display = 'flex';
    }

    document.addEventListener('DOMContentLoaded', () => {
      const btnScan = document.getElementById('btnScanCamera');
      const modal = document.getElementById('cameraModal');
      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      const statusP = document.getElementById('ocrStatus');
      let inputOCR = document.getElementById('ocrInput');
      const btnCapture = document.getElementById('btnCapture');
      const btnClose = document.getElementById('btnCloseCamera');
      const btnApply = document.getElementById('btnApplyOcrFilter');
      const zoomSlider = document.getElementById("zoomSlider");
      const zoomContainer = document.getElementById("zoomContainer");
      let stream, intervalId;

      function stopStream() {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
          video.srcObject = null;
        }
        clearInterval(intervalId);
      }

      function cropCenterAndOCR(callback) {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        const cropWidth = canvas.width * 0.8;
        const cropHeight = canvas.height * 0.2;
        const offsetX = canvas.width * 0.1;
        const offsetY = canvas.height * 0.35;
        const imageData = ctx.getImageData(offsetX, offsetY, cropWidth, cropHeight);
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = cropWidth;
        tempCanvas.height = cropHeight;
        tempCanvas.getContext("2d").putImageData(imageData, 0, 0);

        Tesseract.recognize(tempCanvas.toDataURL(), 'eng')
          .then(({ data: { text } }) => callback(text))
          .catch(() => statusP.textContent = '‚ùå L·ªói khi nh·∫≠n di·ªán.');
      }

      btnScan.addEventListener('click', async () => {
        modal.style.display = 'flex';
        statusP.textContent = 'üîÑ ƒêang kh·ªüi ƒë·ªông camera...';
        inputOCR.value = '';
        document.getElementById("ocrInput").style.display = 'block';
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          video.srcObject = stream;
          video.play();

          const track = stream.getVideoTracks()[0];
          const capabilities = track.getCapabilities();
          if (capabilities.zoom) {
            zoomContainer.style.display = 'block';
            zoomSlider.min = capabilities.zoom.min;
            zoomSlider.max = capabilities.zoom.max;
            zoomSlider.step = capabilities.zoom.step || 0.1;
            zoomSlider.value = capabilities.zoom.min;
            zoomSlider.addEventListener("input", () => {
              track.applyConstraints({ advanced: [{ zoom: zoomSlider.value }] });
            });
          }
          statusP.textContent = '‚úÖ ƒê√£ k·∫øt n·ªëi camera. Nh·∫•n "Ch·ª•p & Qu√©t" ho·∫∑c gi·ªØ ch·∫ø ƒë·ªô t·ª± ƒë·ªông';
        } catch (err) {
          statusP.textContent = '‚ùå Kh√¥ng th·ªÉ truy c·∫≠p camera.';
        }
      });

      btnCapture.addEventListener('click', () => {
        statusP.textContent = 'üîç ƒêang qu√©t...';
        cropCenterAndOCR((text) => {
          const lines = text.trim().split('\n').map(l => l.trim()).filter(Boolean);
          if (lines.length === 0) return statusP.textContent = '‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c d√≤ng n√†o.';

          if (lines.length === 1) {
            inputOCR.value = lines[0];
            statusP.textContent = '‚úÖ ƒê√£ nh·∫≠n 1 d√≤ng.';
          } else {
            const selectHTML = `
              <select id="ocrLineSelector" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary text-textDark mt-3">
                ${lines.map(l => `<option>${l}</option>`).join('')}
              </select>
            `;
            inputOCR.insertAdjacentHTML('beforebegin', selectHTML);
            const selector = document.getElementById('ocrLineSelector');
            selector.addEventListener('change', () => {
              inputOCR.value = selector.value;
            });
            inputOCR.value = lines[0];
            statusP.textContent = `‚úÖ ƒê√£ nh·∫≠n ${lines.length} d√≤ng. ƒê√£ ch·ªçn d√≤ng ƒë·∫ßu ti√™n, c√≥ th·ªÉ ch·ªânh s·ª≠a.`;
          }
        });
      });

      btnApply.addEventListener('click', () => {
        const part = inputOCR.value.trim();
        if (!part) {
            showCustomMessage('B·∫°n ch∆∞a nh·∫≠p Part Number!', 'warning');
            return;
        }
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => { 
            $('#filter-value-1').val([part]).trigger('change'); 
            if (typeof applyFilters === 'function') applyFilters(true);
            statusP.textContent = `‚úÖ ƒê√£ l·ªçc v·ªõi Part Number: ${part}`;
            saveSearchHistory(part);
            setTimeout(() => btnClose.click(), 1500);
        }, 50); 
      });

      btnClose.addEventListener('click', () => {
        modal.style.display = 'none';
        zoomContainer.style.display = 'none';
        stopStream();
        document.getElementById("ocrLineSelector")?.remove();
        inputOCR.value = '';
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const activeEl = document.activeElement;
      if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
        setTimeout(() => {
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 300);
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const ocrInput = document.getElementById('ocrInput');
      if (ocrInput) {
        ocrInput.addEventListener('focus', () => {
          setTimeout(() => {
            ocrInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', () => {
      const input = document.getElementById('ocrInput');
      if (input) {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      }
    });
    </script><script>
    document.addEventListener('DOMContentLoaded', function () {
      const inputs = document.querySelectorAll('.filter-grid input, .filter-grid select');
      inputs.forEach((input) => {
        input.addEventListener('focus', () => {
          setTimeout(() => {
            input.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        });
      });
    });
    </script>
    <script>
    function showSpinner() {
      $('#loading-spinner').show();
    }
    function hideSpinner() {
      $('#loading-spinner').hide();
    }

    $('#quick-search').on('input', function () {
      const keyword = $(this).val().toLowerCase();
      $('#results-table tbody tr').each(function () {
        const partNumber = $(this).find('td:nth-child(2)').text().toLowerCase(); 
        $(this).toggle(partNumber.includes(keyword));
      });
    });
    </script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const topArea = document.querySelector('.top-area');
      const tableContainer = document.querySelector('.table-container');
      const quickSearch = document.getElementById('quick-search');
      const applyBtn = document.getElementById('apply-filters');
      const clearBtn = document.getElementById('clear-filters');

      let wasEditingTop = false;

      document.addEventListener('focusin', (e) => {
          if (window.innerWidth >= 768) return;
        const target = e.target;
        if (topArea.contains(target) && ['INPUT', 'SELECT', 'TEXTAREA'].includes(target.tagName)) {
          wasEditingTop = true;
          topArea.classList.add('full-top-container');
          topArea.classList.remove('hide-top-container');
          tableContainer.classList.remove('show-table-only');
          quickSearch.style.display = 'none';
        } else if (target === quickSearch) {
          topArea.classList.add('hide-top-container');
          tableContainer.classList.add('show-table-only');
        }
      });

      document.addEventListener('focusout', () => {
            if (window.innerWidth >= 768) return;
        setTimeout(() => {
          const active = document.activeElement;
          if (!['INPUT', 'SELECT', 'TEXTAREA'].includes(active.tagName)) {
            if (wasEditingTop) {
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'none';
            } else {
              topArea.classList.remove('full-top-container', 'hide-top-container');
              tableContainer.classList.remove('show-table-only');
              quickSearch.style.display = 'block';
            }
          }
        }, 300);
      });

      function revealTableAndSearch() {
        wasEditingTop = false;
        topArea.classList.remove('full-top-container', 'hide-top-container');
        quickSearch.style.display = 'block';
        tableContainer.classList.remove('show-table-only');
      }

      applyBtn?.addEventListener('click', revealTableAndSearch);
      clearBtn?.addEventListener('click', revealTableAndSearch);
    });
    </script>
    <script>
      function saveSearchHistory(partNumber) {
        if (!partNumber) return;
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const now = new Date().toLocaleString("vi-VN");
        const existingIndex = history.findIndex(item => item.partNumber === partNumber);
        if (existingIndex > -1) {
            history.splice(existingIndex, 1);
        }
        history.unshift({ partNumber, time: now });
        if (history.length > 30) history.pop();
        localStorage.setItem("partSearchHistory", JSON.stringify(history));
        renderSearchHistory();
      }

      function renderSearchHistory() {
        const history = JSON.parse(localStorage.getItem("partSearchHistory") || "[]");
        const list = document.getElementById("searchHistory");
        if (!list) return;
        list.innerHTML = "";
        history.forEach(item => {
          const li = document.createElement("li");
          li.className = "mb-3";
          li.innerHTML = `
            <button onclick="quickSearchFromHistory('${item.partNumber.replace(/'/g, "\\'")}'); navigator.clipboard.writeText('${item.partNumber.replace(/'/g, "\\'")}')" 
                    title="Click ƒë·ªÉ tra c·ª©u v√† sao ch√©p" 
                    class="bg-gray-100 hover:bg-gray-200 text-textDark py-2.5 px-4 rounded-lg w-full text-left whitespace-nowrap overflow-hidden text-ellipsis shadow-sm transition duration-300 text-base font-medium">
                ${item.partNumber}
            </button> 
            <small class="text-textLight text-sm block mt-1">(${item.time.split(',')[0]})</small>
          `;
          list.appendChild(li);
        });
      }

      function quickSearchFromHistory(partNumber) {
        $('#filter-column-1').val('Part Number').trigger('change'); 
        setTimeout(() => {
            $('#filter-value-1').val([partNumber]).trigger('change');
            applyFilters(true);
            toggleHistoryPopup(); 
        }, 50);
      }

      function clearSearchHistory() {
        localStorage.removeItem("partSearchHistory");
        renderSearchHistory();
      }
      
      function toggleHistoryPopup() {
          const popup = document.getElementById("floating-history-popup");
          if (popup) {
            const isOpen = popup.style.display === "block";
            popup.style.display = isOpen ? "none" : "block";
            if (!isOpen) {
              renderSearchHistory();
            }
          }
      }
      window.addEventListener("DOMContentLoaded", renderSearchHistory);
    </script>
</body>
</html>
