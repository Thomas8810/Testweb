<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ - Cải tiến</title>
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Các style chung */
    .home-link {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #fff;
      background: #007bff;
      padding: 5px 10px;
      border-radius: 4px;
      text-decoration: none;
      font-weight: bold;
      transition: background 0.3s;
    }
    .home-link:hover {
      background: #0056b3;
    }
    /* Dropzone styles */
    #dropzone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      color: #666;
      transition: background-color 0.3s;
    }
    #dropzone.dragover {
      background-color: #eee;
    }
    /* File preview styles */
    #filePreviewList { margin-top: 10px; }
    .preview-item {
      display: inline-block;
      position: relative;
      margin: 5px;
    }
    .preview-item img, .preview-item span {
      max-width: 150px;
      max-height: 150px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 2px;
    }
    .remove-btn {
      position: absolute;
      top: -5px;
      right: -5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-weight: bold;
      line-height: 18px;
      text-align: center;
    }
    .comments-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 10;
    }
    .table-responsive {
      max-height: calc(100vh - 250px);
      overflow-y: auto;
    }
    #tasksTable th,
    #tasksTable td {
      text-align: center;
      vertical-align: middle;
      white-space: normal;
      word-wrap: break-word;
    }
    #tasksTable {
      table-layout: fixed !important;
      min-width: 1500px !important;
    }
    /* Định nghĩa kích thước cho các cột */
    #tasksTable th:nth-child(1), #tasksTable td:nth-child(1) { width: 50px; }
    #tasksTable th:nth-child(2), #tasksTable td:nth-child(2) { width: 180px; }
    #tasksTable th:nth-child(3), #tasksTable td:nth-child(3) { width: 100px; }
    #tasksTable th:nth-child(4), #tasksTable td:nth-child(4) { width: 100px; }
    #tasksTable th:nth-child(5), #tasksTable td:nth-child(5) { width: 100px; }
    #tasksTable th:nth-child(6), #tasksTable td:nth-child(6) { width: 200px; }
    #tasksTable th:nth-child(7), #tasksTable td:nth-child(7) { width: 120px; }
    #tasksTable th:nth-child(8), #tasksTable td:nth-child(8) { width: 120px; }
    #tasksTable th:nth-child(9), #tasksTable td:nth-child(9) { width: 120px; }
    #tasksTable th:nth-child(10), #tasksTable td:nth-child(10) { width: 550px; }
    /* Style cho modal khi ở chế độ chỉnh sửa */
    .editable-input {
      width: 100%;
      padding: 4px;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- User Welcome Section -->
    <div id="welcome" class="mb-3"></div>
    <a href="/home" class="home-link">Home</a>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs" id="tasksTab" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="list-tab" data-toggle="tab" href="#list-pane" role="tab" aria-controls="list-pane" aria-selected="true">Danh sách nhiệm vụ</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="calendar-tab" data-toggle="tab" href="#calendar-pane" role="tab" aria-controls="calendar-pane" aria-selected="false">Lịch nhiệm vụ</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="report-tab" data-toggle="tab" href="#report-pane" role="tab" aria-controls="report-pane" aria-selected="false">Báo cáo</a>
      </li>
    </ul>

    <div class="tab-content" id="tasksTabContent">
      <!-- Tab Danh sách nhiệm vụ -->
      <div class="tab-pane fade show active" id="list-pane" role="tabpanel" aria-labelledby="list-tab">
        <div class="mt-3">
          <!-- Task Statistics Dashboard -->
          <div class="row mb-3">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body p-2">
                  <div class="row">
                    <div class="col-md-3 col-6 text-center mb-2">
                      <div class="task-stat" id="total-tasks">
                        <h4 class="m-0">0</h4>
                        <small>Tổng nhiệm vụ</small>
                      </div>
                    </div>
                    <div class="col-md-3 col-6 text-center mb-2">
                      <div class="task-stat bg-danger text-white">
                        <h4 class="m-0" id="pending-tasks">0</h4>
                        <small>Chưa thực hiện</small>
                      </div>
                    </div>
                    <div class="col-md-3 col-6 text-center mb-2">
                      <div class="task-stat bg-warning text-dark">
                        <h4 class="m-0" id="progress-tasks">0</h4>
                        <small>Đang thực hiện</small>
                      </div>
                    </div>
                    <div class="col-md-3 col-6 text-center mb-2">
                      <div class="task-stat bg-success text-white">
                        <h4 class="m-0" id="completed-tasks">0</h4>
                        <small>Hoàn thành</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tìm kiếm & Sắp xếp -->
          <div class="row mb-3">
            <div class="col-md-4 col-sm-12 mb-2">
              <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm nhiệm vụ...">
            </div>
            <div class="col-md-4 col-sm-6 mb-2">
              <select id="sortSelect" class="form-control">
                <option value="">Sắp xếp theo...</option>
                <option value="deadline">Deadline</option>
                <option value="priority">Ưu tiên</option>
                <option value="status">Trạng thái</option>
              </select>
            </div>
            <div class="col-md-4 col-sm-6 mb-2">
              <div class="btn-group btn-block" role="group">
                <button type="button" class="btn btn-outline-secondary" onclick="filterByStatus('all')">Tất cả</button>
                <button type="button" class="btn btn-outline-danger" onclick="filterByStatus('Chưa thực hiện')">Chưa làm</button>
                <button type="button" class="btn btn-outline-warning" onclick="filterByStatus('Đang thực hiện')">Đang làm</button>
                <button type="button" class="btn btn-outline-success" onclick="filterByStatus('Hoàn thành')">Hoàn thành</button>
              </div>
            </div>
          </div>

          <!-- Lọc theo người (admin) -->
          <div id="filter-section" style="display: none;" class="mb-3">
            <label for="filterAssigned">Lọc theo người nhận:</label>
            <select id="filterAssigned" class="form-control" onchange="filterTasks()">
              <option value="">-- Tất cả --</option>
              <option value="Thiet">Thiet</option>
              <option value="Son">Son</option>
              <option value="Hai">Hai</option>
              <option value="Duc">Duc</option>
              <option value="Long">Long</option>
              <option value="SongJisub">SongJisub</option>
              <option value="Ha">Ha</option>
            </select>
          </div>

          <!-- Phần tạo nhiệm vụ mới (cho admin) -->
          <div id="createTaskContainer" class="mb-3">
            <button class="btn btn-primary" type="button" data-toggle="collapse" data-target="#createTaskForm" aria-expanded="false" aria-controls="createTaskForm">
              Tạo nhiệm vụ mới
            </button>
            <div class="collapse mt-3" id="createTaskForm">
              <form id="taskForm">
                <div class="form-group">
                  <label for="taskTitle">Tên nhiệm vụ:</label>
                  <input type="text" class="form-control" id="taskTitle" required>
                </div>
                <div class="form-group">
                  <label for="taskAssigned">Giao cho:</label>
                  <select class="form-control" id="taskAssigned" required>
                    <option value="">Chọn người nhận</option>
                    <option value="Thiet">Thiet</option>
                    <option value="Son">Son</option>
                    <option value="Hai">Hai</option>
                    <option value="Duc">Duc</option>
                    <option value="Long">Long</option>
                    <option value="SongJisub">SongJisub</option>
                    <option value="Ha">Ha</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="taskPriority">Mức độ ưu tiên:</label>
                  <select class="form-control" id="taskPriority" required>
                    <option value="cao">Ưu tiên cao</option>
                    <option value="trungbinh">Trung bình</option>
                    <option value="thap">Không ưu tiên</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="taskDeadline">Thời hạn:</label>
                  <input type="date" class="form-control" id="taskDeadline" required>
                </div>
                <div class="form-group">
                  <label for="taskDescription">Mô tả:</label>
                  <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                </div>
                <!-- Dropzone với hướng dẫn rõ ràng -->
                <div id="dropzone">Kéo & thả file hoặc copy dán ảnh vào đây</div>
                <div class="form-group">
                  <label for="taskImage">Chọn file (ảnh/tài liệu):</label>
                  <input type="file" class="form-control-file" id="taskImage" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" multiple>
                  <div id="filePreviewList"></div>
                </div>
                <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
              </form>
            </div>
          </div>

          <!-- Bảng nhiệm vụ -->
          <div class="table-responsive">
            <table class="table table-bordered" id="tasksTable">
              <thead>
                <tr>
                  <th>STT</th>
                  <th>Tên nhiệm vụ</th>
                  <th>Người nhận</th>
                  <th>Mức ưu tiên</th>
                  <th>Thời hạn</th>
                  <th>Mô tả</th>
                  <th>Trạng thái</th>
                  <th>File đính kèm</th>
                  <th>Hình ảnh</th>
                  <th>Hành động</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- Khu vực hiển thị tiến độ -->
          <div id="progress-bars"></div>
        </div>
      </div>

      <!-- Tab Lịch nhiệm vụ -->
      <div class="tab-pane fade" id="calendar-pane" role="tabpanel" aria-labelledby="calendar-tab">
        <div class="mt-3">
          <h3>Lịch nhiệm vụ</h3>
          <div id="calendar"></div>
        </div>
      </div>

      <!-- Tab Báo cáo -->
      <div class="tab-pane fade" id="report-pane" role="tabpanel" aria-labelledby="report-tab">
        <div class="mt-3">
          <h3>Báo cáo nhiệm vụ</h3>
          <canvas id="tasksChart" width="400" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal Chi tiết nhiệm vụ -->
  <div class="modal fade" id="taskDetailModal" tabindex="-1" role="dialog" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="taskDetailModalLabel">Chi tiết nhiệm vụ</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close" onclick="cancelEditTask()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Hiển thị thông tin nhiệm vụ; chuyển sang input khi ở chế độ chỉnh sửa -->
          <div class="row">
            <div class="col-md-6">
              <div class="task-detail-item">
                <strong>Tên nhiệm vụ:</strong>
                <div id="detail-title"></div>
              </div>
              <div class="task-detail-item">
                <strong>Người nhận:</strong>
                <div id="detail-assigned"></div>
              </div>
              <div class="task-detail-item">
                <strong>Mức ưu tiên:</strong>
                <div id="detail-priority"></div>
              </div>
              <div class="task-detail-item">
                <strong>Thời hạn:</strong>
                <div id="detail-deadline"></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="task-detail-item">
                <strong>Mô tả:</strong>
                <div id="detail-description"></div>
              </div>
              <div class="task-detail-item">
                <strong>File đính kèm:</strong>
                <div id="detail-attachments"></div>
              </div>
              <div class="task-detail-item">
                <strong>Hình ảnh:</strong>
                <div id="detail-image"></div>
              </div>
            </div>
          </div>
          <hr>
          <!-- Phần bình luận -->
          <div class="task-detail-comments">
            <h6><i class="fa fa-comments"></i> Bình luận</h6>
            <div id="detail-comments-list" class="comments-list"></div>
            <div class="comment-input-area mt-3">
              <textarea id="detail-new-comment" class="form-control" rows="2" placeholder="Nhập bình luận của bạn..."></textarea>
              <button class="btn btn-primary btn-sm mt-2" id="detail-post-comment">
                <i class="fa fa-paper-plane"></i> Gửi
              </button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <div id="detail-action-buttons" class="text-right w-100"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts: jQuery, Popper, Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>

  <script>
    let currentUser = null;
    let selectedFiles = [];
    let editing = false;
    let currentTaskId = null;
    let originalTaskData = {}; // Lưu dữ liệu ban đầu khi chuyển sang chế độ chỉnh sửa

    window.tasksChart = null;

    // 1) Kiểm tra đăng nhập
    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (!data.success) {
          window.location.href = '/login.html';
          return;
        }
        currentUser = data.user;
        document.getElementById('welcome').innerText =
          `Xin chào ${currentUser.name} - Vai trò: ${currentUser.role}`;
        if (currentUser.role === 'admin') {
          document.getElementById('createTaskContainer').style.display = 'block';
          document.getElementById('filter-section').style.display = 'block';
        } else {
          document.getElementById('createTaskContainer').style.display = 'none';
          document.getElementById('filter-section').style.display = 'none';
        }
      } catch (err) {
        console.error("Error checking auth:", err);
        window.location.href = '/login.html';
      }
    }

    // 2) Hàm load Report
    async function loadReport() {
      try {
        const res = await fetch('/api/tasks');
        const tasks = await res.json();
        let counts = { "Chưa thực hiện": 0, "Đang thực hiện": 0, "Hoàn thành": 0 };
        tasks.forEach(task => {
          if (counts[task.status] !== undefined) {
            counts[task.status]++;
          }
        });
        const canvas = document.getElementById('tasksChart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (window.tasksChart && typeof window.tasksChart.destroy === 'function') {
          window.tasksChart.destroy();
        }
        window.tasksChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(counts),
            datasets: [{
              label: 'Số lượng nhiệm vụ',
              data: Object.values(counts),
              backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
          },
          options: { scales: { y: { beginAtZero: true } } }
        });
      } catch (err) {
        console.error("Error loading report:", err);
      }
    }

    // 3) Hàm load Calendar
    async function loadCalendar() {
      try {
        const res = await fetch('/api/tasks');
        const tasks = await res.json();
        const events = tasks.map(task => ({
          id: task.id,
          title: task.title,
          start: task.deadline,
          color: (task.status === "Hoàn thành") ? 'green'
                 : (task.status === "Đang thực hiện") ? 'orange' : 'red',
          extendedProps: {
            assignedTo: task.assignedTo,
            priority: task.priority,
            status: task.status,
            description: task.description
          }
        }));
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events,
          editable: (currentUser && currentUser.role === 'admin'),
          eventDidMount: function(info) {
            const ext = info.event.extendedProps;
            const tooltipContent = `
              <b>${info.event.title}</b><br>
              Người nhận: ${ext.assignedTo || ''}<br>
              Ưu tiên: ${ext.priority || ''}<br>
              Trạng thái: ${ext.status || ''}<br>
              Mô tả: ${ext.description || ''}
            `;
            info.el.setAttribute('title', tooltipContent);
          },
          eventClick: function(info) {
            const ext = info.event.extendedProps;
            const details = `
Nhiệm vụ: ${info.event.title}
Người nhận: ${ext.assignedTo || ''}
Trạng thái: ${ext.status || ''}
Ưu tiên: ${ext.priority || ''}
Mô tả: ${ext.description || ''}
            `;
            alert(details);
          },
          eventDrop: async (info) => {
            const newDeadline = info.event.start.toISOString().split('T')[0];
            try {
              const res = await fetch(`/api/tasks/${info.event.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deadline: newDeadline })
              });
              const result = await res.json();
              if (!result.success) {
                alert("Lỗi cập nhật deadline: " + result.message);
                info.revert();
              } else {
                loadTasks();
                loadReport();
              }
            } catch (error) {
              console.error("Error updating deadline:", error);
              info.revert();
            }
          }
        });
        calendar.render();
      } catch (err) {
        console.error("Error loading calendar:", err);
      }
    }

    // 4) Xử lý Drag & Drop, Copy Dán và Preview file
    document.getElementById('taskImage').addEventListener('change', e => {
      const files = Array.from(e.target.files);
      files.forEach(file => addSelectedFile(file));
    });
    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const files = Array.from(e.dataTransfer.files);
      files.forEach(file => addSelectedFile(file));
    });
    document.addEventListener('paste', e => {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].kind === 'file') {
          const file = items[i].getAsFile();
          addSelectedFile(file);
        }
      }
    });
    function addSelectedFile(file) {
      selectedFiles.push(file);
      renderFilePreviews();
    }
    function renderFilePreviews() {
      const container = document.getElementById('filePreviewList');
      container.innerHTML = '';
      selectedFiles.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'preview-item';
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = e => {
            div.innerHTML = `
              <img src="${e.target.result}" alt="${file.name}">
              <button type="button" class="remove-btn" onclick="removeSelectedFile(${index})">×</button>
            `;
            container.appendChild(div);
          };
          reader.readAsDataURL(file);
        } else {
          div.innerHTML = `
            <span>${file.name}</span>
            <button type="button" class="remove-btn" onclick="removeSelectedFile(${index})">×</button>
          `;
          container.appendChild(div);
        }
      });
    }
    function removeSelectedFile(index) {
      selectedFiles.splice(index, 1);
      renderFilePreviews();
    }

    let currentStatusFilter = 'all';
    function filterByStatus(status) {
      currentStatusFilter = status;
      loadTasks();
    }

    // 5) Mở modal chi tiết nhiệm vụ
    function openTaskDetail(taskId) {
      currentTaskId = taskId;
      editing = false;
      cancelEditTask();
      const rows = document.querySelectorAll('#tasksTable tbody tr');
      let taskData = null;
      for (const row of rows) {
        if (row.querySelector(`button[onclick*="${taskId}"]`)) {
          const cells = row.querySelectorAll('td');
          taskData = {
            id: taskId,
            title: cells[1].textContent,
            assignedTo: cells[2].textContent,
            priority: cells[3].textContent,
            deadline: cells[4].textContent,
            description: cells[5].textContent,
            status: cells[6].textContent,
            attachments: cells[7].innerHTML,
            imageURL: cells[8].querySelector('img') ? cells[8].querySelector('img').src : null
          };
          break;
        }
      }
      if (!taskData) {
        console.error('Task data not found for ID:', taskId);
        return;
      }
      originalTaskData = { ...taskData };

      document.getElementById('detail-title').textContent = taskData.title;
      document.getElementById('detail-assigned').textContent = taskData.assignedTo;
      document.getElementById('detail-priority').textContent = taskData.priority;
      document.getElementById('detail-deadline').textContent = taskData.deadline;
      document.getElementById('detail-description').textContent = taskData.description || 'Không có mô tả';
      document.getElementById('detail-attachments').innerHTML = taskData.attachments;
      const imageContainer = document.getElementById('detail-image');
      if (taskData.imageURL) {
        imageContainer.innerHTML = `<a href="${taskData.imageURL}" target="_blank">
          <img src="${taskData.imageURL}" style="max-width:100%; max-height:200px;" alt="Task image">
        </a>`;
      } else {
        imageContainer.innerHTML = '<span class="text-muted">Không có hình ảnh</span>';
      }
      loadDetailComments(taskId);
      setupDetailActionButtons(taskData);
      document.getElementById('detail-post-comment').onclick = () => {
        const commentText = document.getElementById('detail-new-comment').value.trim();
        if (commentText) {
          postDetailComment(taskId, commentText);
        }
      };
      $('#taskDetailModal').modal('show');
    }

    // 6) Các hàm chỉnh sửa nhiệm vụ (cho admin)
    function enableEditTask() {
      if (currentUser.role !== 'admin' || editing) return;
      editing = true;
      const titleEl = document.getElementById('detail-title');
      titleEl.innerHTML = `<input type="text" id="edit-title" class="editable-input" value="${originalTaskData.title}">`;
      
      const assignedEl = document.getElementById('detail-assigned');
      assignedEl.innerHTML = `<select id="edit-assigned" class="editable-input">
        <option value="Thiet">Thiet</option>
        <option value="Son">Son</option>
        <option value="Hai">Hai</option>
        <option value="Duc">Duc</option>
        <option value="Long">Long</option>
        <option value="SongJisub">SongJisub</option>
        <option value="Ha">Ha</option>
      </select>`;
      document.getElementById('edit-assigned').value = originalTaskData.assignedTo;
      
      const priorityEl = document.getElementById('detail-priority');
      priorityEl.innerHTML = `<select id="edit-priority" class="editable-input">
        <option value="cao">Ưu tiên cao</option>
        <option value="trungbinh">Trung bình</option>
        <option value="thap">Không ưu tiên</option>
      </select>`;
      let prioVal = originalTaskData.priority.toLowerCase().includes("cao") ? "cao" :
                    originalTaskData.priority.toLowerCase().includes("trung") ? "trungbinh" : "thap";
      document.getElementById('edit-priority').value = prioVal;
      
      const deadlineEl = document.getElementById('detail-deadline');
      deadlineEl.innerHTML = `<input type="date" id="edit-deadline" class="editable-input" value="${originalTaskData.deadline}">`;
      
      const descEl = document.getElementById('detail-description');
      descEl.innerHTML = `<textarea id="edit-description" class="editable-input" rows="3">${originalTaskData.description}</textarea>`;

      const actionContainer = document.getElementById('detail-action-buttons');
      actionContainer.innerHTML = `
        <button class="btn btn-success" onclick="saveTaskEdits(${currentTaskId})">Lưu</button>
        <button class="btn btn-secondary" onclick="cancelEditTask()">Hủy</button>
      `;
    }

    function cancelEditTask() {
      if (!editing) return;
      editing = false;
      document.getElementById('detail-title').textContent = originalTaskData.title;
      document.getElementById('detail-assigned').textContent = originalTaskData.assignedTo;
      document.getElementById('detail-priority').textContent = originalTaskData.priority;
      document.getElementById('detail-deadline').textContent = originalTaskData.deadline;
      document.getElementById('detail-description').textContent = originalTaskData.description || 'Không có mô tả';
      setupDetailActionButtons(originalTaskData);
    }

    async function saveTaskEdits(taskId) {
      const updatedData = {
        title: document.getElementById('edit-title').value,
        assignedTo: document.getElementById('edit-assigned').value,
        priority: document.getElementById('edit-priority').value,
        deadline: document.getElementById('edit-deadline').value,
        description: document.getElementById('edit-description').value
      };
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });
        const result = await res.json();
        if (!result.success) {
          alert("Lỗi cập nhật nhiệm vụ: " + result.message);
          return;
        }
        showToast("Cập nhật nhiệm vụ thành công!");
        cancelEditTask();
        loadTasks();
        loadReport();
        $('#taskDetailModal').modal('hide');
      } catch (error) {
        console.error("Error updating task:", error);
        showToast("Lỗi cập nhật nhiệm vụ: " + error.message);
      }
    }

    // 7) Hàm xử lý bình luận
    async function loadDetailComments(taskId) {
      try {
        const res = await fetch(`/api/tasks/${taskId}/comments`);
        const comments = await res.json();
        const list = document.getElementById('detail-comments-list');
        list.innerHTML = '';
        if (comments.length === 0) {
          list.innerHTML = '<p class="text-center text-muted"><i>Chưa có bình luận nào</i></p>';
        } else {
          comments.forEach(c => {
            const p = document.createElement('p');
            const formattedDate = new Date(c.created_at).toLocaleString('vi-VN', {
              year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            p.innerHTML = `
              <span class="comment-user">${c.user}</span>
              <span class="comment-date">${formattedDate}</span><br>
              ${c.comment_text.replace(/\n/g, '<br>')}
            `;
            list.appendChild(p);
          });
        }
      } catch (err) {
        console.error("Error loading detail comments:", err);
      }
    }

    async function postDetailComment(taskId, commentText) {
      try {
        const submitBtn = document.getElementById('detail-post-comment');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Đang gửi...';
        const res = await fetch(`/api/tasks/${taskId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_text: commentText })
        });
        const result = await res.json();
        if (result.success) {
          document.getElementById('detail-new-comment').value = '';
          await loadDetailComments(taskId);
          await loadCommentCount(taskId);
        } else {
          showToast("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error posting detail comment:", err);
        showToast("Lỗi kết nối: Không thể gửi bình luận");
      } finally {
        const submitBtn = document.getElementById('detail-post-comment');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i> Gửi';
      }
    }

    function setupDetailActionButtons(taskData) {
      const container = document.getElementById('detail-action-buttons');
      let buttons = `<button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="cancelEditTask()">Đóng</button>`;
      if (currentUser && currentUser.role === 'admin') {
        buttons += ` <button class="btn btn-primary" onclick="enableEditTask()">Sửa</button>`;
      }
      container.innerHTML = buttons;
    }

    // 8) Hàm upload hình ảnh và file
    async function uploadImage(file) {
      try {
        const formData = new FormData();
        formData.append('image', file);
        const res = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });
        return await res.json();
      } catch (err) {
        console.error("Error uploadImage:", err);
        return { success: false, message: err?.message || "Unknown error" };
      }
    }
    async function uploadAttachment(taskId, file) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        const res = await fetch(`/api/tasks/${taskId}/attachments`, {
          method: 'POST',
          body: formData
        });
        return await res.json();
      } catch (err) {
        console.error("Error uploadAttachment:", err);
        return { success: false, message: err?.message || "Unknown error" };
      }
    }

    // 9) Hàm load danh sách nhiệm vụ
    async function loadTasks() {
      try {
        if (!currentUser) return;
        let url = '/api/tasks';
        if (currentUser.role === 'admin') {
          const assigned = document.getElementById('filterAssigned').value;
          if (assigned) url += `?assignedTo=${encodeURIComponent(assigned)}`;
        }
        const res = await fetch(url);
        let tasks = await res.json();
        const taskStats = {
          total: tasks.length,
          pending: tasks.filter(t => t.status === 'Chưa thực hiện').length,
          progress: tasks.filter(t => t.status === 'Đang thực hiện').length,
          completed: tasks.filter(t => t.status === 'Hoàn thành').length
        };
        document.getElementById('total-tasks').querySelector('h4').textContent = taskStats.total;
        document.getElementById('pending-tasks').textContent = taskStats.pending;
        document.getElementById('progress-tasks').textContent = taskStats.progress;
        document.getElementById('completed-tasks').textContent = taskStats.completed;
        const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
        if (searchVal) {
          tasks = tasks.filter(task => {
            return (task.title && task.title.toLowerCase().includes(searchVal)) ||
                   (task.description && task.description.toLowerCase().includes(searchVal)) ||
                   (task.assignedTo && task.assignedTo.toLowerCase().includes(searchVal));
          });
        }
        if (currentStatusFilter !== 'all') {
          tasks = tasks.filter(task => task.status === currentStatusFilter);
        }
        const sortVal = document.getElementById('sortSelect').value;
        if (sortVal === 'deadline') {
          tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
        } else if (sortVal === 'priority') {
          const order = { 'cao': 1, 'trungbinh': 2, 'thap': 3 };
          tasks.sort((a, b) => order[a.priority] - order[b.priority]);
        } else if (sortVal === 'status') {
          const order = { 'Chưa thực hiện': 1, 'Đang thực hiện': 2, 'Hoàn thành': 3 };
          tasks.sort((a, b) => order[a.status] - order[b.status]);
        }
        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        let stt = 1;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (const task of tasks) {
          const deadlineDate = new Date(task.deadline);
          deadlineDate.setHours(0, 0, 0, 0);
          const isOverdue = deadlineDate < today && task.status !== 'Hoàn thành';
          let actionButtons = '';
          if (task.status === "Chưa thực hiện" && currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-info btn-sm" onclick="startTask(${task.id})">Nhận</button> `;
          }
          if (task.status !== "Hoàn thành" && (currentUser.role === 'admin' || currentUser.name === task.assignedTo)) {
            actionButtons += `<button class="btn btn-success btn-sm" onclick="completeTask(${task.id})">Hoàn thành</button> `;
          }
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-warning btn-sm" onclick="handoverTask(${task.id})">Bàn giao</button> `;
          }
          if (currentUser.role === 'admin' || currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-secondary btn-sm" onclick="uploadAttachmentPrompt(${task.id})">Upload File</button> `;
          }
          actionButtons += `<button class="btn btn-info btn-sm comment-btn" onclick="toggleComments(${task.id})">
            <i class="fa fa-comment"></i> Comment <span id="comment-count-${task.id}" class="comment-count">0</span>
          </button> `;
          actionButtons += `<button class="btn btn-primary btn-sm" onclick="openTaskDetail(${task.id})">
            <i class="fa fa-eye"></i> Chi tiết
          </button> `;
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Xóa</button>`;
          }
          const tr = document.createElement('tr');
          if (isOverdue) {
            tr.classList.add('task-overdue');
          }
          let priorityDisplay = '';
          if (task.priority === 'cao') {
            priorityDisplay = '<span class="priority-cao">Ưu tiên cao</span>';
          } else if (task.priority === 'trungbinh') {
            priorityDisplay = '<span class="priority-trungbinh">Trung bình</span>';
          } else {
            priorityDisplay = '<span class="priority-thap">Không ưu tiên</span>';
          }
          let statusDisplay = '';
          if (task.status === 'Chưa thực hiện') {
            statusDisplay = '<span class="status-badge status-pending">Chưa thực hiện</span>';
          } else if (task.status === 'Đang thực hiện') {
            statusDisplay = '<span class="status-badge status-progress">Đang thực hiện</span>';
          } else {
            statusDisplay = '<span class="status-badge status-completed">Hoàn thành</span>';
          }
          const deadlineDisplay = isOverdue ? `<span class="text-danger font-weight-bold">${task.deadline}</span>` : task.deadline;
          tr.innerHTML = `
            <td>${stt}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${priorityDisplay}</td>
            <td>${deadlineDisplay}</td>
            <td>${task.description || ''}</td>
            <td>${statusDisplay}</td>
            <td id="attachments-${task.id}"></td>
            <td>
              ${
                task.imageURL
                  ? `<a href="${task.imageURL}" target="_blank" download>
                       <img src="${task.imageURL}" style="max-width:100px;" alt="thumbnail">
                     </a>`
                  : 'N/A'
              }
            </td>
            <td>
              ${actionButtons}
              <div id="comments-${task.id}" class="comments-container" style="display:none;">
                <h6><i class="fa fa-comments"></i> Bình luận</h6>
                <div id="comments-list-${task.id}" class="comments-list"></div>
                <div class="comment-input-area">
                  <textarea id="new-comment-${task.id}" class="form-control" rows="2" placeholder="Nhập bình luận của bạn..."></textarea>
                  <div class="comment-actions">
                    <button class="btn btn-outline-secondary btn-sm" onclick="hideComments(${task.id})">Đóng</button>
                    <button class="btn btn-primary btn-sm" onclick="postComment(${task.id})">
                      <i class="fa fa-paper-plane"></i> Gửi
                    </button>
                  </div>
                </div>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
          stt++;
          loadAttachments(task.id);
          loadCommentCount(task.id);
        }
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    async function loadCommentCount(taskId) {
      try {
        const res = await fetch(`/api/tasks/${taskId}/comments`);
        const comments = await res.json();
        const countBadge = document.getElementById(`comment-count-${taskId}`);
        if (countBadge) {
          countBadge.textContent = comments.length;
        }
      } catch (err) {
        console.error(`Error loading comment count for task ${taskId}:`, err);
      }
    }
    function filterTasks() {
      loadTasks();
    }

    // 10) Xử lý submit form giao nhiệm vụ
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const task = {
        title: document.getElementById('taskTitle').value,
        assignedTo: document.getElementById('taskAssigned').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value,
        description: document.getElementById('taskDescription').value,
        status: 'Chưa thực hiện'
      };
      try {
        const createRes = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(task)
        });
        const createResult = await createRes.json();
        if (!createResult.success) {
          showToast("Lỗi tạo nhiệm vụ: " + createResult.message);
          return;
        }
        const newTaskId = createResult.task && createResult.task.id;
        if (!newTaskId) {
          showToast("Không tìm thấy ID của nhiệm vụ vừa tạo!");
          return;
        }
        let mainImageUpdated = false;
        if (selectedFiles.length > 0) {
          for (const file of selectedFiles) {
            if (file.type.startsWith('image/')) {
              const uploadResult = await uploadImage(file);
              if (!uploadResult.success) {
                showToast("Lỗi upload hình ảnh: " + uploadResult.message);
              } else {
                if (!mainImageUpdated) {
                  await updateTaskImage(newTaskId, uploadResult.imageUrl, uploadResult.filePath);
                  mainImageUpdated = true;
                } else {
                  const attResult = await uploadAttachment(newTaskId, file);
                  if (!attResult.success) {
                    showToast("Lỗi upload file đính kèm: " + attResult.message);
                  }
                }
              }
            } else {
              const uploadResult = await uploadAttachment(newTaskId, file);
              if (!uploadResult.success) {
                showToast("Lỗi upload file đính kèm: " + uploadResult.message);
              }
            }
          }
        }
        showToast("Nhiệm vụ và file đính kèm đã được tạo thành công!");
        loadTasks();
        loadReport();
        document.getElementById('taskForm').reset();
        document.getElementById('filePreviewList').innerHTML = '';
        selectedFiles = [];
      } catch (err) {
        console.error("Error creating task:", err);
        showToast("Lỗi tạo nhiệm vụ: " + (err?.message || "Xem log"));
      }
    });

    async function updateTaskImage(taskId, imageUrl, imagePath) {
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageURL: imageUrl, image_path: imagePath })
        });
        const result = await res.json();
        if (!result.success) {
          showToast("Lỗi cập nhật hình ảnh nhiệm vụ: " + result.message);
        }
        return result;
      } catch (error) {
        console.error("Error updating task image:", error);
        showToast("Lỗi cập nhật hình ảnh nhiệm vụ: " + error.message);
      }
    }

    /* Các hàm hỗ trợ khác - bạn có thể thay thế bằng phiên bản đã dùng trong dự án */
    function startTask(taskId) {
      alert("Start Task " + taskId);
    }
    function completeTask(taskId) {
      alert("Complete Task " + taskId);
    }
    function handoverTask(taskId) {
      alert("Handover Task " + taskId);
    }
    function deleteTask(taskId) {
      alert("Delete Task " + taskId);
    }
    function toggleComments(taskId) {
      var container = document.getElementById("comments-" + taskId);
      if (container.style.display === "none" || container.style.display === "") {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }
    function hideComments(taskId) {
      document.getElementById("comments-" + taskId).style.display = "none";
    }
    function postComment(taskId) {
      var commentText = document.getElementById("new-comment-" + taskId).value;
      if (commentText.trim() === "") return;
      alert("Posting comment for task " + taskId + ": " + commentText);
    }
    function loadAttachments(taskId) {
      // Placeholder: Bạn cần tích hợp API load attachments nếu có
      document.getElementById("attachments-" + taskId).innerHTML = "Attachments placeholder";
    }
    function showToast(message) {
      alert(message);
    }
    function uploadAttachmentPrompt(taskId) {
      alert("Chức năng upload file cho task " + taskId);
    }

    // Khởi tạo
    checkAuth().then(() => {
      loadTasks();
      loadCalendar();
      loadReport();
    });
  </script>
</body>
</html>
