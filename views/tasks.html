<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ - Mở Rộng</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <!-- Chart.js cho báo cáo -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .preview-img {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
    #dropzone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      color: #666;
      transition: background-color 0.3s;
    }
    #dropzone.dragover {
      background-color: #eee;
    }
    .comments-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .progress-container {
      margin-bottom: 20px;
    }
    .filter-bar {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <div id="welcome" class="mb-3"></div>
    
    <!-- Thanh tìm kiếm & sắp xếp -->
    <div class="filter-bar row mb-3">
      <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm nhiệm vụ...">
      </div>
      <div class="col-md-4">
        <select id="sortSelect" class="form-control">
          <option value="">Sắp xếp theo...</option>
          <option value="deadline">Deadline</option>
          <option value="priority">Ưu tiên</option>
        </select>
      </div>
    </div>
    
    <!-- Lọc theo người (chỉ admin) -->
    <div id="filter-section" style="display: none;" class="mb-3">
      <label for="filterAssigned">Lọc theo người nhận:</label>
      <select id="filterAssigned" class="form-control" onchange="filterTasks()">
        <option value="">-- Tất cả --</option>
        <option value="Thiet">Thiet</option>
        <option value="Son">Son</option>
        <option value="Hai">Hai</option>
        <option value="Duc">Duc</option>
        <option value="Long">Long</option>
        <option value="SongJisub">SongJisub</option>
        <option value="Ha">Ha</option>
      </select>
    </div>
    
    <!-- Lịch FullCalendar -->
    <div class="mb-4">
      <h3>Lịch nhiệm vụ</h3>
      <div id="calendar"></div>
    </div>
    
    <!-- Báo cáo Chart.js -->
    <div class="mb-4">
      <h3>Báo cáo nhiệm vụ</h3>
      <canvas id="tasksChart" width="400" height="150"></canvas>
    </div>
    
    <!-- Tiến độ công việc nhóm -->
    <div class="progress-container">
      <h3>Tiến độ công việc nhóm</h3>
      <div id="progress-bars"></div>
    </div>
    
    <!-- Form tạo nhiệm vụ (chỉ admin) -->
    <form id="taskForm" style="display:none;">
      <div class="form-group">
        <label for="taskTitle">Tên nhiệm vụ:</label>
        <input type="text" class="form-control" id="taskTitle" required>
      </div>
      <div class="form-group">
        <label for="taskAssigned">Giao cho:</label>
        <select class="form-control" id="taskAssigned" required>
          <option value="">Chọn người nhận</option>
          <option value="Thiet">Thiet</option>
          <option value="Son">Son</option>
          <option value="Hai">Hai</option>
          <option value="Duc">Duc</option>
          <option value="Long">Long</option>
          <option value="SongJisub">SongJisub</option>
          <option value="Ha">Ha</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskPriority">Mức độ ưu tiên:</label>
        <select class="form-control" id="taskPriority" required>
          <option value="cao">Ưu tiên cao</option>
          <option value="trungbinh">Trung bình</option>
          <option value="thap">Không ưu tiên</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskDeadline">Thời hạn:</label>
        <input type="date" class="form-control" id="taskDeadline" required>
      </div>
      <div class="form-group">
        <label for="taskDescription">Mô tả:</label>
        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
      </div>
      <div id="dropzone">Kéo & thả file vào đây (hoặc dán khi bấm Ctrl+V)</div>
      <div class="form-group">
        <label for="taskImage">Hoặc chọn file (có thể là ảnh hoặc tài liệu):</label>
        <input type="file" class="form-control-file" id="taskImage">
        <img id="imagePreview" class="preview-img" src="#" alt="Preview" style="display:none;">
      </div>
      <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
    </form>

    <hr>
    <!-- Danh sách nhiệm vụ -->
    <h2>Danh sách nhiệm vụ</h2>
    <table class="table table-bordered" id="tasksTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên nhiệm vụ</th>
          <th>Người nhận</th>
          <th>Mức độ ưu tiên</th>
          <th>Thời hạn</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>File đính kèm</th>
          <th>Hình ảnh</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    let currentUser = null;
    let selectedFile = null;

    // Kiểm tra đăng nhập
    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (!data.success) {
          window.location.href = '/login.html';
          return;
        }
        currentUser = data.user;
        document.getElementById('welcome').innerText =
          `Xin chào ${currentUser.name} - Vai trò: ${currentUser.role}`;
        if (currentUser.role === 'admin') {
          document.getElementById('taskForm').style.display = 'block';
          document.getElementById('filter-section').style.display = 'block';
        }
      } catch (err) {
        console.error("Error checking auth:", err);
        window.location.href = '/login.html';
      }
    }

    // Load tiến độ
    async function loadProgress() {
      try {
        const res = await fetch('/api/progress');
        const progressData = await res.json();
        let progressHTML = '';
        progressData.forEach(user => {
          let percent = (user.completed / user.total) * 100;
          progressHTML += `
            <div class="mb-2">
              <p>${user.name} (${user.completed}/${user.total} nhiệm vụ hoàn thành)</p>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;"
                  aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">${percent.toFixed(1)}%</div>
              </div>
            </div>
          `;
        });
        document.getElementById('progress-bars').innerHTML = progressHTML;
      } catch (err) {
        console.error("Error loading progress:", err);
      }
    }

    // Load báo cáo Chart.js
    async function loadReport() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        let statusCounts = { "Chưa thực hiện": 0, "Đang thực hiện": 0, "Hoàn thành": 0 };
        tasks.forEach(task => {
          if (statusCounts[task.status] !== undefined) {
            statusCounts[task.status]++;
          }
        });
        const ctx = document.getElementById('tasksChart').getContext('2d');
        if (window.tasksChartInstance) {
          window.tasksChartInstance.destroy();
        }
        window.tasksChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              label: 'Số lượng nhiệm vụ',
              data: Object.values(statusCounts),
              backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                precision: 0
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading report:", err);
      }
    }

    // Xử lý preview file
    document.getElementById('taskImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    });

    // Drag & Drop
    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', e => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', e => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    // Paste file
    document.addEventListener('paste', function(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file') {
          const file = item.getAsFile();
          handleFile(file);
        }
      }
    });

    function handleFile(file) {
      selectedFile = file;
      if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('imagePreview');
          img.src = e.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        alert(`File ${file.name} đã được chọn (không phải hình ảnh).`);
      }
    }

    // Upload ảnh (dành cho form tạo nhiệm vụ)
    async function uploadImage(file) {
      try {
        const formData = new FormData();
        formData.append('image', file);
        const response = await fetch('/api/upload-image', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        return result;
      } catch (err) {
        console.error("Error uploadImage:", err);
        return { success: false, message: err?.message || "Unknown error" };
      }
    }

    // Upload attachment (dành cho user/admin upload file tài liệu)
    async function uploadAttachment(taskId, file) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch(`/api/tasks/${taskId}/attachments`, {
          method: 'POST',
          body: formData
        });
        return await response.json();
      } catch (err) {
        console.error("Error uploadAttachment:", err);
        return { success: false, message: err?.message || "Unknown error" };
      }
    }

    // Load danh sách nhiệm vụ
    async function loadTasks() {
      try {
        let url = '/api/tasks';
        if (currentUser.role === 'admin') {
          const assigned = document.getElementById('filterAssigned').value;
          if (assigned) {
            url += `?assignedTo=${encodeURIComponent(assigned)}`;
          }
        }
        const response = await fetch(url);
        let tasks = await response.json();

        // Lọc phía client: tìm kiếm
        const searchVal = document.getElementById('searchInput').value.trim().toLowerCase();
        if (searchVal) {
          tasks = tasks.filter(task => {
            return (task.title && task.title.toLowerCase().includes(searchVal)) ||
                   (task.description && task.description.toLowerCase().includes(searchVal));
          });
        }
        // Sắp xếp
        const sortVal = document.getElementById('sortSelect').value;
        if (sortVal === 'deadline') {
          tasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
        } else if (sortVal === 'priority') {
          const order = { 'cao': 1, 'trungbinh': 2, 'thap': 3 };
          tasks.sort((a, b) => order[a.priority] - order[b.priority]);
        }

        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        for (const task of tasks) {
          let actionButtons = '';
          if (task.status === "Chưa thực hiện" && currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-info btn-sm" onclick="startTask(${task.id})">Nhận Nhiệm Vụ</button> `;
          }
          if (task.status !== "Hoàn thành" && (currentUser.role === 'admin' || currentUser.name === task.assignedTo)) {
            actionButtons += `<button class="btn btn-success btn-sm" onclick="completeTask(${task.id})">Hoàn thành</button> `;
          }
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-warning btn-sm" onclick="handoverTask(${task.id})">Bàn giao</button> `;
          }
          if (currentUser.role === 'admin' || currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-secondary btn-sm" onclick="uploadAttachmentPrompt(${task.id})">Upload File</button> `;
          }
          actionButtons += `<button class="btn btn-info btn-sm" onclick="toggleComments(${task.id})">Xem Comment</button> `;
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Xóa</button>`;
          }

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${task.priority}</td>
            <td>${task.deadline}</td>
            <td>${task.description || ''}</td>
            <td>${task.status}</td>
            <td id="attachments-${task.id}"></td>
            <td>
              ${
                task.imageURL
                  ? `<a href="${task.imageURL}" target="_blank" download>
                       <img src="${task.imageURL}" style="max-width:100px;" alt="thumbnail">
                     </a>`
                  : 'N/A'
              }
            </td>
            <td>
              ${actionButtons}
              <div id="comments-${task.id}" class="comments-container" style="display:none;">
                <div id="comments-list-${task.id}"></div>
                <textarea id="new-comment-${task.id}" class="form-control" rows="2" placeholder="Nhập comment..."></textarea>
                <button class="btn btn-primary btn-sm mt-2" onclick="postComment(${task.id})">Gửi</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
          loadAttachments(task.id);
        }
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    function filterTasks() {
      loadTasks();
    }

    // Nhận nhiệm vụ
    async function startTask(taskId) {
      if (!confirm("Bạn có chắc muốn nhận nhiệm vụ này không?")) return;
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Đang thực hiện' })
        });
        const result = await res.json();
        if (result.success) {
          alert("Bạn đã nhận nhiệm vụ!");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error startTask:", err);
        alert("Lỗi startTask: " + (err?.message || "Xem log"));
      }
    }

    // Hoàn thành
    async function completeTask(taskId) {
      if (!confirm("Đánh dấu nhiệm vụ này là 'Hoàn thành'?")) return;
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Hoàn thành' })
        });
        const result = await res.json();
        if (result.success) {
          alert("Nhiệm vụ đã hoàn thành!");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error completeTask:", err);
        alert("Lỗi completeTask: " + (err?.message || "Xem log"));
      }
    }

    // Bàn giao
    async function handoverTask(taskId) {
      const newAssignee = prompt("Nhập tên người nhận mới:");
      if (!newAssignee) return;
      try {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assignedTo: newAssignee })
        });
        const result = await res.json();
        if (result.success) {
          alert("Nhiệm vụ đã được bàn giao!");
          loadTasks();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error handoverTask:", err);
        alert("Lỗi handoverTask: " + (err?.message || "Xem log"));
      }
    }

    // Xóa
    async function deleteTask(taskId) {
      if (!confirm("Xóa nhiệm vụ này?")) return;
      try {
        const res = await fetch(`/api/tasks/${taskId}`, { method: 'DELETE' });
        const result = await res.json();
        if (result.success) {
          alert("Nhiệm vụ đã được xóa!");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error deleteTask:", err);
        alert("Lỗi deleteTask: " + (err?.message || "Xem log"));
      }
    }

    // Comment
    async function toggleComments(taskId) {
      const container = document.getElementById(`comments-${taskId}`);
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        await loadComments(taskId);
      } else {
        container.style.display = 'none';
      }
    }
    async function loadComments(taskId) {
      try {
        const res = await fetch(`/api/tasks/${taskId}/comments`);
        const comments = await res.json();
        const list = document.getElementById(`comments-list-${taskId}`);
        list.innerHTML = '';
        for (const c of comments) {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${c.user}</strong>: ${c.comment_text}<br><small>${new Date(c.created_at).toLocaleString()}</small>`;
          list.appendChild(p);
        }
      } catch (err) {
        console.error("Error loadComments:", err);
      }
    }
    async function postComment(taskId) {
      const textArea = document.getElementById(`new-comment-${taskId}`);
      const commentText = textArea.value.trim();
      if (!commentText) {
        alert("Vui lòng nhập nội dung comment.");
        return;
      }
      try {
        const res = await fetch(`/api/tasks/${taskId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_text: commentText })
        });
        const result = await res.json();
        if (result.success) {
          alert("Đã gửi comment!");
          textArea.value = '';
          loadComments(taskId);
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error postComment:", err);
        alert("Lỗi postComment: " + (err?.message || "Xem log"));
      }
    }

    // Upload file đính kèm
    async function uploadAttachmentPrompt(taskId) {
      const input = document.createElement('input');
      input.type = 'file';
      // Cho phép các loại file
      input.accept = 'image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
      input.onchange = async () => {
        const file = input.files[0];
        if (file) {
          const result = await uploadAttachment(taskId, file);
          if (result.success) {
            alert("File đính kèm đã được upload!");
            loadAttachments(taskId);
          } else {
            alert("Lỗi upload file: " + result.message);
          }
        }
      };
      input.click();
    }
    async function loadAttachments(taskId) {
      try {
        const res = await fetch(`/api/tasks/${taskId}/attachments`);
        const attachments = await res.json();
        const container = document.getElementById(`attachments-${taskId}`);
        let html = '';
        for (const att of attachments) {
          html += `<div><a href="${att.file_url}" target="_blank" download>${att.file_name}</a></div>`;
        }
        container.innerHTML = html;
      } catch (err) {
        console.error("Error loadAttachments:", err);
      }
    }

    // FullCalendar
    async function loadCalendar() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const events = tasks.map(task => {
          return {
            id: task.id,
            title: task.title,
            start: task.deadline,
            color: task.status === "Hoàn thành" ? 'green' : (task.status === "Đang thực hiện" ? 'orange' : 'red')
          };
        });
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridMonth',
          events,
          editable: true,
          eventDrop: async (info) => {
            const newDeadline = info.event.start.toISOString().split('T')[0];
            try {
              const res = await fetch(`/api/tasks/${info.event.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ deadline: newDeadline })
              });
              const result = await res.json();
              if (!result.success) {
                alert("Lỗi cập nhật deadline: " + result.message);
                info.revert();
              } else {
                loadTasks();
                loadProgress();
                loadReport();
              }
            } catch (error) {
              console.error("Error updating deadline:", error);
              info.revert();
            }
          }
        });
        calendar.render();
      } catch (err) {
        console.error("Error loadCalendar:", err);
      }
    }

    // Xử lý form tạo nhiệm vụ
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const task = {
        title: document.getElementById('taskTitle').value,
        assignedTo: document.getElementById('taskAssigned').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value,
        description: document.getElementById('taskDescription').value,
        status: 'Chưa thực hiện'
      };
      // Nếu có file => upload
      if (selectedFile) {
        // Nếu file là ảnh => upload /api/upload-image
        if (selectedFile.type.startsWith('image/')) {
          const uploadResult = await uploadImage(selectedFile);
          if (!uploadResult.success) {
            alert("Upload ảnh thất bại: " + uploadResult.message);
            return;
          }
          task.imageURL = uploadResult.imageUrl;
        } else {
          // Nếu file không phải ảnh, ta vẫn có thể upload, nhưng code gốc /api/upload-image chỉ dành cho ảnh
          // Tùy ý, bạn có thể bỏ qua hoặc cho user upload attachments sau khi tạo xong task
          alert("File không phải ảnh. Bạn có thể upload file đính kèm sau khi tạo nhiệm vụ xong.");
        }
      }
      // Gửi dữ liệu nhiệm vụ
      try {
        const res = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(task)
        });
        const result = await res.json();
        if (result.success) {
          alert("Nhiệm vụ được giao thành công!");
          loadTasks();
          loadProgress();
          loadReport();
          document.getElementById('taskForm').reset();
          document.getElementById('imagePreview').style.display = 'none';
          selectedFile = null;
        } else {
          alert("Lỗi tạo nhiệm vụ: " + result.message);
        }
      } catch (err) {
        console.error("Error create task:", err);
        alert("Lỗi create task: " + (err?.message || "Xem log"));
      }
    });

    // Khởi tạo trang
    async function initPage() {
      await checkAuth();
      loadTasks();
      loadProgress();
      loadReport();
      loadCalendar();
      // setupRealtime(); // Nếu muốn Realtime, bạn cần client Supabase (anon key) và policy
    }
    window.onload = initPage;
  </script>
</body>
</html>
