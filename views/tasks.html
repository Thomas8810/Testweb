<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .preview-img {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Quản lý Nhiệm vụ</h1>
    <hr>
    <!-- Form tạo nhiệm vụ (chỉ admin sẽ thấy phần này nếu bạn muốn ẩn nó đối với user qua JS) -->
    <form id="taskForm">
      <div class="form-group">
        <label for="taskTitle">Tên nhiệm vụ:</label>
        <input type="text" class="form-control" id="taskTitle" required>
      </div>
      <div class="form-group">
        <label for="taskAssigned">Giao cho:</label>
        <select class="form-control" id="taskAssigned" required>
          <option value="">Chọn người nhận</option>
          <!-- Danh sách người nhận, bạn có thể load động từ server nếu muốn -->
          <option value="Thiet">Thiet</option>
          <option value="Son">Son</option>
          <option value="Hai">Hai</option>
          <option value="Duc">Duc</option>
          <option value="Long">Long</option>
          <option value="SongJisub">SongJisub</option>
          <option value="Ha">Ha</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskPriority">Mức độ ưu tiên:</label>
        <select class="form-control" id="taskPriority" required>
          <option value="cao">Ưu tiên cao</option>
          <option value="trungbinh">Trung bình</option>
          <option value="thap">Không ưu tiên</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskDeadline">Thời hạn:</label>
        <input type="date" class="form-control" id="taskDeadline" required>
      </div>
      <div class="form-group">
        <label for="taskDescription">Mô tả:</label>
        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label for="taskImage">Hình ảnh đính kèm:</label>
        <input type="file" class="form-control-file" id="taskImage" accept="image/*">
        <img id="imagePreview" class="preview-img" src="#" alt="Preview" style="display:none;">
      </div>
      <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
    </form>
    <hr>
    <!-- Bảng liệt kê nhiệm vụ -->
    <h2>Danh sách nhiệm vụ</h2>
    <table class="table table-bordered" id="tasksTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên nhiệm vụ</th>
          <th>Người nhận</th>
          <th>Mức ưu tiên</th>
          <th>Thời hạn</th>
          <th>Trạng thái</th>
          <th>Hình ảnh</th>
        </tr>
      </thead>
      <tbody>
        <!-- Nhiệm vụ sẽ được load từ API -->
      </tbody>
    </table>
  </div>

  <script>
    // Hiển thị preview của ảnh khi chọn file
    document.getElementById('taskImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('imagePreview');
          img.src = e.target.result;
          img.style.display = 'block';
        }
        reader.readAsDataURL(file);
      }
    });

    // Hàm upload hình ảnh qua API /api/upload-image
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });
      return await response.json();
    }

    // Hàm load danh sách nhiệm vụ từ API
    async function loadTasks() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${task.priority}</td>
            <td>${task.deadline}</td>
            <td>${task.status}</td>
            <td>${task.imageURL ? `<img src="${task.imageURL}" style="max-width:100px;">` : 'N/A'}</td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    // Xử lý gửi form tạo nhiệm vụ
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const task = {
        title: document.getElementById('taskTitle').value,
        assignedTo: document.getElementById('taskAssigned').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value,
        description: document.getElementById('taskDescription').value,
        status: 'Chưa thực hiện'
      };

      // Nếu có file ảnh được chọn, upload ảnh trước
      const imageFile = document.getElementById('taskImage').files[0];
      if (imageFile) {
        const uploadResult = await uploadImage(imageFile);
        if (uploadResult.success) {
          task.imageURL = uploadResult.imageUrl;
        } else {
          alert('Upload ảnh thất bại: ' + uploadResult.message);
          return;
        }
      }

      // Gửi dữ liệu nhiệm vụ đến API tạo nhiệm vụ
      const response = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(task)
      });
      const result = await response.json();
      if (result.success) {
        alert('Nhiệm vụ được giao thành công!');
        loadTasks();
        document.getElementById('taskForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
      } else {
        alert('Lỗi: ' + result.message);
      }
    });

    // Load nhiệm vụ khi trang được tải
    window.onload = loadTasks;
  </script>
</body>
</html>
