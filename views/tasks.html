<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Nếu bạn muốn dùng Chart.js, có thể thêm script sau -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
  <style>
    .preview-img {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
    /* Dropzone style */
    #dropzone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      color: #666;
      transition: background-color 0.3s;
    }
    #dropzone.dragover {
      background-color: #eee;
    }
    .comments-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
    /* Progress section */
    .progress-container {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- Hiển thị thông tin user -->
    <div id="welcome" class="mb-3"></div>
    
    <!-- Khu vực tiến độ công việc nhóm -->
    <div class="progress-container">
      <h3>Tiến độ công việc nhóm</h3>
      <div id="progress-bars"></div>
    </div>

    <!-- Form tạo nhiệm vụ (chỉ admin thấy) -->
    <form id="taskForm" style="display:none;">
      <div class="form-group">
        <label for="taskTitle">Tên nhiệm vụ:</label>
        <input type="text" class="form-control" id="taskTitle" required>
      </div>
      <div class="form-group">
        <label for="taskAssigned">Giao cho:</label>
        <select class="form-control" id="taskAssigned" required>
          <option value="">Chọn người nhận</option>
          <!-- Danh sách người nhận -->
          <option value="Thiet">Thiet</option>
          <option value="Son">Son</option>
          <option value="Hai">Hai</option>
          <option value="Duc">Duc</option>
          <option value="Long">Long</option>
          <option value="SongJisub">SongJisub</option>
          <option value="Ha">Ha</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskPriority">Mức độ ưu tiên:</label>
        <select class="form-control" id="taskPriority" required>
          <option value="cao">Ưu tiên cao</option>
          <option value="trungbinh">Trung bình</option>
          <option value="thap">Không ưu tiên</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskDeadline">Thời hạn:</label>
        <input type="date" class="form-control" id="taskDeadline" required>
      </div>
      <div class="form-group">
        <label for="taskDescription">Mô tả:</label>
        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
      </div>
      <!-- Dropzone để kéo & thả hoặc dán ảnh -->
      <div id="dropzone">Kéo & thả ảnh vào đây (hoặc dán ảnh khi bấm Ctrl+V)</div>
      <div class="form-group">
        <label for="taskImage">Hoặc chọn file ảnh (tùy chọn):</label>
        <input type="file" class="form-control-file" id="taskImage" accept="image/*">
        <img id="imagePreview" class="preview-img" src="#" alt="Preview" style="display:none;">
      </div>
      <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
    </form>
    <hr>
    <!-- Bảng liệt kê nhiệm vụ -->
    <h2>Danh sách nhiệm vụ</h2>
    <table class="table table-bordered" id="tasksTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên nhiệm vụ</th>
          <th>Người nhận</th>
          <th>Mức ưu tiên</th>
          <th>Thời hạn</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>Hình ảnh</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <!-- Danh sách nhiệm vụ sẽ được load qua API -->
      </tbody>
    </table>
  </div>

  <script>
    let currentUser = null;         // Lưu thông tin user
    let selectedImageFile = null;   // Lưu file ảnh từ input/drag/paste

    // Kiểm tra đăng nhập và lấy thông tin user
    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (!data.success) {
          window.location.href = '/login.html';
          return;
        }
        currentUser = data.user;
        document.getElementById('welcome').innerText =
          `Xin chào ${currentUser.name} - Vai trò: ${currentUser.role}`;
        // Nếu là admin, hiển thị form tạo nhiệm vụ
        if (currentUser.role === 'admin') {
          document.getElementById('taskForm').style.display = 'block';
        }
      } catch (err) {
        console.error("Error checking auth:", err);
        window.location.href = '/login.html';
      }
    }

    // Load tiến độ công việc của từng user
    async function loadProgress() {
      try {
        const res = await fetch('/api/progress');
        const progressData = await res.json();
        let progressHTML = '';
        progressData.forEach(user => {
          let percent = (user.completed / user.total) * 100;
          progressHTML += `
            <div class="mb-2">
              <p>${user.name} (${user.completed}/${user.total} nhiệm vụ hoàn thành)</p>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;"
                  aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">${percent.toFixed(1)}%</div>
              </div>
            </div>
          `;
        });
        document.getElementById('progress-bars').innerHTML = progressHTML;
      } catch (err) {
        console.error("Error loading progress:", err);
      }
    }

    // Hiển thị preview khi chọn file
    document.getElementById('taskImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    });

    // Drag & Drop
    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    // Paste ảnh
    document.addEventListener('paste', function(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file' && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          handleFile(file);
        }
      }
    });

    // Hàm xử lý file ảnh: hiển thị preview & lưu file vào biến global
    function handleFile(file) {
      if (file && file.type.startsWith('image/')) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('imagePreview');
          img.src = e.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        alert('File không phải hình ảnh!');
      }
    }

    // Hàm upload ảnh qua API /api/upload-image
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });
      return await response.json(); // { success: boolean, imageUrl: string }
    }

    // Load danh sách nhiệm vụ
    async function loadTasks() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
          let actionButtons = '';
          // Nếu nhiệm vụ chưa thực hiện và user là người được giao, hiển thị nút "Nhận Nhiệm Vụ"
          if (task.status === "Chưa thực hiện" && currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-info btn-sm" onclick="startTask(${task.id})">Nhận Nhiệm Vụ</button> `;
          }
          // Nút Hoàn thành
          if (task.status !== "Hoàn thành" && (currentUser.role === 'admin' || currentUser.name === task.assignedTo)) {
            actionButtons += `<button class="btn btn-success btn-sm" onclick="completeTask(${task.id})">Hoàn thành</button> `;
          }
          // Nút Bàn giao (cho admin)
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-warning btn-sm" onclick="handoverTask(${task.id})">Bàn giao</button> `;
          }
          // Nút Xem Comment (cho tất cả)
          actionButtons += `<button class="btn btn-info btn-sm" onclick="toggleComments(${task.id})">Xem Comment</button> `;
          // Nút Xóa (chỉ admin)
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Xóa</button>`;
          }
          // Xây dựng hàng trong bảng
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${task.priority}</td>
            <td>${task.deadline}</td>
            <td>${task.description || ''}</td>
            <td>${task.status}</td>
            <td>
              ${
                task.imageURL
                  ? `<a href="${task.imageURL}" target="_blank" download>
                       <img src="${task.imageURL}" style="max-width:100px;" alt="thumbnail">
                     </a>`
                  : 'N/A'
              }
            </td>
            <td>
              ${actionButtons}
              <div id="comments-${task.id}" class="comments-container" style="display:none;">
                <div id="comments-list-${task.id}"></div>
                <textarea id="new-comment-${task.id}" class="form-control" rows="2" placeholder="Nhập comment..."></textarea>
                <button class="btn btn-primary btn-sm mt-2" onclick="postComment(${task.id})">Gửi</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    // Hàm nhận nhiệm vụ: chuyển trạng thái từ "Chưa thực hiện" sang "Đang thực hiện"
    async function startTask(taskId) {
      if (!confirm("Bạn có chắc muốn nhận nhiệm vụ này không?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Đang thực hiện' })
        });
        const result = await response.json();
        if (result.success) {
          alert("Bạn đã nhận nhiệm vụ! Trạng thái chuyển sang 'Đang thực hiện'.");
          loadTasks();
          loadProgress();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error starting task:", err);
      }
    }

    // Hàm hoàn thành nhiệm vụ
    async function completeTask(taskId) {
      if (!confirm("Bạn có chắc muốn đánh dấu nhiệm vụ này là 'Hoàn thành'?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Hoàn thành' })
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được cập nhật thành 'Hoàn thành'!");
          loadTasks();
          loadProgress();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error completing task:", err);
      }
    }

    // Hàm bàn giao nhiệm vụ (admin)
    async function handoverTask(taskId) {
      const newAssignee = prompt("Nhập tên người nhận mới:");
      if (!newAssignee) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assignedTo: newAssignee })
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được bàn giao thành công!");
          loadTasks();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error handing over task:", err);
      }
    }

    // Hàm xóa nhiệm vụ (admin)
    async function deleteTask(taskId) {
      if (!confirm("Bạn có chắc muốn xóa nhiệm vụ này?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được xóa!");
          loadTasks();
          loadProgress();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error deleting task:", err);
      }
    }

    // Hàm toggle hiển thị/ẩn comment cho nhiệm vụ
    async function toggleComments(taskId) {
      const container = document.getElementById(`comments-${taskId}`);
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        await loadComments(taskId);
      } else {
        container.style.display = 'none';
      }
    }

    // Hàm load comment cho nhiệm vụ
    async function loadComments(taskId) {
      try {
        const response = await fetch(`/api/tasks/${taskId}/comments`);
        const comments = await response.json();
        const list = document.getElementById(`comments-list-${taskId}`);
        list.innerHTML = '';
        comments.forEach(comment => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${comment.user}</strong>: ${comment.comment_text}<br><small>${new Date(comment.created_at).toLocaleString()}</small>`;
          list.appendChild(p);
        });
      } catch (err) {
        console.error("Error loading comments:", err);
      }
    }

    // Hàm gửi comment cho nhiệm vụ
    async function postComment(taskId) {
      const textArea = document.getElementById(`new-comment-${taskId}`);
      const commentText = textArea.value.trim();
      if (!commentText) {
        alert("Vui lòng nhập nội dung comment.");
        return;
      }
      try {
        const response = await fetch(`/api/tasks/${taskId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_text: commentText })
        });
        const result = await response.json();
        if (result.success) {
          alert("Comment đã được gửi!");
          textArea.value = '';
          await loadComments(taskId);
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error posting comment:", err);
      }
    }

    // Xử lý gửi form tạo nhiệm vụ (chỉ admin)
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const task = {
        title: document.getElementById('taskTitle').value,
        assignedTo: document.getElementById('taskAssigned').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value,
        description: document.getElementById('taskDescription').value,
        status: 'Chưa thực hiện'
      };
      if (selectedImageFile) {
        const uploadResult = await uploadImage(selectedImageFile);
        if (uploadResult.success) {
          task.imageURL = uploadResult.imageUrl;
        } else {
          alert('Upload ảnh thất bại: ' + uploadResult.message);
          return;
        }
      }
      const response = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(task)
      });
      const result = await response.json();
      if (result.success) {
        alert('Nhiệm vụ được giao thành công!');
        loadTasks();
        loadProgress();
        document.getElementById('taskForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        selectedImageFile = null;
      } else {
        alert('Lỗi: ' + result.message);
      }
    });

    // Khi trang tải, kiểm tra đăng nhập, load tasks và tiến độ
    window.onload = async () => {
      await checkAuth();
      loadTasks();
      loadProgress();
    };
  </script>
</body>
</html>
