<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ - Mở Rộng</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <!-- Chart.js CDN cho báo cáo -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .preview-img {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
    /* Dropzone style */
    #dropzone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      color: #666;
      transition: background-color 0.3s;
    }
    #dropzone.dragover {
      background-color: #eee;
    }
    .comments-container {
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .progress-container {
      margin-bottom: 20px;
    }
    /* Các ô tìm kiếm & sắp xếp */
    .filter-bar {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <!-- Thông tin người dùng -->
    <div id="welcome" class="mb-3"></div>
    
    <!-- Thanh tìm kiếm & sắp xếp (cho admin & user) -->
    <div class="filter-bar row mb-3">
      <div class="col-md-4">
        <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm nhiệm vụ...">
      </div>
      <div class="col-md-4">
        <select id="sortSelect" class="form-control">
          <option value="">Sắp xếp theo...</option>
          <option value="deadline">Deadline</option>
          <option value="priority">Ưu tiên</option>
        </select>
      </div>
    </div>
    
    <!-- Dropdown lọc theo người (chỉ admin) -->
    <div id="filter-section" style="display: none;" class="mb-3">
      <label for="filterAssigned">Lọc theo người nhận:</label>
      <select id="filterAssigned" class="form-control" onchange="filterTasks()">
        <option value="">-- Tất cả --</option>
        <option value="Thiet">Thiet</option>
        <option value="Son">Son</option>
        <option value="Hai">Hai</option>
        <option value="Duc">Duc</option>
        <option value="Long">Long</option>
        <option value="SongJisub">SongJisub</option>
        <option value="Ha">Ha</option>
      </select>
    </div>
    
    <!-- Biểu đồ báo cáo nhiệm vụ theo trạng thái -->
    <div class="mb-4">
      <h3>Báo cáo nhiệm vụ</h3>
      <canvas id="tasksChart" width="400" height="150"></canvas>
    </div>

    <!-- Khu vực hiển thị tiến độ công việc nhóm -->
    <div class="progress-container">
      <h3>Tiến độ công việc nhóm</h3>
      <div id="progress-bars"></div>
    </div>

    <!-- Form tạo nhiệm vụ (chỉ admin) -->
    <form id="taskForm" style="display:none;">
      <div class="form-group">
        <label for="taskTitle">Tên nhiệm vụ:</label>
        <input type="text" class="form-control" id="taskTitle" required>
      </div>
      <div class="form-group">
        <label for="taskAssigned">Giao cho:</label>
        <select class="form-control" id="taskAssigned" required>
          <option value="">Chọn người nhận</option>
          <option value="Thiet">Thiet</option>
          <option value="Son">Son</option>
          <option value="Hai">Hai</option>
          <option value="Duc">Duc</option>
          <option value="Long">Long</option>
          <option value="SongJisub">SongJisub</option>
          <option value="Ha">Ha</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskPriority">Mức độ ưu tiên:</label>
        <select class="form-control" id="taskPriority" required>
          <option value="cao">Ưu tiên cao</option>
          <option value="trungbinh">Trung bình</option>
          <option value="thap">Không ưu tiên</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskDeadline">Thời hạn:</label>
        <input type="date" class="form-control" id="taskDeadline" required>
      </div>
      <div class="form-group">
        <label for="taskDescription">Mô tả:</label>
        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
      </div>
      <!-- Dropzone để kéo & thả hoặc dán ảnh -->
      <div id="dropzone">Kéo & thả ảnh vào đây (hoặc dán ảnh khi bấm Ctrl+V)</div>
      <div class="form-group">
        <label for="taskImage">Hoặc chọn file ảnh (tùy chọn):</label>
        <input type="file" class="form-control-file" id="taskImage" accept="image/*">
        <img id="imagePreview" class="preview-img" src="#" alt="Preview" style="display:none;">
      </div>
      <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
      document.getElementById('taskForm').addEventListener('submit', async function(e) {
  e.preventDefault(); // Ngăn chặn hành vi gửi form mặc định
  // Xử lý giao nhiệm vụ qua AJAX ở đây...
});

    </form>

    <hr>
    <!-- Bảng danh sách nhiệm vụ -->
    <h2>Danh sách nhiệm vụ</h2>
    <table class="table table-bordered" id="tasksTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên nhiệm vụ</th>
          <th>Người nhận</th>
          <th>Mức ưu tiên</th>
          <th>Thời hạn</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>Hình ảnh</th>
          <th>Hành động</th>
        </tr>
      </thead>
      <tbody>
        <!-- Nhiệm vụ sẽ được load qua API -->
      </tbody>
    </table>
  </div>

  <script>
    let currentUser = null;           // Lưu thông tin user đăng nhập
    let selectedImageFile = null;     // Lưu file ảnh khi người dùng chọn/kéo/dán

    // 1. Kiểm tra đăng nhập và lấy thông tin user
    async function checkAuth() {
      try {
        const res = await fetch('/api/me');
        const data = await res.json();
        if (!data.success) {
          window.location.href = '/login.html';
          return;
        }
        currentUser = data.user;
        document.getElementById('welcome').innerText =
          `Xin chào ${currentUser.name} - Vai trò: ${currentUser.role}`;
        if (currentUser.role === 'admin') {
          document.getElementById('taskForm').style.display = 'block';
          document.getElementById('filter-section').style.display = 'block';
        }
      } catch (err) {
        console.error("Error checking auth:", err);
        window.location.href = '/login.html';
      }
    }

    // 2. Hàm load tiến độ công việc nhóm
    async function loadProgress() {
      try {
        const res = await fetch('/api/progress');
        const progressData = await res.json();
        let progressHTML = '';
        progressData.forEach(user => {
          let percent = (user.completed / user.total) * 100;
          progressHTML += `
            <div class="mb-2">
              <p>${user.name} (${user.completed}/${user.total} nhiệm vụ hoàn thành)</p>
              <div class="progress">
                <div class="progress-bar bg-success" role="progressbar" style="width: ${percent}%;"
                  aria-valuenow="${percent}" aria-valuemin="0" aria-valuemax="100">${percent.toFixed(1)}%</div>
              </div>
            </div>
          `;
        });
        document.getElementById('progress-bars').innerHTML = progressHTML;
      } catch (err) {
        console.error("Error loading progress:", err);
      }
    }

    // 3. Hàm load báo cáo bằng Chart.js (thống kê nhiệm vụ theo trạng thái)
    async function loadReport() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        // Tính số lượng nhiệm vụ theo trạng thái
        let statusCounts = { "Chưa thực hiện": 0, "Đang thực hiện": 0, "Hoàn thành": 0 };
        tasks.forEach(task => {
          if (statusCounts[task.status] !== undefined) {
            statusCounts[task.status]++;
          }
        });
        const ctx = document.getElementById('tasksChart').getContext('2d');
        // Nếu đã có chart, hủy nó đi để vẽ mới
        if (window.tasksChartInstance) {
          window.tasksChartInstance.destroy();
        }
        window.tasksChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              label: 'Số lượng nhiệm vụ',
              data: Object.values(statusCounts),
              backgroundColor: ['#dc3545','#ffc107','#28a745']
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                precision: 0
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading report:", err);
      }
    }

    // 4. Xử lý preview ảnh khi chọn file input
    document.getElementById('taskImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) handleFile(file);
    });

    // 5. Drag & Drop
    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });

    // 6. Paste ảnh
    document.addEventListener('paste', function(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file' && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          handleFile(file);
        }
      }
    });

    // 7. Hàm xử lý file ảnh: hiển thị preview & lưu file vào biến global
    function handleFile(file) {
      if (file && file.type.startsWith('image/')) {
        selectedImageFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('imagePreview');
          img.src = e.target.result;
          img.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        alert('File không phải hình ảnh!');
      }
    }

    // 8. Hàm upload ảnh qua API /api/upload-image
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });
      return await response.json(); // { success: boolean, imageUrl: string }
    }

    // 9. Hàm load danh sách nhiệm vụ
    async function loadTasks() {
      try {
        let url = '/api/tasks';
        // Nếu admin, có thể lọc theo dropdown
        if (currentUser.role === 'admin') {
          const assigned = document.getElementById('filterAssigned').value;
          if (assigned) {
            url += `?assignedTo=${encodeURIComponent(assigned)}`;
          }
        }
        // Thêm tham số tìm kiếm và sắp xếp nếu có
        const searchVal = document.getElementById('searchInput').value.trim();
        const sortVal = document.getElementById('sortSelect').value;
        if (searchVal || sortVal) {
          const params = new URLSearchParams();
          if (searchVal) {
            params.append('search', searchVal);
          }
          if (sortVal) {
            params.append('sort', sortVal);
          }
          // Nếu URL đã có query parameter, nối tiếp; nếu không, thêm "?"
          url += url.includes('?') ? '&' + params.toString() : '?' + params.toString();
        }
        const response = await fetch(url);
        const tasks = await response.json();

        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
          let actionButtons = '';
          // Nút "Nhận Nhiệm Vụ" - nếu trạng thái là "Chưa thực hiện" và user là người được giao
          if (task.status === "Chưa thực hiện" && currentUser.name === task.assignedTo) {
            actionButtons += `<button class="btn btn-info btn-sm" onclick="startTask(${task.id})">Nhận Nhiệm Vụ</button> `;
          }
          // Nút "Hoàn thành" - nếu chưa hoàn thành và (admin hoặc user được giao)
          if (task.status !== "Hoàn thành" && (currentUser.role === 'admin' || currentUser.name === task.assignedTo)) {
            actionButtons += `<button class="btn btn-success btn-sm" onclick="completeTask(${task.id})">Hoàn thành</button> `;
          }
          // Nút "Bàn giao" - chỉ admin
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-warning btn-sm" onclick="handoverTask(${task.id})">Bàn giao</button> `;
          }
          // Nút "Xem Comment" - tất cả
          actionButtons += `<button class="btn btn-info btn-sm" onclick="toggleComments(${task.id})">Xem Comment</button> `;
          // Nút "Xóa" - chỉ admin
          if (currentUser.role === 'admin') {
            actionButtons += `<button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})">Xóa</button>`;
          }
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${task.priority}</td>
            <td>${task.deadline}</td>
            <td>${task.description || ''}</td>
            <td>${task.status}</td>
            <td>
              ${
                task.imageURL
                  ? `<a href="${task.imageURL}" target="_blank" download>
                       <img src="${task.imageURL}" style="max-width:100px;" alt="thumbnail">
                     </a>`
                  : 'N/A'
              }
            </td>
            <td>
              ${actionButtons}
              <div id="comments-${task.id}" class="comments-container" style="display:none;">
                <div id="comments-list-${task.id}"></div>
                <textarea id="new-comment-${task.id}" class="form-control" rows="2" placeholder="Nhập comment..."></textarea>
                <button class="btn btn-primary btn-sm mt-2" onclick="postComment(${task.id})">Gửi</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    // 10. Hàm lọc nhiệm vụ (gọi khi dropdown thay đổi)
    async function filterTasks() {
      await loadTasks();
    }

    // 11. Hàm nhận nhiệm vụ (chuyển trạng thái sang "Đang thực hiện")
    async function startTask(taskId) {
      if (!confirm("Bạn có chắc muốn nhận nhiệm vụ này không?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Đang thực hiện' })
        });
        const result = await response.json();
        if (result.success) {
          alert("Bạn đã nhận nhiệm vụ! Trạng thái chuyển sang 'Đang thực hiện'.");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error starting task:", err);
      }
    }

    // 12. Hàm hoàn thành nhiệm vụ
    async function completeTask(taskId) {
      if (!confirm("Bạn có chắc muốn đánh dấu nhiệm vụ này là 'Hoàn thành'?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'Hoàn thành' })
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được cập nhật thành 'Hoàn thành'!");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error completing task:", err);
      }
    }

    // 13. Hàm bàn giao nhiệm vụ (admin)
    async function handoverTask(taskId) {
      const newAssignee = prompt("Nhập tên người nhận mới:");
      if (!newAssignee) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ assignedTo: newAssignee })
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được bàn giao thành công!");
          loadTasks();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error handing over task:", err);
      }
    }

    // 14. Hàm xóa nhiệm vụ (admin)
    async function deleteTask(taskId) {
      if (!confirm("Bạn có chắc muốn xóa nhiệm vụ này?")) return;
      try {
        const response = await fetch(`/api/tasks/${taskId}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (result.success) {
          alert("Nhiệm vụ đã được xóa!");
          loadTasks();
          loadProgress();
          loadReport();
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error deleting task:", err);
      }
    }

    // 15. Hàm toggle hiển thị/ẩn comment cho nhiệm vụ
    async function toggleComments(taskId) {
      const container = document.getElementById(`comments-${taskId}`);
      if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
        await loadComments(taskId);
      } else {
        container.style.display = 'none';
      }
    }

    // 16. Hàm load comment cho nhiệm vụ
    async function loadComments(taskId) {
      try {
        const response = await fetch(`/api/tasks/${taskId}/comments`);
        const comments = await response.json();
        const list = document.getElementById(`comments-list-${taskId}`);
        list.innerHTML = '';
        comments.forEach(comment => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${comment.user}</strong>: ${comment.comment_text}
                         <br><small>${new Date(comment.created_at).toLocaleString()}</small>`;
          list.appendChild(p);
        });
      } catch (err) {
        console.error("Error loading comments:", err);
      }
    }

    // 17. Hàm gửi comment cho nhiệm vụ
    async function postComment(taskId) {
      const textArea = document.getElementById(`new-comment-${taskId}`);
      const commentText = textArea.value.trim();
      if (!commentText) {
        alert("Vui lòng nhập nội dung comment.");
        return;
      }
      try {
        const response = await fetch(`/api/tasks/${taskId}/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment_text: commentText })
        });
        const result = await response.json();
        if (result.success) {
          alert("Comment đã được gửi!");
          textArea.value = '';
          await loadComments(taskId);
        } else {
          alert("Lỗi: " + result.message);
        }
      } catch (err) {
        console.error("Error posting comment:", err);
      }
    }

    // 18. Hàm load báo cáo nhiệm vụ bằng Chart.js
    async function loadReport() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        // Tính số lượng nhiệm vụ theo trạng thái
        let statusCounts = { "Chưa thực hiện": 0, "Đang thực hiện": 0, "Hoàn thành": 0 };
        tasks.forEach(task => {
          if (statusCounts[task.status] !== undefined) {
            statusCounts[task.status]++;
          }
        });
        const ctx = document.getElementById('tasksChart').getContext('2d');
        if (window.tasksChartInstance) {
          window.tasksChartInstance.destroy();
        }
        window.tasksChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              label: 'Số lượng nhiệm vụ',
              data: Object.values(statusCounts),
              backgroundColor: ['#dc3545', '#ffc107', '#28a745']
            }]
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                precision: 0
              }
            }
          }
        });
      } catch (err) {
        console.error("Error loading report:", err);
      }
    }

    // 19. Hàm xử lý sự kiện tìm kiếm và sắp xếp
    function applyFilters() {
      loadTasks();
      loadReport();
    }
    document.getElementById('searchInput').addEventListener('keyup', applyFilters);
    document.getElementById('sortSelect').addEventListener('change', applyFilters);

    // 20. Khi trang tải, kiểm tra đăng nhập, load tasks, progress và báo cáo
    window.onload = async () => {
      document.getElementById('taskForm').addEventListener('submit', async function(e) {
  e.preventDefault(); // Ngăn chặn hành vi gửi form mặc định
  // Xử lý giao nhiệm vụ qua AJAX ở đây...
});

      await checkAuth();
      loadTasks();
      loadProgress();
      loadReport();
    };
  </script>
</body>
</html>
