<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý Nhiệm vụ</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    .preview-img {
      max-width: 200px;
      max-height: 200px;
      margin-top: 10px;
    }
    /* Dropzone style */
    #dropzone {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      margin-bottom: 15px;
      border-radius: 8px;
      color: #666;
      transition: background-color 0.3s;
    }
    #dropzone.dragover {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1>Quản lý Nhiệm vụ</h1>
    <hr>
    <!-- Form tạo nhiệm vụ (chỉ admin mới gọi được API /api/tasks) -->
    <form id="taskForm">
      <div class="form-group">
        <label for="taskTitle">Tên nhiệm vụ:</label>
        <input type="text" class="form-control" id="taskTitle" required>
      </div>

      <div class="form-group">
        <label for="taskAssigned">Giao cho:</label>
        <select class="form-control" id="taskAssigned" required>
          <option value="">Chọn người nhận</option>
          <!-- Danh sách người nhận, bạn có thể load động từ server nếu muốn -->
          <option value="Thiet">Thiet</option>
          <option value="Son">Son</option>
          <option value="Hai">Hai</option>
          <option value="Duc">Duc</option>
          <option value="Long">Long</option>
          <option value="SongJisub">SongJisub</option>
          <option value="Ha">Ha</option>
        </select>
      </div>

      <div class="form-group">
        <label for="taskPriority">Mức độ ưu tiên:</label>
        <select class="form-control" id="taskPriority" required>
          <option value="cao">Ưu tiên cao</option>
          <option value="trungbinh">Trung bình</option>
          <option value="thap">Không ưu tiên</option>
        </select>
      </div>

      <div class="form-group">
        <label for="taskDeadline">Thời hạn:</label>
        <input type="date" class="form-control" id="taskDeadline" required>
      </div>

      <div class="form-group">
        <label for="taskDescription">Mô tả:</label>
        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
      </div>

      <!-- Khu vực kéo thả ảnh -->
      <div id="dropzone">Kéo & thả ảnh vào đây (hoặc dán ảnh khi bấm Ctrl+V)</div>

      <div class="form-group">
        <label for="taskImage">Hoặc chọn file ảnh (tùy chọn):</label>
        <input type="file" class="form-control-file" id="taskImage" accept="image/*">
        <img id="imagePreview" class="preview-img" src="#" alt="Preview" style="display:none;">
      </div>

      <button type="submit" class="btn btn-primary">Giao nhiệm vụ</button>
    </form>
    <hr>
    <!-- Bảng liệt kê nhiệm vụ -->
    <h2>Danh sách nhiệm vụ</h2>
    <table class="table table-bordered" id="tasksTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Tên nhiệm vụ</th>
          <th>Người nhận</th>
          <th>Mức độ ưu tiên</th>
          <th>Thời hạn</th>
          <th>Mô tả</th>
          <th>Trạng thái</th>
          <th>Hình ảnh</th>
        </tr>
      </thead>
      <tbody>
        <!-- Nhiệm vụ sẽ được load từ API -->
      </tbody>
    </table>
  </div>

  <script>
    let selectedImageFile = null; // Lưu trữ file ảnh (từ drop/paste/input)

    // ========== 1. Hiển thị preview khi chọn file ========== 
    document.getElementById('taskImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        handleFile(file);
      }
    });

    // ========== 2. Drag & Drop ========== 
    const dropzone = document.getElementById('dropzone');
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('dragover');
    });
    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('dragover');
    });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        handleFile(file);
      }
    });

    // ========== 3. Paste ảnh ========== 
    document.addEventListener('paste', function(e) {
      const items = (e.clipboardData || e.originalEvent.clipboardData).items;
      for (let i = 0; i < items.length; i++) {
        const item = items[i];
        if (item.kind === 'file' && item.type.startsWith('image/')) {
          const file = item.getAsFile();
          handleFile(file);
        }
      }
    });

    // Hàm xử lý file (hiển thị preview & lưu vào selectedImageFile)
    function handleFile(file) {
      if (file && file.type.startsWith('image/')) {
        selectedImageFile = file;
        // Preview
        const reader = new FileReader();
        reader.onload = function(e) {
          const img = document.getElementById('imagePreview');
          img.src = e.target.result;
          img.style.display = 'block';
        }
        reader.readAsDataURL(file);
      } else {
        alert('File không phải hình ảnh!');
      }
    }

    // ========== 4. Upload ảnh lên Supabase ========== 
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });
      return await response.json(); // { success: boolean, imageUrl: string }
    }

    // ========== 5. Tải danh sách nhiệm vụ ========== 
    async function loadTasks() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        const tbody = document.querySelector('#tasksTable tbody');
        tbody.innerHTML = '';
        tasks.forEach(task => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.assignedTo}</td>
            <td>${task.priority}</td>
            <td>${task.deadline}</td>
            <td>${task.description || ''}</td>
            <td>${task.status}</td>
            <td>
              ${
                task.imageURL
                  ? `<a href="${task.imageURL}" target="_blank" download>
                       <img src="${task.imageURL}" style="max-width:100px;" alt="thumbnail">
                     </a>`
                  : 'N/A'
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error("Error loading tasks:", err);
      }
    }

    // ========== 6. Xử lý gửi form tạo nhiệm vụ ========== 
    document.getElementById('taskForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      // Tạo object nhiệm vụ
      const task = {
        title: document.getElementById('taskTitle').value,
        assignedTo: document.getElementById('taskAssigned').value,
        priority: document.getElementById('taskPriority').value,
        deadline: document.getElementById('taskDeadline').value,
        description: document.getElementById('taskDescription').value,
        status: 'Chưa thực hiện'
      };

      // Nếu có file ảnh => upload trước, lấy URL
      if (selectedImageFile) {
        const uploadResult = await uploadImage(selectedImageFile);
        if (uploadResult.success) {
          task.imageURL = uploadResult.imageUrl;
        } else {
          alert('Upload ảnh thất bại: ' + uploadResult.message);
          return;
        }
      }

      // Gửi dữ liệu nhiệm vụ đến API
      const response = await fetch('/api/tasks', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(task)
      });
      const result = await response.json();
      if (result.success) {
        alert('Nhiệm vụ được giao thành công!');
        loadTasks();
        // Reset form
        document.getElementById('taskForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        selectedImageFile = null; // Xoá file tạm
      } else {
        alert('Lỗi: ' + result.message);
      }
    });

    // ========== 7. Load nhiệm vụ khi trang được tải ========== 
    window.onload = loadTasks;
  </script>
</body>
</html>
